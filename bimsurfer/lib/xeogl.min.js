/*
 * xeogl V1.0.0
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeogl.org/
 *
 * Built on 2018-01-25
 *
 * MIT License
 * Copyright 2018, Lindsay Kay
 * http://xeolabs.com/
 *
 */

/*
 * Contains BIMsurfer specific modifications
 */

!function(){"use strict";var t,e=function(){this.version=null,this.WEBGL_INFO=function(){var t={WEBGL:!1},e=document.createElement("canvas");if(!e)return t;var i=e.getContext("webgl",{antialias:!0})||e.getContext("experimental-webgl",{antialias:!0});return t.WEBGL=!!i,t.WEBGL?(t.ANTIALIAS=i.getContextAttributes().antialias,i.getShaderPrecisionFormat?i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT).precision>0?t.FS_MAX_FLOAT_PRECISION="highp":i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.MEDIUM_FLOAT).precision>0?t.FS_MAX_FLOAT_PRECISION="mediump":t.FS_MAX_FLOAT_PRECISION="lowp":t.FS_MAX_FLOAT_PRECISION="mediump",t.DEPTH_BUFFER_BITS=i.getParameter(i.DEPTH_BITS),t.MAX_TEXTURE_SIZE=i.getParameter(i.MAX_TEXTURE_SIZE),t.MAX_CUBE_MAP_SIZE=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),t.MAX_RENDERBUFFER_SIZE=i.getParameter(i.MAX_RENDERBUFFER_SIZE),t.MAX_TEXTURE_UNITS=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),t.MAX_VERTEX_ATTRIBS=i.getParameter(i.MAX_VERTEX_ATTRIBS),t.MAX_VERTEX_UNIFORM_VECTORS=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),t.MAX_FRAGMENT_UNIFORM_VECTORS=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),t.MAX_VARYING_VECTORS=i.getParameter(i.MAX_VARYING_VECTORS),t.SUPPORTED_EXTENSIONS={},i.getSupportedExtensions().forEach(function(e){t.SUPPORTED_EXTENSIONS[e]=!0}),t):t}(),this.stats={build:{version:e.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,entities:0},memory:{meshes:0,positions:0,colors:0,normals:0,tangents:0,uvs:0,indices:0,textures:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._scenesRenderInfo={},this._superTypes={},this._taskQueue=[];var t=this;!function(){var e,i,r,s,n,a={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},o=10,h=0,l=[],u=0,c=function(){e=Date.now(),h>0&&(u+=i=1e3/(e-h),l.push(i),l.length>=30&&(u-=l.shift()),t.stats.frame.fps=Math.round(u/l.length)),function(){r=Date.now();var e=t._runScheduledTasks(r+o),i=t._taskQueue.length;for(s in t.stats.frame.tasksRun=e,t.stats.frame.tasksScheduled=i,t.stats.frame.tasksBudget=o,a.time=r,t.scenes)t.scenes.hasOwnProperty(s)&&(n=t.scenes[s],a.sceneId=s,a.startTime=n.startTime,a.deltaTime=null!=a.prevTime?a.time-a.prevTime:0,n.fire("tick",a,!0));a.prevTime=r}(),function(){var e,i,r,n=t.scenes,a=t._scenesRenderInfo;for(s in n)n.hasOwnProperty(s)&&(e=n[s],i=a[s],r=e.ticksPerRender,i.ticksPerRender!==r&&(i.ticksPerRender=r,i.renderCountdown=r),0==--i.renderCountdown&&(e.render(!1),i.renderCountdown=r))}(),h=e,window.requestAnimationFrame(c)};window.requestAnimationFrame(c)}()};e.prototype={constructor:e,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},_addScene:function(t){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,t.id){if(this.scenes[t.id])return void console.error("[ERROR] Scene "+e._inQuotes(t.id)+" already exists")}else t.id=this._sceneIDMap.addItem(t);this.scenes[t.id]=t;var i=t.ticksPerRender;this._scenesRenderInfo[t.id]={ticksPerRender:i,renderCountdown:i},this.stats.components.scenes++;var r=this;t.on("destroyed",function(){r._sceneIDMap.removeItem(t.id),delete r.scenes[t.id],delete r._scenesRenderInfo[t.id],r.stats.components.scenes--})},scheduleTask:function(t,e){this._taskQueue.push(t),this._taskQueue.push(e)},deferTask:function(t,e){e?t.call(e):t()},_runScheduledTasks:function(t){for(var e,i,r=(new Date).getTime(),s=this._taskQueue,n=0;s.length>0&&r<t;)e=s.shift(),(i=s.shift())?e.call(i):e(),r=(new Date).getTime(),n++;return n},clear:function(){var t;for(var e in this.scenes)this.scenes.hasOwnProperty(e)&&(t=this.scenes[e],"default.scene"===e?t.clear():t.destroy());this.scenes={}},_isArray:function(t){return t&&!t.propertyIsEnumerable("length")&&"object"==typeof t&&"number"==typeof t.length},_isString:function(t){return"string"==typeof t||t instanceof String},_isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},_isID:function(t){return e._isString(t)||e._isNumeric(t)},_isSameComponent:function(t,i){return!(!t||!i)&&(e.prototype._isNumeric(t)||e.prototype._isString(t)?""+t:t.id)===(e.prototype._isNumeric(i)||e.prototype._isString(i)?""+i:i.id)},_isFunction:function(t){return"function"==typeof t},_isObject:(t={}.constructor,function(e){return!!e&&e.constructor===t}),_isComponentType:function(t,e){if(t===(e=e||"xeogl.Component"))return!0;var i=this._superTypes[t];if(!i)return!1;for(var r=i.length-1;r>=0;r--)if(i[r]===e)return!0;return!1},_copy:function(t){return this._apply(t,{})},_apply:function(t,e){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},_apply2:function(t,e){for(var i in t)t.hasOwnProperty(i)&&void 0!==t[i]&&null!==t[i]&&(e[i]=t[i]);return e},_applyIf:function(t,e){for(var i in t)t.hasOwnProperty(i)&&(void 0!==e[i]&&null!==e[i]||(e[i]=t[i]));return e},_isEmptyObject:function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},_inQuotes:function(t){return this._isNumeric(t)?""+t:"'"+t+"'"}},window.xeogl=window.xeogl=new e}();var Canvas2Image=function(){var t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var i=!!t.getContext("2d").getImageData,r=!!t.toDataURL,s=!!window.btoa,n=function(t){var i="",r=t.width,s=t.height;i+="BM";var n=r*s*4+54;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);var a=r;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256);var o=s;i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),i+=e(1,0,32,0),i+=e(0,0,0,0);var h=r*s*4;i+=e(h%256),h=Math.floor(h/256),i+=e(h%256),h=Math.floor(h/256),i+=e(h%256),h=Math.floor(h/256),i+=e(h%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var l,u,c,d,_=t.data,f="",p=s;do{for(c=r*(p-1)*4,d="",l=0;l<r;l++)d+=e(_[c+(u=4*l)+2],_[c+u+1],_[c+u],_[c+u+3]);f+=d}while(--p);return function(t){var i,r,s="";if("string"==typeof t)s=t;else for(r=t,i=0;i<r.length;i++)s+=e(r[i]);return btoa(s)}(i+f)},a=function(t){window.open(t)||(document.location.href=t)},o=function(t,e){return"data:"+e+";base64,"+t},h=function(t){var e=document.createElement("img");return e.src=t,e},l=function(t,e,i){if(e&&i){var r=document.createElement("canvas");return r.width=e,r.height=i,r.style.width=e+"px",r.style.height=i+"px",r.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e,e),r}return t};return{saveAsPNG:function(t,e,i,s){if(!r)return!1;var n=l(t,i,s).toDataURL("image/png");return e?h(n):(a(n),!0)},saveAsJPEG:function(t,e,i,s){if(!r)return!1;var n=l(t,i,s).toDataURL("image/jpeg");return 5==n.indexOf("image/jpeg")&&(e?h(n):(a(n),!0))},saveAsBMP:function(t,e,u,c){if(!(r&&i&&s))return!1;var d=function(t){var e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(l(t,u,c)),_=n(d);return e?h(o(_,"image/bmp")):(a(o(_,"image/bmp")),!0)}}}();!function(){var t=!1,e=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){var r=this.prototype;t=!0;var s=new this;for(var n in t=!1,i)if("_props"!==n)s[n]="function"==typeof i[n]&&"function"==typeof r[n]&&e.test(i[n])?function(t,e){return function(){var i=this._super;this._super=r[t];var s=e.apply(this,arguments);return this._super=i,s}}(n,i[n]):i[n];else{var o,h=i[n];for(var l in h)(o=h[l]).set||function(){var t=l;o.set=function(){this.warn("Property '"+t+"' is read-only, ignoring assignment")}}(),o.enumerable=!0,Object.defineProperty(s,l,o)}function u(){!t&&this.__init&&this.__init.apply(this,arguments)}return s.superTypes=r.superTypes?r.superTypes.concat(r.type):[],i.type?xeogl._superTypes[i.type]=s.superTypes:i.type=r.type+"_"+a(),u.prototype=s,u.prototype.constructor=u,u.extend=arguments.callee,window[i.type]=u,u};var i,r,s,n,a=(r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),n=0,function(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?s[t]="-":14===t?s[t]="4":(n<=2&&(n=33554432+16777216*Math.random()|0),i=15&n,n>>=4,s[t]=r[19===t?3&i|8:i]);return s.join("")})}(),function(){"use strict";xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(t,e){this.items=t||[];var i=(e=e||0)+1;this.addItem=function(){var t;if(2===arguments.length){var e=arguments[0];if(t=arguments[1],this.items[e])throw"ID clash: '"+e+"'";return this.items[e]=t,e}for(;;){t=arguments[0]||{};var r=i++;if(!this.items[r])return this.items[r]=t,r}},this.removeItem=function(t){var e=this.items[t];return delete this.items[t],e}}}(),function(){"use strict";var t,e,i,r,s,n,a=new Float32Array(16),o=new Float32Array(16),h=new Float32Array(4),l=xeogl.math={DEGTORAD:.0174532925,vec2:function(t){return new Float32Array(t||2)},vec3:function(t){return new Float32Array(t||3)},vec4:function(t){return new Float32Array(t||4)},mat3:function(t){return new Float32Array(t||9)},mat3ToMat4:function(t,e){},mat4:function(t){return new Float32Array(t||16)},mat4ToMat3:function(t,e){},createUUID:(r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),n=0,function(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?s[t]="-":14===t?s[t]="4":(n<=2&&(n=33554432+16777216*Math.random()|0),i=15&n,n>>=4,s[t]=r[19===t?3&i|8:i]);return s.join("")}),clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},fmod:function(t,e){if(t<e)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),t;for(;e<=t;)t-=e;return t},negateVec4:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},addVec4:function(t,e,i){return i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i},addVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i},addVec3:function(t,e,i){return i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i},addVec3Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i},subVec4:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i},subVec3:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i},subVec2:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i},subVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i},subScalarVec4:function(t,e,i){return i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i},mulVec4:function(t,e,i){return i||(i=t),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i},mulVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i},mulVec3Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i},mulVec2Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i},divVec3:function(t,e,i){return i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i},divVec4:function(t,e,i){return i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i},divScalarVec3:function(t,e,i){return i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i},divVec3Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i},divVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i[3]=t[3]/e,i},divScalarVec4:function(t,e,i){return i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i[3]=t/e[3],i},dotVec4:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},cross3Vec4:function(t,e){var i=t[0],r=t[1],s=t[2],n=e[0],a=e[1],o=e[2];return[r*o-s*a,s*n-i*o,i*a-r*n,0]},cross3Vec3:function(t,e,i){i||(i=t);var r=t[0],s=t[1],n=t[2],a=e[0],o=e[1],h=e[2];return i[0]=s*h-n*o,i[1]=n*a-r*h,i[2]=r*o-s*a,i},sqLenVec4:function(t){return l.dotVec4(t,t)},lenVec4:function(t){return Math.sqrt(l.sqLenVec4(t))},dotVec3:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},dotVec2:function(t,e){return t[0]*e[0]+t[1]*e[1]},sqLenVec3:function(t){return l.dotVec3(t,t)},sqLenVec2:function(t){return l.dotVec2(t,t)},lenVec3:function(t){return Math.sqrt(l.sqLenVec3(t))},lenVec2:function(t){return Math.sqrt(l.sqLenVec2(t))},rcpVec3:function(t,e){return l.divScalarVec3(1,t,e)},normalizeVec4:function(t,e){var i=1/l.lenVec4(t);return l.mulVec4Scalar(t,i,e)},normalizeVec3:function(t,e){var i=1/l.lenVec3(t);return l.mulVec3Scalar(t,i,e)},normalizeVec2:function(t,e){var i=1/l.lenVec2(t);return l.mulVec2Scalar(t,i,e)},vec3FromMat4Scale:(e=new Float32Array(3),function(t,i){return e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=l.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=l.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=l.lenVec3(e),i}),dupMat4:function(t){return t.slice(0,16)},mat4To3:function(t){return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]]},m4s:function(t){return[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t]},setMat4ToZeroes:function(){return l.m4s(0)},setMat4ToOnes:function(){return l.m4s(1)},diagonalMat4v:function(t){return new Float32Array([t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,t[3]])},diagonalMat4c:function(t,e,i,r){return l.diagonalMat4v([t,e,i,r])},diagonalMat4s:function(t){return l.diagonalMat4c(t,t,t,t)},identityMat4:function(t){return(t=t||new Float32Array(16))[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},isIdentityMat4:function(t){return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]},negateMat4:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e},addMat4:function(t,e,i){return i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i},addMat4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i[4]=t[4]+e,i[5]=t[5]+e,i[6]=t[6]+e,i[7]=t[7]+e,i[8]=t[8]+e,i[9]=t[9]+e,i[10]=t[10]+e,i[11]=t[11]+e,i[12]=t[12]+e,i[13]=t[13]+e,i[14]=t[14]+e,i[15]=t[15]+e,i},addScalarMat4:function(t,e,i){return l.addMat4Scalar(e,t,i)},subMat4:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i[9]=t[9]-e[9],i[10]=t[10]-e[10],i[11]=t[11]-e[11],i[12]=t[12]-e[12],i[13]=t[13]-e[13],i[14]=t[14]-e[14],i[15]=t[15]-e[15],i},subMat4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i[4]=t[4]-e,i[5]=t[5]-e,i[6]=t[6]-e,i[7]=t[7]-e,i[8]=t[8]-e,i[9]=t[9]-e,i[10]=t[10]-e,i[11]=t[11]-e,i[12]=t[12]-e,i[13]=t[13]-e,i[14]=t[14]-e,i[15]=t[15]-e,i},subScalarMat4:function(t,e,i){return i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i[4]=t-e[4],i[5]=t-e[5],i[6]=t-e[6],i[7]=t-e[7],i[8]=t-e[8],i[9]=t-e[9],i[10]=t-e[10],i[11]=t-e[11],i[12]=t-e[12],i[13]=t-e[13],i[14]=t-e[14],i[15]=t-e[15],i},mulMat4:function(t,e,i){i||(i=t);var r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],d=t[9],_=t[10],f=t[11],p=t[12],g=t[13],m=t[14],y=t[15],v=e[0],x=e[1],b=e[2],w=e[3],M=e[4],E=e[5],D=e[6],S=e[7],C=e[8],k=e[9],T=e[10],B=e[11],A=e[12],F=e[13],P=e[14],L=e[15];return i[0]=v*r+x*o+b*c+w*p,i[1]=v*s+x*h+b*d+w*g,i[2]=v*n+x*l+b*_+w*m,i[3]=v*a+x*u+b*f+w*y,i[4]=M*r+E*o+D*c+S*p,i[5]=M*s+E*h+D*d+S*g,i[6]=M*n+E*l+D*_+S*m,i[7]=M*a+E*u+D*f+S*y,i[8]=C*r+k*o+T*c+B*p,i[9]=C*s+k*h+T*d+B*g,i[10]=C*n+k*l+T*_+B*m,i[11]=C*a+k*u+T*f+B*y,i[12]=A*r+F*o+P*c+L*p,i[13]=A*s+F*h+P*d+L*g,i[14]=A*n+F*l+P*_+L*m,i[15]=A*a+F*u+P*f+L*y,i},mulMat4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12]*e,i[13]=t[13]*e,i[14]=t[14]*e,i[15]=t[15]*e,i},mulMat4v4:function(t,e){var i=e[0],r=e[1],s=e[2],n=e[3];return[t[0]*i+t[4]*r+t[8]*s+t[12]*n,t[1]*i+t[5]*r+t[9]*s+t[13]*n,t[2]*i+t[6]*r+t[10]*s+t[14]*n,t[3]*i+t[7]*r+t[11]*s+t[15]*n]},transposeMat4:function(t,e){var i=t[4],r=t[14],s=t[8],n=t[13],a=t[12],o=t[9];if(!e||t===e){var h=t[1],l=t[2],u=t[3],c=t[6],d=t[7],_=t[11];return t[1]=i,t[2]=s,t[3]=a,t[4]=h,t[6]=o,t[7]=n,t[8]=l,t[9]=c,t[11]=r,t[12]=u,t[13]=d,t[14]=_,t}return e[0]=t[0],e[1]=i,e[2]=s,e[3]=a,e[4]=t[1],e[5]=t[5],e[6]=o,e[7]=n,e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=r,e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},determinantMat4:function(t){var e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],u=t[9],c=t[10],d=t[11],_=t[12],f=t[13],p=t[14],g=t[15];return _*u*o*s-l*f*o*s-_*a*c*s+n*f*c*s+l*a*p*s-n*u*p*s-_*u*r*h+l*f*r*h+_*i*c*h-e*f*c*h-l*i*p*h+e*u*p*h+_*a*r*d-n*f*r*d-_*i*o*d+e*f*o*d+n*i*p*d-e*a*p*d-l*a*r*g+n*u*r*g+l*i*o*g-e*u*o*g-n*i*c*g+e*a*c*g},inverseMat4:function(t,e){e||(e=t);var i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],u=t[8],c=t[9],d=t[10],_=t[11],f=t[12],p=t[13],g=t[14],m=t[15],y=i*o-r*a,v=i*h-s*a,x=i*l-n*a,b=r*h-s*o,w=r*l-n*o,M=s*l-n*h,E=u*p-c*f,D=u*g-d*f,S=u*m-_*f,C=c*g-d*p,k=c*m-_*p,T=d*m-_*g,B=1/(y*T-v*k+x*C+b*S-w*D+M*E);return e[0]=(o*T-h*k+l*C)*B,e[1]=(-r*T+s*k-n*C)*B,e[2]=(p*M-g*w+m*b)*B,e[3]=(-c*M+d*w-_*b)*B,e[4]=(-a*T+h*S-l*D)*B,e[5]=(i*T-s*S+n*D)*B,e[6]=(-f*M+g*x-m*v)*B,e[7]=(u*M-d*x+_*v)*B,e[8]=(a*k-o*S+l*E)*B,e[9]=(-i*k+r*S-n*E)*B,e[10]=(f*w-p*x+m*y)*B,e[11]=(-u*w+c*x-_*y)*B,e[12]=(-a*C+o*D-h*E)*B,e[13]=(i*C-r*D+s*E)*B,e[14]=(-f*b+p*v-g*y)*B,e[15]=(u*b-c*v+d*y)*B,e},traceMat4:function(t){return t[0]+t[5]+t[10]+t[15]},translationMat4v:function(t,e){var i=e||l.identityMat4();return i[12]=t[0],i[13]=t[1],i[14]=t[2],i},translationMat4c:(t=new Float32Array(3),function(e,i,r,s){return t[0]=e,t[1]=i,t[2]=r,l.translationMat4v(t,s)}),translationMat4s:function(t,e){return l.translationMat4c(t,t,t,e)},translateMat4v:function(t,e){return l.translateMat4c(t[0],t[1],t[2],e)},OLDtranslateMat4c:function(t,e,i,r){var s=r[12];r[0]+=s*t,r[4]+=s*e,r[8]+=s*i;var n=r[13];r[1]+=n*t,r[5]+=n*e,r[9]+=n*i;var a=r[14];r[2]+=a*t,r[6]+=a*e,r[10]+=a*i;var o=r[15];return r[3]+=o*t,r[7]+=o*e,r[11]+=o*i,r},translateMat4c:function(t,e,i,r){var s=r[3];r[0]+=s*t,r[1]+=s*e,r[2]+=s*i;var n=r[7];r[4]+=n*t,r[5]+=n*e,r[6]+=n*i;var a=r[11];r[8]+=a*t,r[9]+=a*e,r[10]+=a*i;var o=r[15];return r[12]+=o*t,r[13]+=o*e,r[14]+=o*i,r},rotationMat4v:function(t,e,i){var r,s,n,a,o,h,u=l.normalizeVec4([e[0],e[1],e[2],0],[]),c=Math.sin(t),d=Math.cos(t),_=1-d,f=u[0],p=u[1],g=u[2];return r=f*p,s=p*g,n=g*f,a=f*c,o=p*c,h=g*c,(i=i||l.mat4())[0]=_*f*f+d,i[1]=_*r+h,i[2]=_*n-o,i[3]=0,i[4]=_*r-h,i[5]=_*p*p+d,i[6]=_*s+a,i[7]=0,i[8]=_*n+o,i[9]=_*s-a,i[10]=_*g*g+d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:function(t,e,i,r,s){return l.rotationMat4v(t,[e,i,r],s)},scalingMat4v:function(t,e){return(e=e||l.identityMat4())[0]=t[0],e[5]=t[1],e[10]=t[2],e},scalingMat4c:function(){var t=new Float32Array(3);return function(e,i,r,s){return t[0]=e,t[1]=i,t[2]=r,l.scalingMat4v(t,s)}}(),scaleMat4c:function(t,e,i,r){return r[0]*=t,r[4]*=e,r[8]*=i,r[1]*=t,r[5]*=e,r[9]*=i,r[2]*=t,r[6]*=e,r[10]*=i,r[3]*=t,r[7]*=e,r[11]*=i,r},scaleMat4v:function(t,e){var i=t[0],r=t[1],s=t[2];return e[0]*=i,e[4]*=r,e[8]*=s,e[1]*=i,e[5]*=r,e[9]*=s,e[2]*=i,e[6]*=r,e[10]*=s,e[3]*=i,e[7]*=r,e[11]*=s,e},scalingMat4s:function(t){return l.scalingMat4c(t,t,t)},rotationTranslationMat4:function(t,e,i){i=i||l.mat4();var r=t[0],s=t[1],n=t[2],a=t[3],o=r+r,h=s+s,u=n+n,c=r*o,d=r*h,_=r*u,f=s*h,p=s*u,g=n*u,m=a*o,y=a*h,v=a*u;return i[0]=1-(f+g),i[1]=d+v,i[2]=_-y,i[3]=0,i[4]=d-v,i[5]=1-(c+g),i[6]=p+m,i[7]=0,i[8]=_+y,i[9]=p-m,i[10]=1-(c+f),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},mat4ToEuler:function(t,e,i){i=i||l.vec4();var r=l.clamp,s=t[0],n=t[4],a=t[8],o=t[1],h=t[5],u=t[9],c=t[2],d=t[6],_=t[10];return"XYZ"===e?(i[1]=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-u,_),i[2]=Math.atan2(-n,s)):(i[0]=Math.atan2(d,h),i[2]=0)):"YXZ"===e?(i[0]=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(i[1]=Math.atan2(a,_),i[2]=Math.atan2(o,h)):(i[1]=Math.atan2(-c,s),i[2]=0)):"ZXY"===e?(i[0]=Math.asin(r(d,-1,1)),Math.abs(d)<.99999?(i[1]=Math.atan2(-c,_),i[2]=Math.atan2(-n,h)):(i[1]=0,i[2]=Math.atan2(o,s))):"ZYX"===e?(i[1]=Math.asin(-r(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(d,_),i[2]=Math.atan2(o,s)):(i[0]=0,i[2]=Math.atan2(-n,h))):"YZX"===e?(i[2]=Math.asin(r(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-u,h),i[1]=Math.atan2(-c,s)):(i[0]=0,i[1]=Math.atan2(a,_))):"XZY"===e&&(i[2]=Math.asin(-r(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(d,h),i[1]=Math.atan2(a,s)):(i[0]=Math.atan2(-u,_),i[1]=0)),i},lookAtMat4v:function(t,e,i,r){r||(r=l.mat4());var s,n,a,o,h,u,c,d,_,f,p=t[0],g=t[1],m=t[2],y=i[0],v=i[1],x=i[2],b=e[0],w=e[1],M=e[2];return p===b&&g===w&&m===M?l.identityMat4():(s=p-b,n=g-w,a=m-M,o=v*(a*=f=1/Math.sqrt(s*s+n*n+a*a))-x*(n*=f),h=x*(s*=f)-y*a,u=y*n-v*s,(f=Math.sqrt(o*o+h*h+u*u))?(o*=f=1/f,h*=f,u*=f):(o=0,h=0,u=0),c=n*u-a*h,d=a*o-s*u,_=s*h-n*o,(f=Math.sqrt(c*c+d*d+_*_))?(c*=f=1/f,d*=f,_*=f):(c=0,d=0,_=0),r[0]=o,r[1]=c,r[2]=s,r[3]=0,r[4]=h,r[5]=d,r[6]=n,r[7]=0,r[8]=u,r[9]=_,r[10]=a,r[11]=0,r[12]=-(o*p+h*g+u*m),r[13]=-(c*p+d*g+_*m),r[14]=-(s*p+n*g+a*m),r[15]=1,r)},lookAtMat4c:function(t,e,i,r,s,n,a,o,h){return l.lookAtMat4v([t,e,i],[r,s,n],[a,o,h],[])},orthoMat4c:function(t,e,i,r,s,n,a){a||(a=l.mat4());var o=e-t,h=r-i,u=n-s;return a[0]=2/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/h,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(t+e)/o,a[13]=-(r+i)/h,a[14]=-(n+s)/u,a[15]=1,a},frustumMat4v:function(t,e,i){i||(i=l.mat4());var r=[t[0],t[1],t[2],0],s=[e[0],e[1],e[2],0];l.addVec4(s,r,a),l.subVec4(s,r,o);var n=2*r[2],h=o[0],u=o[1],c=o[2];return i[0]=n/h,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=n/u,i[6]=0,i[7]=0,i[8]=a[0]/h,i[9]=a[1]/u,i[10]=-a[2]/c,i[11]=-1,i[12]=0,i[13]=0,i[14]=-n*s[2]/c,i[15]=0,i},frustumMat4:function(t,e,i,r,s,n,a){a||(a=l.mat4());var o=e-t,h=r-i,u=n-s;return a[0]=2*s/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*s/h,a[6]=0,a[7]=0,a[8]=(e+t)/o,a[9]=(r+i)/h,a[10]=-(n+s)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-n*s*2/u,a[15]=0,a},perspectiveMat4:function(t,e,i,r,s){var n=[],a=[];return n[2]=i,a[2]=r,a[1]=n[2]*Math.tan(t/2),n[1]=-a[1],a[0]=a[1]*e,n[0]=-a[0],l.frustumMat4v(n,a,s)},transformPoint3:function(t,e,i){return(i=i||l.vec3())[0]=t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12],i[1]=t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13],i[2]=t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14],i},transformPoint4:function(t,e,i){return(i=i||l.vec4())[0]=t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],i[1]=t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],i[2]=t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],i[3]=t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3],i},transformPoints3:function(t,e,i){for(var r,s,n,a,o,h=i||[],l=e.length,u=t[0],c=t[1],d=t[2],_=t[3],f=t[4],p=t[5],g=t[6],m=t[7],y=t[8],v=t[9],x=t[10],b=t[11],w=t[12],M=t[13],E=t[14],D=t[15],S=0;S<l;++S)r=(a=e[S])[0],s=a[1],n=a[2],(o=h[S]||(h[S]=[0,0,0]))[0]=u*r+f*s+y*n+w,o[1]=c*r+p*s+v*n+M,o[2]=d*r+g*s+x*n+E,o[3]=_*r+m*s+b*n+D;return h.length=l,h},transformPositions3:function(t,e,i){var r;i=i||e;var s,n,a,o=e.length,h=t[0],l=t[1],u=t[2],c=t[3],d=t[4],_=t[5],f=t[6],p=t[7],g=t[8],m=t[9],y=t[10],v=t[11],x=t[12],b=t[13],w=t[14],M=t[15];for(r=0;r<o;r+=3)s=e[r+0],n=e[r+1],a=e[r+2],i[r+0]=h*s+d*n+g*a+x,i[r+1]=l*s+_*n+m*a+b,i[r+2]=u*s+f*n+y*a+w,i[r+3]=c*s+p*n+v*a+M;return i},transformVec3:function(t,e,i){var r=e[0],s=e[1],n=e[2];return(i=i||this.vec3())[0]=t[0]*r+t[4]*s+t[8]*n,i[1]=t[1]*r+t[5]*s+t[9]*n,i[2]=t[2]*r+t[6]*s+t[10]*n,i},transformVec4:function(t,e,i){var r=e[0],s=e[1],n=e[2],a=e[3];return(i=i||l.vec4())[0]=t[0]*r+t[4]*s+t[8]*n+t[12]*a,i[1]=t[1]*r+t[5]*s+t[9]*n+t[13]*a,i[2]=t[2]*r+t[6]*s+t[10]*n+t[14]*a,i[3]=t[3]*r+t[7]*s+t[11]*n+t[15]*a,i},rotateVec3X:function(t,e,i,r){var s=[],n=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],n[0]=s[0],n[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),n[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),r[0]=n[0]+e[0],r[1]=n[1]+e[1],r[2]=n[2]+e[2],r},rotateVec3Y:function(t,e,i,r){var s=[],n=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],n[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),n[1]=s[1],n[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),r[0]=n[0]+e[0],r[1]=n[1]+e[1],r[2]=n[2]+e[2],r},rotateVec3Z:function(t,e,i,r){var s=[],n=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],n[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),n[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),n[2]=s[2],r[0]=n[0]+e[0],r[1]=n[1]+e[1],r[2]=n[2]+e[2],r},projectVec4:function(t,e){var i=1/t[3];return(e=e||l.vec2())[0]=v[0]*i,e[1]=v[1]*i,e},lerpVec3:function(t,e,i,r,s,n){var a=n||l.vec3(),o=(t-e)/(i-e);return a[0]=r[0]+o*(s[0]-r[0]),a[1]=r[1]+o*(s[1]-r[1]),a[2]=r[2]+o*(s[2]-r[2]),a},flatten:function(t){var e,i,r,s,n,a=[];for(e=0,i=t.length;e<i;e++)for(r=0,s=(n=t[e]).length;r<s;r++)a.push(n[r]);return a},identityQuaternion:function(t){return(t=t||l.vec4())[0]=0,t[1]=0,t[2]=0,t[3]=1,t},eulerToQuaternion:function(t,e,i){i=i||l.vec4();var r=Math.cos(t[0]/2),s=Math.cos(t[1]/2),n=Math.cos(t[2]/2),a=Math.sin(t[0]/2),o=Math.sin(t[1]/2),h=Math.sin(t[2]/2);return"XYZ"===e?(i[0]=a*s*n+r*o*h,i[1]=r*o*n-a*s*h,i[2]=r*s*h+a*o*n,i[3]=r*s*n-a*o*h):"YXZ"===e?(i[0]=a*s*n+r*o*h,i[1]=r*o*n-a*s*h,i[2]=r*s*h-a*o*n,i[3]=r*s*n+a*o*h):"ZXY"===e?(i[0]=a*s*n-r*o*h,i[1]=r*o*n+a*s*h,i[2]=r*s*h+a*o*n,i[3]=r*s*n-a*o*h):"ZYX"===e?(i[0]=a*s*n-r*o*h,i[1]=r*o*n+a*s*h,i[2]=r*s*h-a*o*n,i[3]=r*s*n+a*o*h):"YZX"===e?(i[0]=a*s*n+r*o*h,i[1]=r*o*n+a*s*h,i[2]=r*s*h-a*o*n,i[3]=r*s*n-a*o*h):"XZY"===e&&(i[0]=a*s*n-r*o*h,i[1]=r*o*n-a*s*h,i[2]=r*s*h+a*o*n,i[3]=r*s*n+a*o*h),i},mat4ToQuaternion:function(t,e){e=e||l.vec4();var i,r=t[0],s=t[4],n=t[8],a=t[1],o=t[5],h=t[9],u=t[2],c=t[6],d=t[10],_=r+o+d;return _>0?(i=.5/Math.sqrt(_+1),e[3]=.25/i,e[0]=(c-h)*i,e[1]=(n-u)*i,e[2]=(a-s)*i):r>o&&r>d?(i=2*Math.sqrt(1+r-o-d),e[3]=(c-h)/i,e[0]=.25*i,e[1]=(s+a)/i,e[2]=(n+u)/i):o>d?(i=2*Math.sqrt(1+o-r-d),e[3]=(n-u)/i,e[0]=(s+a)/i,e[1]=.25*i,e[2]=(h+c)/i):(i=2*Math.sqrt(1+d-r-o),e[3]=(a-s)/i,e[0]=(n+u)/i,e[1]=(h+c)/i,e[2]=.25*i),e},vec3PairToQuaternion:function(t,e,i){i=i||l.vec4();var r=Math.sqrt(l.dotVec3(t,t)*l.dotVec3(e,e)),s=r+l.dotVec3(t,e);return s<1e-8*r?(s=0,Math.abs(t[0])>Math.abs(t[2])?(i[0]=-t[1],i[1]=t[0],i[2]=0):(i[0]=0,i[1]=-t[2],i[2]=t[1])):l.cross3Vec3(t,e,i),i[3]=s,l.normalizeQuaternion(i)},angleAxisToQuaternion:function(t,e){e=e||l.vec4();var i=t[3]/2,r=Math.sin(i);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(i),e},quaternionToEuler:function(t,e,i){i=i||l.vec4();var r=t[3]/2,s=Math.sin(r);return i[0]=s*t[0],i[1]=s*t[1],i[2]=s*t[2],i[3]=Math.cos(r),i},mulQuaternions:function(t,e,i){i=i||l.vec4();var r=t[0],s=t[1],n=t[2],a=t[3],o=e[0],h=e[1],u=e[2],c=e[3];return i[0]=a*o+r*c+s*u-n*h,i[1]=a*h+s*c+n*o-r*u,i[2]=a*u+n*c+r*h-s*o,i[3]=a*c-r*o-s*h-n*u,i},vec3ApplyQuaternion:function(t,e,i){i=i||l.vec3();var r=e[0],s=e[1],n=e[2],a=t[0],o=t[1],h=t[2],u=t[3],c=u*r+o*n-h*s,d=u*s+h*r-a*n,_=u*n+a*s-o*r,f=-a*r-o*s-h*n;return i[0]=c*u+f*-a+d*-h-_*-o,i[1]=d*u+f*-o+_*-a-c*-h,i[2]=_*u+f*-h+c*-o-d*-a,i},quaternionToMat4:function(t,e){e=l.identityMat4(e);var i=t[0],r=t[1],s=t[2],n=t[3],a=2*i,o=2*r,h=2*s,u=a*n,c=o*n,d=h*n,_=a*i,f=o*i,p=h*i,g=o*r,m=h*r,y=h*s;return e[0]=1-(g+y),e[1]=f+d,e[2]=p-c,e[4]=f-d,e[5]=1-(_+y),e[6]=m+u,e[8]=p+c,e[9]=m-u,e[10]=1-(_+g),e},quaternionToRotationMat4:function(t,e){var i=t[0],r=t[1],s=t[2],n=t[3],a=i+i,o=r+r,h=s+s,l=i*a,u=i*o,c=i*h,d=r*o,_=r*h,f=s*h,p=n*a,g=n*o,m=n*h;return e[0]=1-(d+f),e[4]=u-m,e[8]=c+g,e[1]=u+m,e[5]=1-(l+f),e[9]=_-p,e[2]=c-g,e[6]=_+p,e[10]=1-(l+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion:function(t,e){e=e||t;var i=l.lenVec4([t[0],t[1],t[2],t[3]]);return e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i,e},conjugateQuaternion:function(t,e){return(e=e||t)[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},inverseQuaternion:function(t,e){return l.normalizeQuaternion(l.conjugateQuaternion(t,e))},quaternionToAngleAxis:function(t,e){e=e||l.vec4();var i=(t=l.normalizeQuaternion(t,h))[3],r=2*Math.acos(i),s=Math.sqrt(1-i*i);return s<.001?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=t[0]/s,e[0]=t[1]/s,e[0]=t[2]/s),e[3]=r,e}}}(),function(){"use strict";var t,e,i,r=xeogl.math;r.AABB3=function(t){return new Float32Array(t||6)},r.AABB2=function(t){return new Float32Array(t||4)},r.OBB3=function(t){return new Float32Array(t||32)},r.OBB2=function(t){return new Float32Array(t||16)},r.transformOBB3=function(t,e,i){var r;i=i||e;var s,n,a,o=e.length,h=t[0],l=t[1],u=t[2],c=t[3],d=t[4],_=t[5],f=t[6],p=t[7],g=t[8],m=t[9],y=t[10],v=t[11],x=t[12],b=t[13],w=t[14],M=t[15];for(r=0;r<o;r+=4)s=e[r+0],n=e[r+1],a=e[r+2],i[r+0]=h*s+d*n+g*a+x,i[r+1]=l*s+_*n+m*a+b,i[r+2]=u*s+f*n+y*a+w,i[r+3]=c*s+p*n+v*a+M;return i},r.getAABB3Diag=(t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),function(s){return t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5],r.subVec3(e,t,i),Math.abs(r.lenVec3(i))}),r.getAABB3DiagPoint=function(){var t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3);return function(s,n){t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5];var a=r.subVec3(e,t,i),o=n[0]-s[0],h=s[3]-n[0],l=n[1]-s[1],u=s[4]-n[1],c=n[2]-s[2],d=s[5]-n[2];return a[0]+=o>h?o:h,a[1]+=l>u?l:u,a[2]+=c>d?c:d,Math.abs(r.lenVec3(a))}}(),r.getAABB3Center=function(t,e){var i=e||r.vec3();return i[0]=.5*(t[3]+t[0]),i[1]=.5*(t[4]+t[1]),i[2]=.5*(t[5]+t[2]),i},r.getAABB2Center=function(t,e){var i=e||r.vec2();return i[0]=(t[2]+t[0])/2,i[1]=(t[3]+t[1])/2,i},r.collapseAABB3=function(t){return(t=t||r.AABB3())[0]=1e7,t[1]=1e7,t[2]=1e7,t[3]=-1e7,t[4]=-1e7,t[5]=-1e7,t},r.AABB3ToOBB3=function(t,e){return(e=e||r.OBB3())[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,e[4]=t[3],e[5]=t[1],e[6]=t[2],e[7]=1,e[8]=t[3],e[9]=t[4],e[10]=t[2],e[11]=1,e[12]=t[0],e[13]=t[4],e[14]=t[2],e[15]=1,e[16]=t[0],e[17]=t[1],e[18]=t[5],e[19]=1,e[20]=t[3],e[21]=t[1],e[22]=t[5],e[23]=1,e[24]=t[3],e[25]=t[4],e[26]=t[5],e[27]=1,e[28]=t[0],e[29]=t[4],e[30]=t[5],e[31]=1,e},r.positions3ToAABB3=function(t,e){e=e||r.AABB3();for(var i,s,n,a=1e5,o=1e5,h=1e5,l=-1e5,u=-1e5,c=-1e5,d=0,_=t.length;d<_;d+=3)i=t[d+0],s=t[d+1],n=t[d+2],i<a&&(a=i),s<o&&(o=s),n<h&&(h=n),i>l&&(l=i),s>u&&(u=s),n>c&&(c=n);return e[0]=a,e[1]=o,e[2]=h,e[3]=l,e[4]=u,e[5]=c,e},r.OBB3ToAABB3=function(t,e){e=e||r.AABB3();for(var i,s,n,a=1e5,o=1e5,h=1e5,l=-1e5,u=-1e5,c=-1e5,d=0,_=t.length;d<_;d+=4)i=t[d+0],s=t[d+1],n=t[d+2],i<a&&(a=i),s<o&&(o=s),n<h&&(h=n),i>l&&(l=i),s>u&&(u=s),n>c&&(c=n);return e[0]=a,e[1]=o,e[2]=h,e[3]=l,e[4]=u,e[5]=c,e},r.points3ToAABB3=function(t,e){e=e||r.AABB3();for(var i,s,n,a=1e5,o=1e5,h=1e5,l=-1e5,u=-1e5,c=-1e5,d=0,_=t.length;d<_;d++)i=t[d][0],s=t[d][1],n=t[d][2],i<a&&(a=i),s<o&&(o=s),n<h&&(h=n),i>l&&(l=i),s>u&&(u=s),n>c&&(c=n);return e[0]=a,e[1]=o,e[2]=h,e[3]=l,e[4]=u,e[5]=c,e},r.points3ToSphere3=function(){var t=new Float32Array(3);return function(e,i){i=i||r.vec4();var s,n=0,a=0,o=0,h=e.length;for(s=0;s<h;s++)n+=e[s][0],a+=e[s][1],o+=e[s][2];i[0]=n/h,i[1]=a/h,i[2]=o/h;var l,u=0;for(s=0;s<h;s++)(l=Math.abs(r.lenVec3(r.subVec3(e[s],i,t))))>u&&(u=l);return i[3]=u,i}}(),r.OBB3ToSphere3=function(){var t=new Float32Array(3),e=new Float32Array(3);return function(i,s){s=s||r.vec4();var n,a=0,o=0,h=0,l=i.length,u=l/4;for(n=0;n<l;n+=4)a+=i[n+0],o+=i[n+1],h+=i[n+2];s[0]=a/u,s[1]=o/u,s[2]=h/u;var c,d=0;for(n=0;n<l;n+=4)t[0]=i[n+0],t[1]=i[n+1],t[2]=i[n+2],(c=Math.abs(r.lenVec3(r.subVec3(t,s,e))))>d&&(d=c);return s[3]=d,s}}(),r.getSphere3Center=function(t,e){return(e=e||r.vec3())[0]=t[0],e[1]=t[1],e[2]=t[2],e},r.expandAABB3=function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t[4]<e[4]&&(t[4]=e[4]),t[5]<e[5]&&(t[5]=e[5]),t},r.expandAABB3Point3=function(t,e){return t[0]<e[0]&&(t[0]=e[0]),t[1]<e[1]&&(t[1]=e[1]),t[2]<e[2]&&(t[2]=e[2]),t[3]>e[0]&&(t[3]=e[0]),t[4]>e[1]&&(t[4]=e[1]),t[5]>e[2]&&(t[5]=e[2]),t},r.collapseAABB2=function(t){return(t=t||r.AABB2())[0]=1e7,t[1]=1e7,t[2]=-1e7,t[3]=-1e7,t},r.OBB3ToAABB2=function(t,e){e=e||r.AABB2();for(var i,s,n,a=1e7,o=1e7,h=-1e7,l=-1e7,u=0,c=t.length;u<c;u+=4)i=t[u+0],s=t[u+1],s*=n=1/(t[u+3]||1),(i*=n)<a&&(a=i),s<o&&(o=s),i>h&&(h=i),s>l&&(l=s);return e[0]=a,e[1]=o,e[2]=h,e[3]=l,e},r.expandAABB2=function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t},r.expandAABB2Point2=function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1]),t},r.AABB2ToCanvas=function(t,e,i,r){r=r||t;var s=.5*(t[0]+1),n=.5*(t[1]+1),a=.5*(t[2]+1),o=.5*(t[3]+1);return r[0]=Math.floor(s*e),r[1]=i-Math.floor(o*i),r[2]=Math.floor(a*e),r[3]=i-Math.floor(n*i),r}}(),function(){"use strict";var t,e,i,r,s,n=xeogl.math;n.triangleNormal=function(t,e,i,r){r=r||n.vec3();var s=e[0]-t[0],a=e[1]-t[1],o=e[2]-t[2],h=i[0]-t[0],l=i[1]-t[1],u=i[2]-t[2],c=a*u-o*l,d=o*h-s*u,_=s*l-a*h,f=Math.sqrt(c*c+d*d+_*_);return 0===f?(r[0]=0,r[1]=0,r[2]=0):(r[0]=c/f,r[1]=d/f,r[2]=_/f),r},n.rayTriangleIntersect=(t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),r=new Float32Array(3),s=new Float32Array(3),function(a,o,h,l,u,c){c=c||n.vec3();var d=n.subVec3(l,h,t),_=n.subVec3(u,h,e),f=n.cross3Vec3(o,_,i),p=n.dotVec3(d,f);if(p<1e-6)return null;var g=n.subVec3(a,h,r),m=n.dotVec3(g,f);if(m<0||m>p)return null;var y=n.cross3Vec3(g,d,s),v=n.dotVec3(o,y);if(v<0||m+v>p)return null;var x=n.dotVec3(_,y)/p;return c[0]=a[0]+x*o[0],c[1]=a[1]+x*o[1],c[2]=a[2]+x*o[2],c}),n.rayPlaneIntersect=function(){var t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),r=new Float32Array(3);return function(s,a,o,h,l,u){u=u||n.vec3(),a=n.normalizeVec3(a,t);var c=n.subVec3(h,o,e),d=n.subVec3(l,o,i),_=n.cross3Vec3(c,d,r);n.normalizeVec3(_,_);var f=-n.dotVec3(o,_),p=-(n.dotVec3(s,_)+f)/n.dotVec3(a,_);return u[0]=s[0]+p*a[0],u[1]=s[1]+p*a[1],u[2]=s[2]+p*a[2],u}}(),n.cartesianToBarycentric=function(){var t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3);return function(r,s,a,o,h){var l=n.subVec3(o,s,t),u=n.subVec3(a,s,e),c=n.subVec3(r,s,i),d=n.dotVec3(l,l),_=n.dotVec3(l,u),f=n.dotVec3(l,c),p=n.dotVec3(u,u),g=n.dotVec3(u,c),m=d*p-_*_;if(0===m)return null;var y=1/m,v=(p*f-_*g)*y,x=(d*g-_*f)*y;return h[0]=1-v-x,h[1]=x,h[2]=v,h}}(),n.barycentricInsideTriangle=function(t){var e=t[1],i=t[2];return i>=0&&e>=0&&i+e<1},n.barycentricToCartesian=function(t,e,i,r,s){s=s||n.vec3();var a=t[0],o=t[1],h=t[2];return s[0]=e[0]*a+i[0]*o+r[0]*h,s[1]=e[1]*a+i[1]*o+r[1]*h,s[2]=e[2]*a+i[2]*o+r[2]*h,s}}(),function(){"use strict";var t,e,i,r,s,n,a,o,h,l,u,c,d,_,f=xeogl.math;f.buildNormals=(t=f.vec3(),e=f.vec3(),i=f.vec3(),r=f.vec3(),s=f.vec3(),n=f.vec3(),a=f.vec3(),function(o,h){var l,u,c,d,_,p=new Array(o.length/3);for(l=0,u=h.length;l<u;l+=3)c=h[l],d=h[l+1],_=h[l+2],t[0]=o[3*c],t[1]=o[3*c+1],t[2]=o[3*c+2],e[0]=o[3*d],e[1]=o[3*d+1],e[2]=o[3*d+2],i[0]=o[3*_],i[1]=o[3*_+1],i[2]=o[3*_+2],f.subVec3(e,t,r),f.subVec3(i,t,s),f.normalizeVec3(f.cross3Vec3(r,s,n),a),p[c]||(p[c]=[]),p[d]||(p[d]=[]),p[_]||(p[_]=[]),p[c].push(a),p[d].push(a),p[_].push(a);var g=new Float32Array(o.length);for(l=0,u=p.length;l<u;l++){for(var m=p[l].length,y=0,v=0,x=0,b=0;b<m;b++)y+=p[l][b][0],v+=p[l][b][1],x+=p[l][b][2];g[3*l]=y/m,g[3*l+1]=v/m,g[3*l+2]=x/m}return g}),f.buildTangents=(o=new Float32Array(3),h=new Float32Array(3),l=new Float32Array(3),u=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),_=new Float32Array(3),function(t,e,i){for(var r=new Float32Array(t.length),s=0;s<e.length;s+=3){var n=e[s],a=t.subarray(3*n,3*n+3),p=i.subarray(2*n,2*n+2);n=e[s+1];var g=t.subarray(3*n,3*n+3),m=i.subarray(2*n,2*n+2);n=e[s+2];for(var y,v=t.subarray(3*n,3*n+3),x=i.subarray(2*n,2*n+2),b=f.subVec3(g,a,o),w=f.subVec3(v,a,h),M=f.subVec2(m,p,l),E=f.subVec2(x,p,u),D=1/(M[0]*E[1]-M[1]*E[0]),S=f.mulVec3Scalar(f.subVec3(f.mulVec3Scalar(b,E[1],c),f.mulVec3Scalar(w,M[1],d),_),D,d),C=0;C<3;C++)r[y=3*e[s+C]]+=S[0],r[y+1]+=S[1],r[y+2]+=S[2]}return r}),f.buildPickTriangles=function(t,e){for(var i,r,s,n,a,o,h,l=e.length,u=new Float32Array(30*l),c=new Float32Array(40*l),d=0,_=0;_<l;_+=3)r=3*_,s=4*_,h=(d>>24&255)/255,o=(d>>16&255)/255,a=(d>>8&255)/255,n=(255&d)/255,i=3*e[_],u[r]=t[i],u[r+1]=t[i+1],u[r+2]=t[i+2],c[s]=n,c[s+1]=a,c[s+2]=o,c[s+3]=h,i=3*e[_+1],u[r+3]=t[i],u[r+4]=t[i+1],u[r+5]=t[i+2],c[s+4]=n,c[s+5]=a,c[s+6]=o,c[s+7]=h,i=3*e[_+2],u[r+6]=t[i],u[r+7]=t[i+1],u[r+8]=t[i+2],c[s+8]=n,c[s+9]=a,c[s+10]=o,c[s+11]=h,d++;return{positions:u,colors:c}}}(),function(){"use strict";var t=xeogl.math;t.tangentQuadraticBezier=function(t,e,i,r){return 2*(1-t)*(i-e)+2*t*(r-i)},t.tangentQuadraticBezier=function(t,e,i,r,s){return-3*e*(1-t)*(1-t)+3*i*(1-t)*(1-t)-6*t*i*(1-t)+6*t*r*(1-t)-3*t*t*r+3*t*t*s},t.tangentSpline=function(t){return 6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t)},t.catmullRomInterpolate=function(t,e,i,r,s){var n=.5*(i-t),a=.5*(r-e),o=s*s;return(2*e-2*i+n+a)*(s*o)+(-3*e+3*i-2*n-a)*o+n*s+e},t.b2p0=function(t,e){var i=1-t;return i*i*e},t.b2p1=function(t,e){return 2*(1-t)*t*e},t.b2p2=function(t,e){return t*t*e},t.b2=function(t,e,i,r){return this.b2p0(t,e)+this.b2p1(t,i)+this.b2p2(t,r)},t.b3p0=function(t,e){var i=1-t;return i*i*i*e},t.b3p1=function(t,e){var i=1-t;return 3*i*i*t*e},t.b3p2=function(t,e){return 3*(1-t)*t*t*e},t.b3p3=function(t,e){return t*t*t*e},t.b3=function(t,e,i,r,s){return this.b3p0(t,e)+this.b3p1(t,i)+this.b3p2(t,r)+this.b3p3(t,s)}}(),function(){"use strict";var t,e,i,r,s;xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(t,e,i,r){r=r||{},this.stats=t||{},this.gl=i,this.canvas=e,this._programFactory=new xeogl.renderer.ProgramFactory(this.stats,i),this._objectFactory=new xeogl.renderer.ObjectFactory,this._chunkFactory=new xeogl.renderer.ChunkFactory,this.transparent=!0===r.transparent,this.bindOutputFramebuffer=null,this.unbindOutputFramebuffer=null,this.objects={},this._ambient=null,this.ambientColor=xeogl.math.vec4([0,0,0,1]),this._objectList=[],this._objectListLen=0,this._objectPickList=[],this._objectPickListLen=0,this._frameCtx={canvas:this.canvas,renderTarget:null,renderBuf:null,depthbufEnabled:null,clearDepth:null,depthFunc:null,blendEnabled:!1,backfaces:!0,frontface:!0,textureUnit:0,transparent:!1,ambientColor:null,drawElements:0,useProgram:0,bindTexture:0,bindArray:null,pass:null,bindOutputFramebuffer:null,pickIndex:0},this.visibility=null,this.cull=null,this.modes=null,this.layer=null,this.stage=null,this.depthBuf=null,this.colorBuf=null,this.lights=null,this.material=null,this.reflect=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.billboard=null,this.stationary=null,this.colorTarget=null,this.depthTarget=null,this.clips=null,this.shader=null,this.shaderParams=null,this.geometry=null,this.viewport=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.imageDirty=!0},xeogl.renderer.Renderer.prototype.webglRestored=function(t){this.gl=t,this._programFactory.webglRestored(t),this._chunkFactory.webglRestored(),this.pickBuf&&this.pickBuf.webglRestored(t),this.imageDirty=!0},xeogl.renderer.Renderer.prototype.buildObject=function(t){var e=this.objects[t];e||((e=this._objectFactory.get(t)).hash=""),e.stage=this.stage,e.layer=this.layer,e.colorTarget=this.colorTarget,e.depthTarget=this.depthTarget,e.material=this.material,e.reflect=this.reflect,e.geometry=this.geometry,e.visibility=this.visibility,e.cull=this.cull,e.modes=this.modes,e.billboard=this.billboard,e.stationary=this.stationary,e.viewport=this.viewport;var i=[this.geometry.hash,this.shader.hash,this.clips.hash,this.material.hash,this.lights.hash,this.billboard.hash,this.stationary.hash].join(";");if(i!==e.hash){e.program&&this._programFactory.put(e.program),e.program=this._programFactory.get(i,this),e.hash=i,!0;var r=e.program;if(r){var s=r.program;if(!(s.allocated&&s.compiled&&s.validated&&s.linked))return this.objects[t]&&this.removeObject(t),{error:!0,errorLog:s.errorLog}}}return this._setChunk(e,0,"program",e.program),this._setChunk(e,1,"modelTransform",this.modelTransform),this._setChunk(e,2,"viewTransform",this.viewTransform),this._setChunk(e,3,"projTransform",this.projTransform),this._setChunk(e,4,"modes",this.modes),this._setChunk(e,5,"shader",this.shader),this._setChunk(e,6,"shaderParams",this.shaderParams),this._setChunk(e,7,"depthBuf",this.depthBuf),this._setChunk(e,8,"colorBuf",this.colorBuf),this._setChunk(e,9,"lights",this.lights),this._setChunk(e,10,this.material.type,this.material),this._setChunk(e,11,"clips",this.clips),this._setChunk(e,12,"viewport",this.viewport),this._setChunk(e,13,"geometry",this.geometry),this._setChunk(e,14,"draw",this.geometry,!0),this._setAmbient(this.lights),this.objects[t]?this.stateOrderDirty=!0:(this.objects[t]=e,this.objectListDirty=!0),e.compiled=!0,e},xeogl.renderer.Renderer.prototype._setChunk=function(t,e,i,r,s){var n,a=this._chunkFactory.types[i];n="program"===i?1e8*(t.program.id+1):a.constructor.prototype.programGlobal?r.id:1e8*(t.program.id+1)+(r.id+1),s&&(n*=1e5);var o=t.chunks[e];o&&this._chunkFactory.putChunk(o),t.chunks[e]=this._chunkFactory.getChunk(n,i,t.program.program,r)},xeogl.renderer.Renderer.prototype._setAmbient=function(t){for(var e,i=t.lights,r=0,s=i.length;r<s;r++)"ambient"===(e=i[r]).type&&(this._ambient=e)},xeogl.renderer.Renderer.prototype.removeObject=function(t){var e=this.objects[t];if(e){for(var i=e.chunks,r=0,s=i.length;r<s;r++)this._chunkFactory.putChunk(i[r]);this._programFactory.put(e.program),e.program=null,e.hash=null,this._objectFactory.put(e),delete this.objects[t],this.objectListDirty=!0}},xeogl.renderer.Renderer.prototype.render=function(t){t=t||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.imageDirty=!0),(this.imageDirty||t.force)&&(this._renderObjectList({clear:!1!==t.clear,opaqueOnly:t.opaqueOnly,pass:t.pass}),this.stats.frame.frameCount++,this.imageDirty=!1)},xeogl.renderer.Renderer.prototype._buildObjectList=function(){for(var t in this._objectListLen=0,this.objects)this.objects.hasOwnProperty(t)&&(this._objectList[this._objectListLen++]=this.objects[t])},xeogl.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var t,e=0,i=this._objectListLen;e<i;e++)(t=this._objectList[e]).program?t.sortKey=1e16*(t.stage.priority+1)+1e14*(t.modes.transparent?2:1)+1e13*(t.layer.priority+1)+1e8*(t.program.id+1)+1e4*(t.material.id+1)+t.geometry.id:t.sortKey=-1},xeogl.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(t,e){return t.sortKey-e.sortKey})},xeogl.renderer.Renderer.prototype._renderObjectList=function(t){var e=this.gl;xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&e.getExtension("OES_element_index_uint");var i=this._ambient;if(i){var r=i.color,s=i.intensity;this.ambientColor[0]=r[0]*s,this.ambientColor[1]=r[1]*s,this.ambientColor[2]=r[2]*s}else this.ambientColor[0]=0,this.ambientColor[1]=0,this.ambientColor[2]=0;var n,a,o,h,l,u,c=this._frameCtx;c.renderTarget=null,c.renderBuf=null,c.depthbufEnabled=null,c.clearDepth=null,c.depthFunc=e.LESS,c.blendEnabled=!1,c.backfaces=!0,c.frontface=!0,c.textureUnit=0,c.transparent=!1,c.ambientColor=this.ambientColor,c.drawElements=0,c.useProgram=0,c.bindTexture=0,c.bindArray=0,c.pass=t.pass,c.bindOutputFramebuffer=this.bindOutputFramebuffer,c.pickViewMatrix=t.pickViewMatrix,c.pickProjMatrix=t.pickProjMatrix,c.pickIndex=0,xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&e.getExtension("OES_element_index_uint"),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),this.transparent||t.pickObject||t.pickSurface?e.clearColor(0,0,0,0):e.clearColor(this.ambientColor[0],this.ambientColor[1],this.ambientColor[2],1),e.enable(e.DEPTH_TEST),e.frontFace(e.CCW),e.disable(e.CULL_FACE),e.disable(e.BLEND);var d,_=this._lastChunkId=this._lastChunkId||new Int32Array(30);for(n=0;n<20;n++)_[n]=-9999999999999;if(t.pickObject){for(e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._objectPickListLen=0,n=0,a=this._objectListLen;n<a;n++)if((d=this._objectList[n]).compiled&&!0!==d.cull.culled&&!1!==d.visibility.visible&&!1!==d.modes.pickable)for(this._objectPickList[this._objectPickListLen++]=d,o=0,h=(l=d.chunks).length;o<h;o++)(u=l[o])&&u.pickObject&&(u.unique||_[o]!==u.id)&&(u.pickObject(c),_[o]=u.id)}else if(t.pickSurface){if(e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),t.object)for(n=0,a=(l=t.object.chunks).length;n<a;n++)(u=l[n]).pickPrimitive&&u.pickPrimitive(c)}else{var f=(new Date).getTime();for(this.bindOutputFramebuffer&&this.bindOutputFramebuffer(t.pass),t.clear&&e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),n=0,a=this._objectListLen;n<a;n++)if((d=this._objectList[n]).compiled&&!0!==d.cull.culled&&!1!==d.visibility.visible)for(o=0,h=(l=d.chunks).length;o<h;o++)(u=l[o])&&u.draw&&(u.unique||_[o]!==u.id)&&(u.draw(c),_[o]=u.id);var p=Date.now(),g=this.stats.frame;g.renderTime=(p-f)/1e3,g.drawElements=c.drawElements,g.useProgram=c.useProgram,g.bindTexture=c.bindTexture,g.bindArray=c.bindArray,c.renderBuf&&c.renderBuf.unbind();for(var m=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),y=0;y<m;++y)e.activeTexture(e.TEXTURE0+y),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);this.unbindOutputFramebuffer&&this.unbindOutputFramebuffer(t.pass)}},xeogl.renderer.Renderer.prototype.pick=(t=xeogl.math,e=t.vec3(),i=t.mat4(),r=t.vec3([0,1,0]),s=t.frustumMat4(-1,1,-1,1,.1,1e4),function(n){var a,o,h,l,u,c=null,d=this.pickBuf;d||(d=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl),this.pickBuf=d),this.render(),d.bind(),d.clear();var _=null,f=null;n.canvasPos?n.canvasPos?(a=n.canvasPos[0],o=n.canvasPos[1]):(a=.5*this.canvas.clientWidth,o=.5*this.canvas.clientHeight):(h=n.origin||t.vec3([0,0,0]),l=n.direction||t.vec3([0,0,1]),u=t.addVec3(h,l,e),_=t.lookAtMat4v(h,u,r,i),f=s,a=.5*this.canvas.clientWidth,o=.5*this.canvas.clientHeight),this._renderObjectList({pickObject:!0,clear:!0,pickViewMatrix:_,pickProjMatrix:f});var p=d.read(a,o),g=p[0]+256*p[1]+65536*p[2];g=g>=1?g-1:-1;var m=this._objectPickList[g];if(m&&(c={entity:m.id},n.pickSurface)){d.clear(),this._renderObjectList({pickSurface:!0,object:m,pickViewMatrix:_,pickProjMatrix:f,clear:!0}),this.gl.finish();var y=(p=d.read(a,o))[0]+256*p[1]+256*p[2]*256+256*p[3]*256*256;y*=3,c.primIndex=y,_&&(c.origin=h,c.direction=l)}return d.unbind(),c}),xeogl.renderer.Renderer.prototype.readPixels=function(t,e,i,r){var s,n,a,o;for(this._readPixelBuf||(this._readPixelBuf=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear(),this.render({force:!0,opaqueOnly:r}),n=0;n<i;n++)a=2*n,o=4*n,s=this._readPixelBuf.read(t[a],t[a+1]),e[o]=s[0],e[o+1]=s[1],e[o+2]=s[2],e[o+3]=s[3];this._readPixelBuf.unbind()},xeogl.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";xeogl.renderer.webgl.ArrayBuffer=function(t,e,i,r,s,n){this.allocated=!1,this.gl=t,this.type=e,this.itemType=i.constructor==Uint8Array?t.UNSIGNED_BYTE:i.constructor==Uint16Array?t.UNSIGNED_SHORT:i.constructor==Uint32Array?t.UNSIGNED_INT:t.FLOAT,this.usage=n,this.length=0,this.numItems=0,this.itemSize=s,this._allocate(i)},xeogl.renderer.webgl.ArrayBuffer.prototype._allocate=function(t){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,t,this.usage),this.gl.bindBuffer(this.type,null),this.length=t.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.webgl.ArrayBuffer.prototype.setData=function(t,e){this.allocated&&(t.length>this.length?(this.destroy(),this._allocate(t,t.length)):e||0===e?this.gl.bufferSubData(this.type,e,t):this.gl.bufferData(this.type,t))},xeogl.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},xeogl.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},xeogl.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Attribute=function(t,e){this.gl=t,this.location=e},xeogl.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(t){t&&(t.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,t.itemSize,this.gl.FLOAT,!1,0,0))},xeogl.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(t,e,i){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,t,this.gl.FLOAT,!1,e,i)}}(),function(){"use strict";function t(t){for(var e,i,r=[],s=0,n=t.length;s<n;s++)(i=(e=t[s]).indexOf("/"))>0&&"/"===e.charAt(i+1)&&(e=e.substring(0,i)),r.push(e);return r.join("\n")}xeogl.renderer.webgl.Program=function(e,i,r,s){var n,a,o,h,l;if(this.stats=e,this.gl=i,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.webgl.Shader(i,i.VERTEX_SHADER,t(r)),this._fragmentShader=new xeogl.renderer.webgl.Shader(i,i.FRAGMENT_SHADER,t(s)),this._vertexShader.allocated)if(this._fragmentShader.allocated)if(this.allocated=!0,this._vertexShader.compiled)if(this._fragmentShader.compiled)if(this.compiled=!0,this.handle=i.createProgram(),this.handle){if(i.attachShader(this.handle,this._vertexShader.handle),i.attachShader(this.handle,this._fragmentShader.handle),i.linkProgram(this.handle),this.linked=i.getProgramParameter(this.handle,i.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errorLog=[],this.errorLog.push(""),this.errorLog.push(i.getProgramInfoLog(this.handle)),this.errorLog.push("\nVertex shader:\n"),this.errorLog=this.errorLog.concat(r),this.errorLog.push("\nFragment shader:\n"),void(this.errorLog=this.errorLog.concat(s));var u=i.getProgramParameter(this.handle,i.ACTIVE_UNIFORMS);for(a=0;a<u;++a)(o=i.getActiveUniform(this.handle,a))&&("\0"===(h=o.name)[h.length-1]&&(h=h.substr(0,h.length-1)),l=i.getUniformLocation(this.handle,h),o.type===i.SAMPLER_2D||o.type===i.SAMPLER_CUBE||35682===o.type?this.samplers[h]=new xeogl.renderer.webgl.Sampler(i,l):this.uniforms[h]=new xeogl.renderer.webgl.Uniform(e.frame,i,o.type,l));var c=i.getProgramParameter(this.handle,i.ACTIVE_ATTRIBUTES);for(a=0;a<c;a++)(n=i.getActiveAttrib(this.handle,a))&&(l=i.getAttribLocation(this.handle,n.name),this.attributes[n.name]=new xeogl.renderer.webgl.Attribute(i,l));this.allocated=!0}else this.errorLog=["Failed to allocate program"];else this.errorLog=["Fragment shader failed to compile"].concat(this._fragmentShader.errorLog);else this.errorLog=["Vertex shader failed to compile"].concat(this._vertexShader.errorLog);else this.errorLog=["Fragment shader failed to allocate"].concat(this._fragmentShader.errorLog);else this.errorLog=["Vertex shader failed to allocate"].concat(this._vertexShader.errorLog)},xeogl.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.webgl.Program.prototype.setUniform=function(t,e){if(this.allocated){var i=this.uniforms[t];i&&i.setValue(e)}},xeogl.renderer.webgl.Program.prototype.getUniform=function(t){if(this.allocated)return this.uniforms[t]},xeogl.renderer.webgl.Program.prototype.getAttribute=function(t){if(this.allocated)return this.attributes[t]},xeogl.renderer.webgl.Program.prototype.bindTexture=function(t,e,i){if(!this.allocated)return!1;var r=this.samplers[t];return!!r&&r.bindTexture(e,i)},xeogl.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.RenderBuffer=function(t,e,i){i=i||{},this.allocated=!1,this.canvas=t,this.gl=e,this.buffer=null,this.bound=!1,this.size=i.size},xeogl.renderer.webgl.RenderBuffer.prototype.setSize=function(t){this.size=t},xeogl.renderer.webgl.RenderBuffer.prototype.webglRestored=function(t){this.gl=t,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},xeogl.renderer.webgl.RenderBuffer.prototype._touch=function(){var t,e;if(this.size?(t=this.size[0],e=this.size[1]):(t=this.canvas.clientWidth,e=this.canvas.clientHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===e)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:t,height:e},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(r){var i=new WebGLUnsignedByteArray(t*e*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,t,e),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);var r=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(r){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+r}this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},xeogl.renderer.webgl.RenderBuffer.prototype.read=function(t,e){var i=t,r=this.canvas.height-e,s=new Uint8Array(4);return this.gl.readPixels(i,r,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,s),s},xeogl.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var t=this;return{renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.texture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.texture),!0)},unbind:function(e){t.buffer&&t.buffer.texture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}}},xeogl.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Sampler=function(t,e){this.bindTexture=function(i,r){return!!i.bind(r)&&(t.uniform1i(e,r),!0)}}}(),function(){"use strict";xeogl.renderer.webgl.Shader=function(t,e,i){this.allocated=!1,this.compiled=!1,this.errorLog=null,this.source=i,this.handle=t.createShader(e),this.handle?(this.allocated=!0,t.shaderSource(this.handle,i),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),this.compiled||t.isContextLost()||(this.errorLog=[],this.errorLog.push(""),this.errorLog.push(t.getShaderInfoLog(this.handle)),this.errorLog=this.errorLog.concat(this.source))):this.errorLog=["Failed to allocate"]}}(),function(){"use strict";xeogl.renderer.webgl.Texture2D=function(t){this.gl=t,this.target=t.TEXTURE_2D,this.texture=t.createTexture(),this.allocated=!0},xeogl.renderer.webgl.Texture2D.prototype.setImage=function(t,e){var i=this.gl;i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t),i.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype.setProps=function(t){var e=this.gl;if(e.bindTexture(this.target,this.texture),t.minFilter){var i=this._getGLEnum(t.minFilter);i&&(e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,i),i!==e.NEAREST_MIPMAP_NEAREST&&i!==e.LINEAR_MIPMAP_NEAREST&&i!==e.NEAREST_MIPMAP_LINEAR&&i!==e.LINEAR_MIPMAP_LINEAR||e.generateMipmap(this.target))}if(t.magFilter){var r=this._getGLEnum(t.magFilter);r&&e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,r)}if(t.wrapS){var s=this._getGLEnum(t.wrapS);s&&e.texParameteri(this.target,e.TEXTURE_WRAP_S,s)}if(t.wrapT){var n=this._getGLEnum(t.wrapT);n&&e.texParameteri(this.target,e.TEXTURE_WRAP_T,n)}e.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype._getGLEnum=function(t,e){if(void 0===t)return e;var i=xeogl.renderer.webgl.enums[t];return void 0===i?e:this.gl[i]},xeogl.renderer.webgl.Texture2D.prototype.bind=function(t){if(this.allocated){if(this.texture){var e=this.gl;return e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.webgl.Texture2D.prototype.unbind=function(t){if(this.allocated&&this.texture){var e=this.gl;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,null)}},xeogl.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.webgl.clampImageSize=function(t,e){var i=t.width*t.height;if(i>e){var r=e/i,s=t.width*r,n=t.height*r,a=document.createElement("canvas");a.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(s),a.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(n),a.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,a.width,a.height),t=a}return t},xeogl.renderer.webgl.ensureImageSizePowerOfTwo=function(t){if(!xeogl.renderer.webgl.isPowerOfTwo(t.width)||!xeogl.renderer.webgl.isPowerOfTwo(t.height)){var e=document.createElement("canvas");e.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(t.width),e.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(t.height),e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e}return t},xeogl.renderer.webgl.isPowerOfTwo=function(t){return 0==(t&t-1)},xeogl.renderer.webgl.nextHighestPowerOfTwo=function(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}}(),function(){"use strict";xeogl.renderer.webgl.Uniform=function(t,e,i,r){var s=null,n=null;if(i===e.BOOL)s=function(t){n!==t&&(n=t,e.uniform1i(r,t))};else if(i===e.BOOL_VEC2)n=new Array(2),s=function(t){n[0]===t[0]&&n[1]===t[1]||(n[0]=t[0],n[1]=t[1],e.uniform2iv(r,t))};else if(i===e.BOOL_VEC3)n=new Array(3),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]||(n[0]=t[0],n[1]=t[1],n[2]=t[2],e.uniform3iv(r,t))};else if(i===e.BOOL_VEC4)n=new Array(4),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]||(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],e.uniform4iv(r,t))};else if(i===e.INT)s=function(t){n!==t&&(n=t,e.uniform1iv(r,t))};else if(i===e.INT_VEC2)n=new Uint32Array(2),s=function(t){n[0]===t[0]&&n[1]===t[1]||(n.set(t),e.uniform2iv(r,t))};else if(i===e.INT_VEC3)n=new Uint32Array(3),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]||(n.set(t),e.uniform3iv(r,t))};else if(i===e.INT_VEC4)n=new Uint32Array(4),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]||(n.set(t),e.uniform4iv(r,t))};else if(i===e.FLOAT)s=function(t){n!==t&&(n=t,e.uniform1f(r,t))};else if(i===e.FLOAT_VEC2)n=new Float32Array(2),s=function(t){n[0]===t[0]&&n[1]===t[1]||(n.set(t),e.uniform2fv(r,t))};else if(i===e.FLOAT_VEC3)n=new Float32Array(3),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]||(n.set(t),e.uniform3fv(r,t))};else if(i===e.FLOAT_VEC4)n=new Float32Array(4),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]||(n.set(t),e.uniform4fv(r,t))};else if(i===e.FLOAT_MAT2)n=new Float32Array(4),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]||(n.set(t),e.uniformMatrix2fv(r,e.FALSE,t))};else if(i===e.FLOAT_MAT3)n=new Float32Array(9),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]&&n[4]===t[4]&&n[5]===t[5]&&n[6]===t[6]&&n[7]===t[7]&&n[8]===t[8]||(n.set(t),e.uniformMatrix3fv(r,e.FALSE,t))};else{if(i!==e.FLOAT_MAT4)throw"Unsupported shader uniform type: "+i;n=new Float32Array(16),s=function(t){n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]&&n[4]===t[4]&&n[5]===t[5]&&n[6]===t[6]&&n[7]===t[7]&&n[8]===t[8]&&n[9]===t[9]&&n[10]===t[10]&&n[11]===t[11]&&n[12]===t[12]&&n[13]===t[13]&&n[14]===t[14]&&n[15]===t[15]||(n.set(t),e.uniformMatrix4fv(r,e.FALSE,t))}}this.setValue=s,this.getLocation=function(){return r}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.State=Class.extend({__init:function(t){for(var e in this.id=this._ids.addItem({}),this.hash=t.hash||""+this.id,t)t.hasOwnProperty(e)&&(this[e]=t[e])},destroy:function(){this._ids.removeItem(this.id)}}),xeogl.renderer.Visibility=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Cull=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Modes=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Layer=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Stage=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.DepthBuf=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ColorBuf=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Lights=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.PhongMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Reflect=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Transform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Billboard=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Stationary=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.RenderTarget=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.RenderTarget.DEPTH=0,xeogl.renderer.RenderTarget.COLOR=1,xeogl.renderer.Clips=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.MorphTargets=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Shader=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ShaderParams=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Texture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Fresnel=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Geometry=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ProgramState=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Viewport=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})})}(),function(){"use strict";xeogl.renderer.Object=function(t){this.id=t,this.hash=null,this.sortKey=null,this.chunks=[],this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null,this.compiled=!1}}(),function(){"use strict";xeogl.renderer.ObjectFactory=function(){var t=[],e=0;this.get=function(i){var r;return e>0?((r=t[--e]).id=i,r.compiled=!1,r):new xeogl.renderer.Object(i)},this.put=function(i){t[e++]=i}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Program=function(t,e,i,r){this.stats=t,this.hash=i.hash,this.source=i,this.gl=r,this.draw=null,this.pickObject=null,this.pickPrimitive=null,this.useCount=0,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.build(r)},xeogl.renderer.Program.prototype.build=function(t){this.gl=t,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.draw=new xeogl.renderer.webgl.Program(this.stats,t,this.source.vertexDraw,this.source.fragmentDraw),this.pickObject=new xeogl.renderer.webgl.Program(this.stats,t,this.source.vertexPickObject,this.source.fragmentPickObject),this.pickPrimitive=new xeogl.renderer.webgl.Program(this.stats,t,this.source.vertexPickPrimitive,this.source.fragmentPickPrimitive),this.draw.allocated?this.pickObject.allocated?this.pickPrimitive.allocated?(this.allocated=!0,this.draw.compiled?this.pickObject.compiled?this.pickPrimitive.compiled?(this.compiled=!0,this.draw.linked?this.pickObject.linked?this.pickPrimitive.linked?(this.linked=!0,this.draw.validated?this.pickObject.validated?this.pickPrimitive.validated?this.validated=!0:this.errorLog=["Primitive-picking program failed to validate"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to validate"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to validate"].concat(this.draw.errorLog)):this.errorLog=["Primitive-picking program failed to link"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to link"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to link"].concat(this.draw.errorLog)):this.errorLog=["Primitive-picking program failed to compile"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to compile"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to compile"].concat(this.draw.errorLog)):this.errorLog=["Primitive-picking program failed to allocate"].concat(this.pickPrimitive.errorLog):this.errorLog=["Object-picking program failed to allocate"].concat(this.pickObject.errorLog):this.errorLog=["Draw program failed to allocate"].concat(this.draw.errorLog)}}(),function(){"use strict";xeogl.renderer.ProgramFactory=function(t,e){this.stats=t,this._gl=e,this._programStates={}},xeogl.renderer.ProgramFactory.prototype.get=function(t,e){var i=this._programStates[t];if(!i){var r=xeogl.renderer.ProgramSourceFactory.getSource(t,e),s=new xeogl.renderer.Program(this.stats,t,r,this._gl);i=new xeogl.renderer.ProgramState({program:s,useCount:0}),this._programStates[t]=i,this.stats.memory.programs++}return i.useCount++,i},xeogl.renderer.ProgramFactory.prototype.put=function(t){if(--t.useCount<=0){var e=t.program;e.draw.destroy(),e.pickObject.destroy(),e.pickPrimitive.destroy(),xeogl.renderer.ProgramSourceFactory.putSource(e.hash),delete this._programStates[e.hash],this.stats.memory.programs--}},xeogl.renderer.ProgramFactory.prototype.webglRestored=function(t){for(var e in this._gl=t,this._programStates)this._programStates.hasOwnProperty(e)&&this._programStates[e].build(t)},xeogl.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";xeogl.renderer.ProgramSource=function(t,e,i,r,s,n,a){this.hash=t,this.vertexPickObject=e,this.fragmentPickObject=i,this.vertexPickPrimitive=r,this.fragmentPickPrimitive=s,this.vertexDraw=n,this.fragmentDraw=a,this.useCount=0}}(),function(){"use strict";xeogl.renderer.ProgramSourceFactory=new function(){var t,e,i,r,s,n,a,o,h,l,u,c,d,_={},f="";function p(){f=[]}function g(t){f.push(t||"")}function m(t){if(t){for(var e=0,i=0,r=t.length;i<r;i++)" "===t.charAt(i)&&e++;var s=e>0?t.substring(0,e-1):"";f.push(s+"// "+t.substring(e-1))}}function y(){return f}function v(t){return t.getShaderPrecisionFormat?t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0?"highp":t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}this.getSource=function(f,x){var b,w=_[f];return w?(w.useCount++,w):(t=x,e=function(){if(!t.geometry.uv)return!1;var e=t.material;return e.ambientMap||e.diffuseMap||e.specularMap||e.emissiveMap||e.opacityMap||e.reflectivityMap||t.material.normalMap}(),i=function(){var e=t.geometry.primitiveName;if(t.geometry.normals&&("triangles"===e||"triangle-strip"===e||"triangle-fan"===e))return!0;return!1}(),b=t.geometry,r=b.positions&&b.indices&&b.normals&&b.uv&&t.material.normalMap,!1,s=t.material.diffuseFresnel,n=t.material.specularFresnel,a=t.material.opacityFresnel,o=t.material.reflectivityFresnel,h=t.material.emissiveFresnel,w=new xeogl.renderer.ProgramSource(f,function(){if(l)return l;return p(),g("// Object picking vertex shader"),g("attribute vec3 xeo_aPosition;"),g("uniform mat4 xeo_uModelMatrix;"),g("uniform mat4 xeo_uViewMatrix;"),g("uniform mat4 xeo_uViewNormalMatrix;"),g("uniform mat4 xeo_uProjMatrix;"),g("varying vec4 xeo_vWorldPosition;"),g("varying vec4 xeo_vViewPosition;"),g("void main(void) {"),g("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),g("   xeo_vWorldPosition = xeo_uModelMatrix * tmpVertex; "),g("   xeo_vViewPosition = xeo_uViewMatrix * xeo_vWorldPosition;"),g("   gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),g("}"),l=y()}(),function(){if(u)return u;return p(),g("// Object picking fragment shader"),g("precision "+v(t.gl)+" float;"),g("uniform vec4 xeo_uPickColor;"),g("void main(void) {"),g("   gl_FragColor = xeo_uPickColor; "),g("}"),u=y()}(),function(){if(c)return c;return p(),g("// Triangle picking vertex shader"),g("attribute vec3 xeo_aPosition;"),g("attribute vec4 xeo_aColor;"),g("uniform vec3 xeo_uPickColor;"),g("uniform mat4 xeo_uModelMatrix;"),g("uniform mat4 xeo_uViewMatrix;"),g("uniform mat4 xeo_uProjMatrix;"),g("varying vec4 xeo_vWorldPosition;"),g("varying vec4 xeo_vViewPosition;"),g("varying vec4 xeo_vColor;"),g("void main(void) {"),g("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),g("   vec4 worldPosition = xeo_uModelMatrix * tmpVertex; "),g("   vec4 viewPosition = xeo_uViewMatrix * worldPosition;"),g("   xeo_vColor = xeo_aColor;"),g("   gl_Position = xeo_uProjMatrix * viewPosition;"),g("}"),c=y()}(),function(){if(d)return d;return p(),g("// Triangle picking fragment shader"),g("precision "+v(t.gl)+" float;"),g("varying vec4 xeo_vColor;"),g("void main(void) {"),g("   gl_FragColor = xeo_vColor;"),g("}"),d=y()}(),function(){var s,n,a,o=t.shader.vertex;if(o)return o;if(p(),g("// Drawing vertex shader"),g("uniform mat4 xeo_uModelMatrix;          // Modeling matrix"),g("uniform mat4 xeo_uViewMatrix;           // Viewing matrix"),g("uniform mat4 xeo_uProjMatrix;           // Projection matrix"),g("attribute vec3 xeo_aPosition;           // Local-space vertex position"),g(),g("varying vec4 xeo_vViewPosition;         // Output: View-space fragment position"),i)for(g(),g("attribute vec3 xeo_aNormal;             // Local-space vertex normal"),g("uniform mat4 xeo_uModelNormalMatrix;    // Modeling normal matrix"),g("uniform mat4 xeo_uViewNormalMatrix;     // Viewing normal matrix"),g("varying vec3 xeo_vViewEyeVec;           // Output: View-space vector from fragment position to eye"),g("varying vec3 xeo_vViewNormal;           // Output: View-space normal"),s=0,n=t.lights.lights.length;s<n;s++)"ambient"!==(a=t.lights.lights[s]).type&&("dir"===a.type&&g("uniform vec3 xeo_uLightDir"+s+";   // Directional light direction"),"point"===a.type&&g("uniform vec3 xeo_uLightPos"+s+";   // Positional light position"),"spot"===a.type&&g("uniform vec3 xeo_uLightPos"+s+";   // Spot light position"),g("varying vec4 xeo_vViewLightVecAndDist"+s+"; // Output: Vector from vertex to light, packaged with the pre-computed length of that vector"));r&&g("attribute vec3 xeo_aTangent;");e&&(g(),g("attribute vec2 xeo_aUV;"),g("varying vec2 xeo_vUV;"));t.geometry.colors&&(g("attribute vec4 xeo_aColor;"),g("varying vec4 xeo_vColor;"));"points"===t.geometry.primitiveName&&g("uniform float xeo_uPointSize;");t.billboard.active&&(g("void billboard(inout mat4 mat) {"),g("   mat[0][0] = 1.0;"),g("   mat[0][1] = 0.0;"),g("   mat[0][2] = 0.0;"),t.billboard.spherical&&(g("   mat[1][0] = 0.0;"),g("   mat[1][1] = 1.0;"),g("   mat[1][2] = 0.0;")),g("   mat[2][0] = 0.0;"),g("   mat[2][1] = 0.0;"),g("   mat[2][2] =1.0;"),g("}"));g(),g("void main(void) {"),g(),g("   vec4 localPosition = vec4(xeo_aPosition, 1.0); "),i&&(g("   vec4 localNormal = vec4(xeo_aNormal, 0.0); "),g("   mat4 modelNormalMatrix = xeo_uModelNormalMatrix;"),g("   mat4 viewNormalMatrix = xeo_uViewNormalMatrix;"));g("   mat4 modelMatrix = xeo_uModelMatrix;"),g("   mat4 viewMatrix = xeo_uViewMatrix;"),g("   vec4 worldPosition;"),t.stationary.active&&g("   viewMatrix[3][0] = viewMatrix[3][1] = viewMatrix[3][2] = 0.0;");t.billboard.active?(g("   mat4 modelViewMatrix =  xeo_uViewMatrix * xeo_uModelMatrix;"),g("   billboard(modelMatrix);"),g("   billboard(viewMatrix);"),g("   billboard(modelViewMatrix);"),i&&(g("   mat4 modelViewNormalMatrix =  xeo_uViewNormalMatrix * xeo_uModelNormalMatrix;"),g("   billboard(modelNormalMatrix);"),g("   billboard(viewNormalMatrix);"),g("   billboard(modelViewNormalMatrix);")),g("   worldPosition = modelMatrix * localPosition;"),g("   vec4 viewPosition = modelViewMatrix * localPosition;")):(g("   worldPosition = modelMatrix * localPosition;"),g("   vec4 viewPosition  = viewMatrix * worldPosition; "));if(i){for(g("   vec3 worldNormal = (modelNormalMatrix * localNormal).xyz; "),g("   xeo_vViewNormal = normalize((viewNormalMatrix * vec4(worldNormal, 1.0)).xyz);"),r&&(g("   vec3 tangent = normalize((xeo_uViewNormalMatrix * xeo_uModelNormalMatrix * vec4(xeo_aTangent, 1.0)).xyz);"),g("   vec3 bitangent = cross(xeo_vViewNormal, tangent);"),g("   mat3 TBN = mat3(tangent, bitangent, xeo_vViewNormal);")),g("   vec3 tmpVec3;"),g("   float lightDist;"),s=0,n=t.lights.lights.length;s<n;s++)"ambient"!==(a=t.lights.lights[s]).type&&("dir"===a.type&&("world"===a.space?(g("   tmpVec3 = xeo_uLightDir"+s+";"),g("   tmpVec3 = vec3(viewMatrix * vec4(tmpVec3, 1.0)).xyz;"),r&&g("   tmpVec3 *= TBN;")):(g("   tmpVec3 = xeo_uLightDir"+s+";"),r&&g("   tmpVec3 *= TBN;")),g("   xeo_vViewLightVecAndDist"+s+" = vec4(tmpVec3, 0.0);")),"point"===a.type&&("world"===a.space?(g("   tmpVec3 = (viewMatrix * vec4(xeo_uLightPos"+s+", 1.0)).xyz - viewPosition.xyz;"),g("   lightDist = abs(length(tmpVec3));"),r&&g("   tmpVec3 *= TBN;")):(g("   tmpVec3 = xeo_uLightPos"+s+".xyz - viewPosition.xyz;"),g("   lightDist = abs(length(tmpVec3));"),r&&g("   tmpVec3 *= TBN;")),g("   xeo_vViewLightVecAndDist"+s+" = vec4(tmpVec3, lightDist);")));g("   xeo_vViewEyeVec = -viewPosition.xyz;"),r&&g("   xeo_vViewEyeVec *= TBN;")}e&&g("   xeo_vUV = xeo_aUV;");t.geometry.colors&&g("   xeo_vColor = xeo_aColor;");"points"===t.geometry.primitiveName&&g("   gl_PointSize = xeo_uPointSize;");return g("   xeo_vViewPosition = viewPosition;"),g("   gl_Position = xeo_uProjMatrix * viewPosition;"),g("}"),y()}(),function(){var l,u,c,d=t.shader.fragment;if(d)return d;p(),g("// Drawing fragment shader"),g("precision "+v(t.gl)+" float;"),g(),i&&(g("varying vec4 xeo_vViewPosition;"),g(),g("uniform vec3 xeo_uSpecular;"),g("uniform float xeo_uShininess;"),g("uniform float xeo_uReflectivity;"));g("uniform vec3 xeo_uEmissive;"),g("uniform float xeo_uOpacity;"),g("uniform vec3 xeo_uDiffuse;"),g(),t.geometry.colors&&g("varying vec4 xeo_vColor;");e&&(g(),m("Texture variables"),g(),t.geometry.uv&&g("varying vec2 xeo_vUV;"),t.material.emissiveMap&&(g("uniform sampler2D xeo_uEmissiveMap;"),t.material.emissiveMap.matrix&&g("uniform mat4 xeo_uEmissiveMapMatrix;")),t.material.opacityMap&&(g("uniform sampler2D xeo_uOpacityMap;"),t.material.opacityMap.matrix&&g("uniform mat4 xeo_uOpacityMapMatrix;")),t.material.ambientMap&&(g("uniform sampler2D xeo_uAmbientMap;"),t.material.ambientMap.matrix&&g("uniform mat4 xeo_uAmbientMapMatrix;")),t.material.diffuseMap&&(g("uniform sampler2D xeo_uDiffuseMap;"),t.material.diffuseMap.matrix&&g("uniform mat4 xeo_uDiffuseMapMatrix;")),i&&(t.material.specularMap&&(g("uniform sampler2D xeo_uSpecularMap;"),t.material.specularMap.matrix&&g("uniform mat4 xeo_uSpecularMapMatrix;")),t.material.reflectivityMap&&(g("uniform sampler2D xeo_uTextureReflectivity;"),t.material.reflectivityMap.matrix&&g("uniform mat4 xeo_uTextureReflectivityMatrix;")),r&&(g("uniform sampler2D xeo_uNormalMap;"),t.material.normalMap.matrix&&g("uniform mat4 xeo_uNormalMapMatrix;"))));if(g("uniform vec3 xeo_uLightAmbientColor;"),g("uniform float xeo_uLightAmbientIntensity;"),i){for(g("varying vec3 xeo_vViewEyeVec;"),g("varying vec3 xeo_vViewNormal;"),l=0,u=t.lights.lights.length;l<u;l++)"ambient"!==(c=t.lights.lights[l]).type&&(g("uniform vec3 xeo_uLightColor"+l+";"),g("uniform float xeo_uLightIntensity"+l+";"),"point"===c.type&&g("uniform vec3 xeo_uLightAttenuation"+l+";"),g("varying vec4 xeo_vViewLightVecAndDist"+l+";"));(s||n||a||h||o)&&(g(),m("Fresnel variables"),g(),s&&(g("uniform float xeo_uDiffuseFresnelCenterBias;"),g("uniform float xeo_uDiffuseFresnelEdgeBias;"),g("uniform float xeo_uDiffuseFresnelPower;"),g("uniform vec3 xeo_uDiffuseFresnelCenterColor;"),g("uniform vec3 xeo_uDiffuseFresnelEdgeColor;"),g()),n&&(g("uniform float xeo_uSpecularFresnelCenterBias;"),g("uniform float xeo_uSpecularFresnelEdgeBias;"),g("uniform float xeo_uSpecularFresnelPower;"),g("uniform vec3 xeo_uSpecularFresnelCenterColor;"),g("uniform vec3 xeo_uSpecularFresnelEdgeColor;"),g()),a&&(g("uniform float xeo_uOpacityFresnelCenterBias;"),g("uniform float xeo_uOpacityFresnelEdgeBias;"),g("uniform float xeo_uOpacityFresnelPower;"),g("uniform vec3 xeo_uOpacityFresnelCenterColor;"),g("uniform vec3 xeo_uOpacityFresnelEdgeColor;"),g()),o&&(g("uniform float xeo_uReflectivityFresnelCenterBias;"),g("uniform float xeo_uReflectivityFresnelEdgeBias;"),g("uniform float xeo_uReflectivityFresnelPower;"),g("uniform vec3 xeo_uReflectivityFresnelCenterColor;"),g("uniform vec3 xeo_uReflectivityFresnelEdgeColor;"),g()),h&&(g("uniform float xeo_uEmissiveFresnelCenterBias;"),g("uniform float xeo_uEmissiveFresnelEdgeBias;"),g("uniform float xeo_uEmissiveFresnelPower;"),g("uniform vec3 xeo_uEmissiveFresnelCenterColor;"),g("uniform vec3 xeo_uEmissiveFresnelEdgeColor;"),g()),m("Fresnel calculation"),g(),g("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),g("    float fr = abs(dot(eyeDir, normal));"),g("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),g("    return pow(finalFr, power);"),g("}"))}g(),g("void main(void) {"),g(),g("   vec3 ambient = xeo_uLightAmbientColor;"),g("   vec3 emissive = xeo_uEmissive;"),g("   float opacity = xeo_uOpacity;"),t.geometry.colors?g("   vec3 diffuse = xeo_vColor.rgb;"):g("   vec3 diffuse = xeo_uDiffuse;");i&&(g("vec3 viewEyeVec = normalize(xeo_vViewEyeVec);"),g("   vec3 specular = xeo_uSpecular;"),g("   float shininess = xeo_uShininess;"),g("   float reflectivity = xeo_uReflectivity;"),g(r?"   vec3 viewNormal = vec3(0.0, 1.0, 0.0);":"   vec3 viewNormal = normalize(xeo_vViewNormal);"));if(e){g(),m("   Apply textures"),g(),g("   vec4 texturePos = vec4(xeo_vUV.s, xeo_vUV.t, 1.0, 1.0);"),g("   vec2 textureCoord;");var _=t.material;_.emissiveMap&&(g(),_.emissiveMap.matrix?g("   textureCoord = (xeo_uEmissiveMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   emissive = texture2D(xeo_uEmissiveMap, textureCoord).rgb;")),_.opacityMap&&(g(),_.opacityMap.matrix?g("   textureCoord = (xeo_uOpacityMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   opacity = texture2D(xeo_uOpacityMap, textureCoord).b;")),_.ambientMap&&(g(),_.ambientMap.matrix?g("   textureCoord = (xeo_uAmbientMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   ambient = texture2D(xeo_uAmbientMap, textureCoord).rgb;")),_.diffuseMap&&(g(),_.diffuseMap.matrix?g("   textureCoord = (xeo_uDiffuseMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   diffuse = texture2D(xeo_uDiffuseMap, textureCoord).rgb;")),i&&(_.specularMap&&(g(),_.specularMap.matrix?g("   textureCoord = (xeo_uSpecularMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   specular = texture2D(xeo_uSpecularMap, textureCoord).rgb;")),_.reflectivityMap&&(g(),_.reflectivityMap.matrix?g("   textureCoord = (xeo_uReflectivityMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   reflectivity = texture2D(xeo_uReflectivityMap, textureCoord).b;"))),r&&(g(),_.normalMap.matrix?g("   textureCoord = (xeo_uNormalMapMatrix * texturePos).xy;"):g("   textureCoord = texturePos.xy;"),g("   textureCoord.y = -textureCoord.y;"),g("   viewNormal = normalize(texture2D(xeo_uNormalMap, vec2(textureCoord.x, textureCoord.y)).xyz * 2.0 - 1.0);"))}if(g("   vec4 fragColor;"),i){for(g(),g("   vec3  diffuseLight = vec3(0.0, 0.0, 0.0);"),g("   vec3  specularLight = vec3(0.0, 0.0, 0.0);"),g(),g("   vec3  viewLightVec;"),g("   float specAngle;"),g("   float lightDist;"),g("   float attenuation;"),l=0,u=t.lights.lights.length;l<u;l++)"ambient"!==(c=t.lights.lights[l]).type&&(g("   viewLightVec = normalize(xeo_vViewLightVecAndDist"+l+".xyz);"),"point"===c.type&&(g(),g("   specAngle = max(dot(viewNormal, viewLightVec), 0.0);"),g("   lightDist = xeo_vViewLightVecAndDist"+l+".w;"),g("   attenuation = 1.0 - (  xeo_uLightAttenuation"+l+"[0] +   xeo_uLightAttenuation"+l+"[1] * lightDist +   xeo_uLightAttenuation"+l+"[2] * lightDist * lightDist);"),g("   diffuseLight += xeo_uLightIntensity"+l+" * specAngle * xeo_uLightColor"+l+" * attenuation;"),g("   specularLight += xeo_uLightIntensity"+l+" *  pow(max(dot(reflect(-viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess) * attenuation;")),"dir"===c.type&&(g("   specAngle = max(dot(viewNormal, -viewLightVec), 0.0);"),g("   diffuseLight += xeo_uLightIntensity"+l+" * specAngle * xeo_uLightColor"+l+";"),g("   specularLight += xeo_uLightIntensity"+l+" * pow(max(dot(reflect(viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess);")));g(),(s||n||a||h||o)&&(g(),m("   Apply Fresnels"),s&&(g(),g("float diffuseFresnel = fresnel(viewEyeVec, viewNormal, xeo_uDiffuseFresnelEdgeBias, xeo_uDiffuseFresnelCenterBias, xeo_uDiffuseFresnelPower);"),g("diffuse *= mix(xeo_uDiffuseFresnelEdgeColor, xeo_uDiffuseFresnelCenterColor, diffuseFresnel);")),n&&(g(),g("float specularFresnel = fresnel(viewEyeVec, viewNormal, xeo_uSpecularFresnelEdgeBias, xeo_uSpecularFresnelCenterBias, xeo_uSpecularFresnelPower);"),g("specular *= mix(xeo_uSpecularFresnelEdgeColor, xeo_uSpecularFresnelCenterColor, specularFresnel);")),a&&(g(),g("float opacityFresnel = fresnel(viewEyeVec, viewNormal, xeo_uOpacityFresnelEdgeBias, xeo_uOpacityFresnelCenterBias, xeo_uOpacityFresnelPower);"),g("opacity *= mix(xeo_uOpacityFresnelEdgeColor.r, xeo_uOpacityFresnelCenterColor.r, opacityFresnel);")),h&&(g(),g("float emissiveFresnel = fresnel(viewEyeVec, viewNormal, xeo_uEmissiveFresnelEdgeBias, xeo_uEmissiveFresnelCenterBias, xeo_uEmissiveFresnelPower);"),g("emissive *= mix(xeo_uEmissiveFresnelEdgeColor, xeo_uEmissiveFresnelCenterColor, emissiveFresnel);"))),g(),m("   Phong BRDF"),g(),g("   fragColor = vec4((specular * specularLight) + ((diffuseLight + (ambient * xeo_uLightAmbientIntensity) ) * diffuse) + emissive, opacity);")}else g(),m("   Non-Lambertian BRDF"),g(),g("   fragColor = vec4(emissive + diffuse, opacity);");return g("   fragColor.rgb *= fragColor.a;"),g("   gl_FragColor = fragColor;"),g("}"),y()}()),_[f]=w,w)},this.putSource=function(t){var e=_[t];e&&0==--e.useCount&&(_[e.hash]=null)}}}(),function(){"use strict";xeogl.renderer.Chunk=function(){},xeogl.renderer.Chunk.prototype.init=function(t,e,i){this.id=t,this.program=e,this.state=i,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";xeogl.renderer.ChunkFactory=function(){this.types=xeogl.renderer.ChunkFactory.types},xeogl.renderer.ChunkFactory.types={},xeogl.renderer.ChunkFactory.createChunkType=function(t){if(!t.type)throw"'type' expected in params";var e=xeogl.renderer.Chunk,i=function(){this.useCount=0,this.init.apply(this,arguments)};return(i.prototype=new e).constructor=i,xeogl._apply(t,i.prototype),xeogl.renderer.ChunkFactory.types[t.type]={constructor:i,chunks:{},freeChunks:[],freeChunksLen:0},i},xeogl.renderer.ChunkFactory.prototype.getChunk=function(t,e,i,r){var s=this.types[e];if(!s)throw"chunk type not supported: '"+e+"'";var n=s.chunks[t];return n?(n.useCount++,n):(s.freeChunksLen>0&&(n=s.freeChunks[--s.freeChunksLen]),n?n.init(t,i,r):n=new s.constructor(t,i,r),n.useCount=1,s.chunks[t]=n,n)},xeogl.renderer.ChunkFactory.prototype.putChunk=function(t){if(0!==t.useCount&&--t.useCount<=0){var e=this.types[t.type];delete e.chunks[t.id],e.freeChunks[e.freeChunksLen++]=t}},xeogl.renderer.ChunkFactory.prototype.webglRestored=function(t){var e,i,r=this.types;for(var s in r)if(r.hasOwnProperty(s))for(var n in e=r[s].chunks)e.hasOwnProperty(n)&&(i=e[n]).build&&i.build()}}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){var t,e;this._uClipModeDraw=this._uClipModeDraw||[],this._uClipPlaneDraw=this._uClipPlaneDraw||[];var i=this.program.draw;for(t=0,e=this.state.clips.length;t<e;t++)this._uClipModeDraw[t]=i.getUniform("xeo_uClipMode"+t),this._uClipPlaneDraw[t]=i.getUniform("xeo_uClipPlane"+t);this._uClipModePick=this._uClipModePick||[],this._uClipPlanePick=this._uClipPlanePick||[];var r=this.program.pick;for(t=0,e=this.state.clips.length;t<e;t++)this._uClipModePick[t]=r.getUniform("xeo_uClipMode"+t),this._uClipPlanePick[t]=r.getUniform("xeo_uClipPlane"+t)},drawPick:function(t){}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"colorBuf",programGlobal:!0,draw:function(t){if(!t.transparent){var e=this.state,i=e.blendEnabled,r=this.program.gl;t.blendEnabled!==i&&(i?r.enable(r.BLEND):r.disable(r.BLEND),t.blendEnabled=i);var s=e.colorMask;r.colorMask(s[0],s[1],s[2],s[3])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"cubemap",build:function(){},draw:function(t){}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"depthBuf",programGlobal:!0,draw:function(t){var e=this.program.gl,i=this.state,r=i.active;t.depthbufEnabled!==r&&(r?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),t.depthbufEnabled=r);var s=i.clearDepth;t.clearDepth!==s&&(e.clearDepth(s),t.clearDepth=s);var n=i.depthFunc;t.depthFunc!==n&&(e.depthFunc(n),t.depthFunc=n),i.clear&&e.clear(e.DEPTH_BUFFER_BIT)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._uPickColorObject=this.program.pickObject.getUniform("xeo_uPickColor")},draw:function(t){var e=this.state,i=this.program.gl;e.indices&&(i.drawElements(e.primitive,e.indices.numItems,e.indices.itemType,0),t.drawElements++)},pickObject:function(t){var e=this.state,i=this.program.gl;if(this._uPickColorObject){t.pickIndex++;var r=t.pickIndex>>16&255,s=t.pickIndex>>8&255,n=255&t.pickIndex;this._uPickColorObject.setValue([n/255,s/255,r/255,1])}e.indices&&(i.drawElements(e.primitive,e.indices.numItems,e.indices.itemType,0),t.drawElements++)},pickPrimitive:function(){var t=this.state,e=this.program.gl,i=t.getPickPositions();i&&e.drawArrays(t.primitive,0,i.numItems/3)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var t=this.program.draw;this._aPositionDraw=t.getAttribute("xeo_aPosition"),this._aNormalDraw=t.getAttribute("xeo_aNormal"),this._aUVDraw=t.getAttribute("xeo_aUV"),this._aTangentDraw=t.getAttribute("xeo_aTangent"),this._aColorDraw=t.getAttribute("xeo_aColor");var e=this.program.pickObject;this._aPositionPickObject=e.getAttribute("xeo_aPosition");var i=this.program.pickPrimitive;this._aPositionPickPrimitive=i.getAttribute("xeo_aPosition"),this._aColorPickPrimitive=i.getAttribute("xeo_aColor")},draw:function(t){var e=this.state;this._aPositionDraw&&(this._aPositionDraw.bindFloatArrayBuffer(e.positions),t.bindArray++),this._aNormalDraw&&(this._aNormalDraw.bindFloatArrayBuffer(e.normals),t.bindArray++),this._aUVDraw&&(this._aUVDraw.bindFloatArrayBuffer(e.uv),t.bindArray++),this._aColorDraw&&(this._aColorDraw.bindFloatArrayBuffer(e.colors),t.bindArray++),this._aTangentDraw&&(this._aTangentDraw.bindFloatArrayBuffer(e.getTangents()),t.bindArray++),e.indices&&(e.indices.bind(),t.bindArray++)},pickObject:function(){var t=this.state;this._aPositionPickObject&&this._aPositionPickObject.bindFloatArrayBuffer(t.positions),t.indices&&t.indices.bind()},pickPrimitive:function(){var t=this.state;this._aPositionPickPrimitive&&this._aPositionPickPrimitive.bindFloatArrayBuffer(t.getPickPositions()),this._aColorPickPrimitive&&this._aColorPickPrimitive.bindFloatArrayBuffer(t.getPickColors())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var t=this.state.lights,e=this.program,i=0,r=t.length;i<r;i++)switch(t[i].type){case"ambient":this._uLightAmbientColor[i]=e.draw.getUniform("xeo_uLightAmbientColor"),this._uLightAmbientIntensity[i]=e.draw.getUniform("xeo_uLightAmbientIntensity");break;case"dir":this._uLightColor[i]=e.draw.getUniform("xeo_uLightColor"+i),this._uLightIntensity[i]=e.draw.getUniform("xeo_uLightIntensity"+i),this._uLightPos[i]=null,this._uLightDir[i]=e.draw.getUniform("xeo_uLightDir"+i);break;case"point":this._uLightColor[i]=e.draw.getUniform("xeo_uLightColor"+i),this._uLightIntensity[i]=e.draw.getUniform("xeo_uLightIntensity"+i),this._uLightPos[i]=e.draw.getUniform("xeo_uLightPos"+i),this._uLightDir[i]=null,this._uLightAttenuation[i]=e.draw.getUniform("xeo_uLightAttenuation"+i)}},draw:function(){for(var t,e=this.state.lights,i=0,r=e.length;i<r;i++)t=e[i],this._uLightAmbientColor[i]?(this._uLightAmbientColor[i].setValue(t.color),this._uLightAmbientIntensity[i]&&this._uLightAmbientIntensity[i].setValue(t.intensity)):(this._uLightColor[i]&&this._uLightColor[i].setValue(t.color),this._uLightIntensity[i]&&this._uLightIntensity[i].setValue(t.intensity),this._uLightPos[i]&&(this._uLightPos[i].setValue(t.pos),this._uLightAttenuation[i]&&this._uLightAttenuation[i].setValue(t.attenuation)),this._uLightDir[i]&&this._uLightDir[i].setValue(t.dir))}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){this._uModelMatrixDraw=this.program.draw.getUniform("xeo_uModelMatrix"),this._uModelNormalMatrixDraw=this.program.draw.getUniform("xeo_uModelNormalMatrix"),this._uModelMatrixPickObject=this.program.pickObject.getUniform("xeo_uModelMatrix"),this._uModelMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uModelMatrix")},draw:function(){this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.getMatrix()),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.getNormalMatrix())},pickObject:function(){this._uModelMatrixPickObject&&this._uModelMatrixPickObject.setValue(this.state.getMatrix())},pickPrimitive:function(){this._uModelMatrixPickPrimitive&&this._uModelMatrixPickPrimitive.setValue(this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){},draw:function(t){var e=this.state,i=this.program.gl,r=e.backfaces;t.backfaces!==r&&(r?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),t.backfaces=r);var s=e.frontface;t.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),t.frontface=s);var n=e.transparent;t.transparent!==n&&(t.pick||(n?(i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),t.blendEnabled=!0):(i.disable(i.BLEND),t.blendEnabled=!1)),t.transparent=n)},pickObject:function(t){var e=this.state,i=this.program.gl,r=e.backfaces;t.backfaces!==r&&(r?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),t.backfaces=r);var s=e.frontface;t.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),t.frontface=s)},pickPrimitive:function(t){var e=this.state,i=this.program.gl,r=e.backfaces;t.backfaces!==r&&(r?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),t.backfaces=r);var s=e.frontface;t.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),t.frontface=s)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var t=this.state,e=this.program.draw;this._uDiffuse=e.getUniform("xeo_uDiffuse"),this._uSpecular=e.getUniform("xeo_uSpecular"),this._uEmissive=e.getUniform("xeo_uEmissive"),this._uOpacity=e.getUniform("xeo_uOpacity"),this._uShininess=e.getUniform("xeo_uShininess"),this._uPointSize=e.getUniform("xeo_uPointSize"),t.ambientMap&&(this._uAmbientMap="xeo_uAmbientMap",this._uAmbientMapMatrix=e.getUniform("xeo_uAmbientMapMatrix")),t.diffuseMap&&(this._uDiffuseMap="xeo_uDiffuseMap",this._uDiffuseMapMatrix=e.getUniform("xeo_uDiffuseMapMatrix")),t.specularMap&&(this._uSpecularMap="xeo_uSpecularMap",this._uSpecularMapMatrix=e.getUniform("xeo_uSpecularMapMatrix")),t.emissiveMap&&(this._uEmissiveMap="xeo_uEmissiveMap",this._uEmissiveMapMatrix=e.getUniform("xeo_uEmissiveMapMatrix")),t.opacityMap&&(this._uOpacityMap="xeo_uOpacityMap",this._uOpacityMapMatrix=e.getUniform("xeo_uOpacityMapMatrix")),t.reflectivityMap&&(this._uReflectivityMap="xeo_uReflectivityMap",this._uReflectivityMapMatrix=e.getUniform("xeo_uReflectivityMapMatrix")),t.normalMap&&(this._uNormalMap="xeo_uNormalMap",this._uNormalMapMatrix=e.getUniform("xeo_uNormalMapMatrix")),t.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=e.getUniform("xeo_uDiffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=e.getUniform("xeo_uDiffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=e.getUniform("xeo_uDiffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=e.getUniform("xeo_uDiffuseFresnelCenterColor"),this._uDiffuseFresnelPower=e.getUniform("xeo_uDiffuseFresnelPower")),t.specularFresnel&&(this._uSpecularFresnelEdgeBias=e.getUniform("xeo_uSpecularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=e.getUniform("xeo_uSpecularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=e.getUniform("xeo_uSpecularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=e.getUniform("xeo_uSpecularFresnelCenterColor"),this._uSpecularFresnelPower=e.getUniform("xeo_uSpecularFresnelPower")),t.opacityFresnel&&(this._uOpacityFresnelEdgeBias=e.getUniform("xeo_uOpacityFresnelEdgeBias"),this._uOpacityFresnelCenterBias=e.getUniform("xeo_uOpacityFresnelCenterBias"),this._uOpacityFresnelEdgeColor=e.getUniform("xeo_uOpacityFresnelEdgeColor"),this._uOpacityFresnelCenterColor=e.getUniform("xeo_uOpacityFresnelCenterColor"),this._uOpacityFresnelPower=e.getUniform("xeo_uOpacityFresnelPower")),t.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=e.getUniform("xeo_uReflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=e.getUniform("xeo_uReflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=e.getUniform("xeo_uReflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=e.getUniform("xeo_uReflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=e.getUniform("xeo_uReflectivityFresnelPower")),t.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=e.getUniform("xeo_uEmissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=e.getUniform("xeo_uEmissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=e.getUniform("xeo_uEmissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=e.getUniform("xeo_uEmissiveFresnelCenterColor"),this._uEmissiveFresnelPower=e.getUniform("xeo_uEmissiveFresnelPower"))},draw:function(t){var e=this.program.draw,i=this.state,r=this.program.gl;this._uShininess&&this._uShininess.setValue(i.shininess),t.lineWidth!==i.lineWidth&&(r.lineWidth(i.lineWidth),t.lineWidth=i.lineWidth),this._uPointSize&&this._uPointSize.setValue(i.pointSize),i.ambientMap&&i.ambientMap.texture&&(e.bindTexture(this._uAmbientMap,i.ambientMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),t.bindTexture++,this._uAmbientMapMatrix&&this._uAmbientMapMatrix.setValue(i.ambientMap.matrix)),i.diffuseMap&&i.diffuseMap.texture?(e.bindTexture(this._uDiffuseMap,i.diffuseMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),t.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(i.diffuseMap.matrix)):this._uDiffuse&&this._uDiffuse.setValue(i.diffuse),i.specularMap&&i.specularMap.texture?(e.bindTexture(this._uSpecularMap,i.specularMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),t.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(i.specularMap.matrix)):this._uSpecular&&this._uSpecular.setValue(i.specular),i.emissiveMap&&i.emissiveMap.texture?(e.bindTexture(this._uEmissiveMap,i.emissiveMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),t.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(i.emissiveMap.matrix)):this._uEmissive&&this._uEmissive.setValue(i.emissive),i.opacityMap&&i.opacityMap.texture?(e.bindTexture(this._uOpacityMap,i.opacityMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),t.bindTexture++,this._uOpacityMapMatrix&&this._uOpacityMapMatrix.setValue(i.opacityMap.matrix)):this._uOpacity&&this._uOpacity.setValue(i.opacity),i.reflectivityMap&&i.reflectivityMap.texture&&(e.bindTexture(this._uReflectivityMap,i.reflectivityMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(i.reflectivityMap.matrix)),i.normalMap&&i.normalMap.texture&&(e.bindTexture(this._uNormalMap,i.normalMap.texture,t.textureUnit<8?t.textureUnit++:t.textureUnit=0),t.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(i.normalMap.matrix)),i.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&this._uDiffuseFresnelEdgeBias.setValue(i.diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&this._uDiffuseFresnelCenterBias.setValue(i.diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&this._uDiffuseFresnelEdgeColor.setValue(i.diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&this._uDiffuseFresnelCenterColor.setValue(i.diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(i.diffuseFresnel.power)),i.specularFresnel&&(this._uSpecularFresnelEdgeBias&&this._uSpecularFresnelEdgeBias.setValue(i.specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&this._uSpecularFresnelCenterBias.setValue(i.specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&this._uSpecularFresnelEdgeColor.setValue(i.specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&this._uSpecularFresnelCenterColor.setValue(i.specularFresnel.centerColor),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(i.specularFresnel.power)),i.opacityFresnel&&(this._uOpacityFresnelEdgeBias&&this._uOpacityFresnelEdgeBias.setValue(i.opacityFresnel.edgeBias),this._uOpacityFresnelCenterBias&&this._uOpacityFresnelCenterBias.setValue(i.opacityFresnel.centerBias),this._uOpacityFresnelEdgeColor&&this._uOpacityFresnelEdgeColor.setValue(i.opacityFresnel.edgeColor),this._uOpacityFresnelCenterColor&&this._uOpacityFresnelCenterColor.setValue(i.opacityFresnel.centerColor),this._uOpacityFresnelPower&&this._uOpacityFresnelPower.setValue(i.opacityFresnel.power)),i.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&this._uReflectivityFresnelEdgeBias.setValue(i.reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&this._uReflectivityFresnelCenterBias.setValue(i.reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&this._uReflectivityFresnelEdgeColor.setValue(i.reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&this._uReflectivityFresnelCenterColor.setValue(i.reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(i.reflectivityFresnel.power)),i.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&this._uEmissiveFresnelEdgeBias.setValue(i.emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&this._uEmissiveFresnelCenterBias.setValue(i.emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&this._uEmissiveFresnelEdgeColor.setValue(i.emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&this._uEmissiveFresnelCenterColor.setValue(i.emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(i.emissiveFresnel.power))}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"program",build:function(){},draw:function(t){this.program.draw.bind(),t.useProgram++},pickObject:function(){this.program.pickObject.bind()},pickPrimitive:function(){this.program.pickPrimitive.bind()}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickObject=this.program.pickObject.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uProjMatrix")},draw:function(){this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(this.state.getMatrix())},pickObject:function(t){this._uProjMatrixPickObject&&this._uProjMatrixPickObject.setValue(t.pickProjMatrix||this.state.getMatrix())},pickPrimitive:function(t){this._uProjMatrixPickPrimitive&&this._uProjMatrixPickPrimitive.setValue(t.pickProjMatrix||this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(t){var e=this.program.gl,i=this.state;t.renderBuf&&(e.flush(),t.renderBuf.unbind(),t.renderBuf=null,t.bindOutputFramebuffer&&t.bindOutputFramebuffer(t.pass));var r=i.renderBuf;r?(r.bind(),t.depthMode=i.type===i.DEPTH,t.blendEnabled&&!t.depthMode&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clearColor(t.ambientColor[0],t.ambientColor[1],t.ambientColor[2],1),t.renderBuf=r):t.depthMode=!1}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"shader",draw:function(){var t=this.state.params;if(t){var e,i=this.program.draw;for(e in t)t.hasOwnProperty(e)&&i.setUniform(e,t[e])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"shaderParams",draw:function(){var t=this.state.params;if(t){var e,i=this.program.draw;for(e in t)t.hasOwnProperty(e)&&i.setUniform(e,t[e])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("xeo_uViewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("xeo_uViewNormalMatrix"),this._uViewMatrixPickObject=this.program.pickObject.getUniform("xeo_uViewMatrix"),this._uViewMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uViewMatrix")},draw:function(){this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(this.state.getMatrix()),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(this.state.getNormalMatrix())},pickObject:function(t){this._uViewMatrixPickObject&&this._uViewMatrixPickObject.setValue(t.pickViewMatrix||this.state.getMatrix())},pickPrimitive:function(t){this._uViewMatrixPickPrimitive&&this._uViewMatrixPickPrimitive.setValue(t.pickViewMatrix||this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewport",programGlobal:!0,draw:function(){var t=this.state.boundary;this.program.gl.viewport(t[0],t[1],t[2],t[3])},pickObject:function(){var t=this.state.boundary;this.program.gl.viewport(t[0],t[1],t[2],t[3])},pickPrimitive:function(){var t=this.state.boundary;this.program.gl.viewport(t[0],t[1],t[2],t[3])}})}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var t={},e=arguments[0],i=arguments[1];this.scene=null,"xeogl.Scene"===this.type?(this.scene=this,e&&(t=e)):(e?"xeogl.Scene"===e.type?(this.scene=e,i&&(t=i)):(this.scene=xeogl.scene,t=e):this.scene=xeogl.scene,this._renderer=this.scene._renderer),this.meta=t.meta||{},this.isDefault=t.isDefault,this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._events=null,this._handleMap=null,this._handleEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._sharedComponents=null,this.scene&&"xeogl.Scene"!==this.type&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(t)},type:"xeogl.Component",superTypes:[],isType:function(t){return!(!xeogl._isString(t)&&!(t=t.type))&&xeogl._isComponentType(this.type,t)},_init:function(t){},fire:function(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[t]=e);var r,s=this._eventSubs[t];if(s)for(var n in s)s.hasOwnProperty(n)&&(r=s[n],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,e):this.error("fire: potential stack overflow from recursive event '"+t+"' - dropping this event"),this._eventCallDepth--)},on:function(t,e,i){this._events||(this._events={}),this._handleMap||(this._handleMap=new xeogl.utils.Map),this._handleEvents||(this._handleEvents={}),this._eventSubs||(this._eventSubs={});var r=this._eventSubs[t];r||(r={},this._eventSubs[t]=r);var s=this._handleMap.addItem();r[s]={callback:e,scope:i||this},this._handleEvents[s]=t;var n=this._events[t];return void 0!==n&&e.call(i||this,n),s},off:function(t){if(void 0!==t&&null!==t&&this._handleEvents){var e=this._handleEvents[t];if(e){delete this._handleEvents[t];var i=this._eventSubs[e];i&&delete i[t],this._handleMap.removeItem(t)}}},once:function(t,e,i){var r=this,s=this.on(t,function(t){r.off(s),e(t)},i)},log:function(t){t="[LOG]"+this._message(t),window.console.log(t),this.scene.fire("log",t)},_message:function(t){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+t},warn:function(t){t="[WARN]"+this._message(t),window.console.warn(t),this.scene.fire("warn",t)},error:function(t){t="[ERROR]"+this._message(t),window.console.error(t),this.scene.fire("error",t)},clone:function(t){if(!this.destroyed){t=t||{};var e=this.json;return delete e.id,new this.constructor(this.scene,xeogl._apply(t,e))}this.error("Clone failed - component has been destroyed")},_attach:function(t){var e=t.name;if(e){var i=t.component,r=t.sceneDefault,s=t.sceneSingleton,n=t.type,a=t.on,o=!1!==t.recompiles,h=!1;if(i)if(xeogl._isNumeric(i)||xeogl._isString(i)){var l=i;if(!(i=this.scene.components[l]))return void this.error("Component not found: "+xeogl._inQuotes(l))}else if(xeogl._isObject(i)){var u=i,c=u.type||n||"xeogl.Component",d=window[c];if(!d)return void this.error("Component type not found: "+c);if(n&&!xeogl._isComponentType(c,n))return void this.error("Expected a "+n+" type or subtype, not a "+c);i=new d(u),h=!0}if(!i)if(!0===s){var _=this.scene.types[n];for(var f in _)if(_.hasOwnProperty){i=_[f];break}if(!i)return this.error("Scene has no default component for '"+e+"'"),null}else if(!0===r&&!(i=this.scene[e]))return this.error("Scene has no default component for '"+e+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+xeogl._inQuotes(i.id));if(n&&!i.isType(n))return void this.error("Expected a "+n+" type or subtype: "+i.type+" "+xeogl._inQuotes(i.id))}this._attachments||(this._attachments={});var p,g,m,y=this._attached[e];if(y){if(i&&y.id===i.id)return;var v=this._attachments[y.id];for(g=0,m=(p=v.subs).length;g<m;g++)y.off(p[g]);delete this._attached[e],delete this._attachments[y.id];var x=v.params.onDetached;x&&(xeogl._isFunction(x)?x(y):x.scope?x.callback.call(x.scope,y):x.callback(y)),v.managingLifecycle&&y.destroy()}if(i){var b={params:t,component:i,subs:[],managingLifecycle:h};b.subs.push(i.on("destroyed",function(){b.params.component=null,this._attach(b.params)},this)),o&&b.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[e]=i,this._attachments[i.id]=b;var w,M,E,D,S=t.onAttached;if(S&&(xeogl._isFunction(S)?S(i):S.scope?S.callback.call(S.scope,i):S.callback(i)),a)for(w in a)if(a.hasOwnProperty(w)){if(M=a[w],xeogl._isFunction(M)?(E=M,D=null):(E=M.callback,D=M.scope),!E)continue;b.subs.push(i.on(w,E,D))}}return o&&this.fire("dirty",this),this.fire(e,i),i}this.error("Component 'name' expected")},create:function(t,e){var i=this.scene._getSharedComponent(t,e);return i&&(this._sharedComponents||(this._sharedComponents={}),this._sharedComponents[i.id]||(this._sharedComponents[i.id]=i),i.on("destroyed",function(){delete this._sharedComponents[i.id]},this)),i},_scheduleUpdate:function(t){this._updateScheduled||(this._updateScheduled=!0,0===t?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._update&&this._update(),this._updateScheduled=!1)},_update:null,_compile:function(){},_props:{json:{get:function(){var t={type:this.type,id:this.id};return xeogl._isEmptyObject(this.meta)||(t.meta=this.meta),this._getJSON?xeogl._apply(this._getJSON(),t):t}},string:{get:function(){return JSON.stringify(this.json,"\n",4)}},js:{get:function(){var t=this.json;delete t.id;var e=JSON.stringify(t,"\n",4);return"new "+this.type+"("+e+");"}}},destroy:function(){var t,e,i,r,s,n;if(this._attachments)for(t in this._attachments)if(this._attachments.hasOwnProperty(t)){for(i=(e=this._attachments[t]).component,s=0,n=(r=e.subs).length;s<n;s++)i.off(r[s]);e.managingLifecycle&&i.destroy()}if(this._sharedComponents)for(t in this._sharedComponents)this._sharedComponents.hasOwnProperty(t)&&(i=this._sharedComponents[t],delete this._sharedComponents[t],this.scene._putSharedComponent(i));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";var t;xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(t){var e=this,i=!!t.transparent;this._componentIDMap=new xeogl.utils.Map,this.startTime=(new Date).getTime(),this.components={},this.types={},this.entities={},this._sharedComponents={},this._sharedComponentIDs={},this._sharedCounts={},this._dirtyEntities={},this.configs=new xeogl.Configs(this,t.configs),this.canvas=new xeogl.Canvas(this,{canvas:t.canvas,transparent:i,backgroundColor:t.backgroundColor,backgroundImage:t.backgroundImage,webgl2:!1!==t.webgl2,contextAttr:t.contextAttr||{}}),this.canvas.on("boundary",function(){e._renderer.imageDirty=!0}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this.canvas.canvas,this.canvas.gl,{transparent:i}),this.input=new xeogl.Input(this,{element:this.canvas.overlay}),xeogl._addScene(this);var r=t.components;if(r)for(var s,n,a,o=0,h=r.length;o<h;o++)(n=(s=r[o]).type)&&(a=window[n])&&new a(this,s);this._initDefaults(),this.ticksPerRender=t.ticksPerRender,this.passes=t.passes,this.clearEachPass=t.clearEachPass},_initDefaults:function(){this.view,this.project,this.camera,this.clips,this.colorTarget,this.colorBuf,this.depthTarget,this.depthBuf,this.visibility,this.cull,this.modes,this.geometry,this.layer,this.lights,this.material,this.morphTargets,this.reflect,this.shader,this.shaderParams,this.stage,this.transform,this.viewport},_addComponent:function(t){if(t.id){if(this.components[t.id])return void this.error("Component "+xeogl._inQuotes(t.id)+" already exists in Scene")}else t.id=this._componentIDMap.addItem(t);this.components[t.id]=t;var e=t.type,i=this.types[t.type];i||(i=this.types[e]={}),i[t.id]=t,t.on("destroyed",function(){this._componentDestroyed(t)},this),t.isType("xeogl.Entity")&&(t.on("dirty",this._entityDirty,this),this.entities[t.id]=t,this._worldBoundary&&t.worldBoundary.on("updated",this._setWorldBoundaryDirty,this),xeogl.stats.components.entities++),this.fire("componentCreated",t,!0)},_componentDestroyed:function(t){this._componentIDMap.removeItem(t.id),delete this.components[t.id];var e=this.types[t.type];e&&(delete e[t.id],xeogl._isEmptyObject(e)&&delete this.types[t.type]),t.isType("xeogl.Entity")&&(xeogl.stats.components.entities--,delete this.entities[t.id],delete this._dirtyEntities[t.id]),this.fire("componentDestroyed",t,!0)},_entityDirty:function(t){this._dirtyEntities[t.id]||(this._dirtyEntities[t.id]=t)},render:(t={sceneId:null,pass:null},function(e){t.sceneId=this.id;var i,r,s=this._passes,n=this._clearEachPass;for(i=0;i<s;i++)t.pass=i,this.fire("rendering",t,!0),r=n||0===i,this._compile(i,r,e),this.fire("rendered",t,!0)}),_props:{ticksPerRender:{set:function(t){void 0===t||null===t?t=1:(!xeogl._isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._ticksPerRender&&(this._ticksPerRender=t,this.fire("ticksPerRender",this._ticksPerRender))},get:function(){return this._ticksPerRender}},passes:{set:function(t){void 0===t||null===t?t=1:(!xeogl._isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'passes': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._passes&&(this._passes=t,this._renderer.imageDirty=!0,this.fire("passes",this._passes))},get:function(){return this._passes}},clearEachPass:{set:function(t){(t=!!t)!==this._clearEachPass&&(this._clearEachPass=t,this._renderer.imageDirty=!0,this.fire("clearEachPass",this._clearEachPass))},get:function(){return this._clearEachPass}},project:{get:function(){return this.components["default.project"]||new xeogl.Perspective(this,{id:"default.project",isDefault:!0})}},view:{get:function(){return this.components["default.view"]||new xeogl.Lookat(this,{id:"default.view",isDefault:!0})}},camera:{get:function(){return this.components["default.camera"]||new xeogl.Camera(this,{id:"default.camera",isDefault:!0,project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new xeogl.Transform(this,{id:"default.transform",isDefault:!0})}},billboard:{get:function(){return this.components["default.billboard"]||new xeogl.Billboard(this,{id:"default.billboard",active:!1,isDefault:!0})}},stationary:{get:function(){return this.components["default.stationary"]||new xeogl.Stationary(this,{id:"default.stationary",active:!1,isDefault:!0})}},clips:{get:function(){return this.components["default.clips"]||new xeogl.Clips(this,{id:"default.clips",isDefault:!0})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new xeogl.ColorBuf(this,{id:"default.colorBuf",isDefault:!0})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new xeogl.ColorTarget(this,{id:"default.colorTarget",isDefault:!0,active:!1})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new xeogl.DepthBuf(this,{id:"default.depthBuf",isDefault:!0,active:!0})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new xeogl.DepthTarget(this,{id:"default.depthTarget",isDefault:!0,active:!1})}},visibility:{get:function(){return this.components["default.visibility"]||new xeogl.Visibility(this,{id:"default.visibility",isDefault:!0,visible:!0})}},cull:{get:function(){return this.components["default.cull"]||new xeogl.Cull(this,{id:"default.cull",isDefault:!0,culled:!1})}},modes:{get:function(){return this.components["default.modes"]||new xeogl.Modes(this,{id:"default.modes",isDefault:!0})}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},layer:{get:function(){return this.components["default.layer"]||new xeogl.Layer(this,{id:"default.layer",isDefault:!0,priority:0})}},lights:{get:function(){return this.components["default.lights"]||new xeogl.Lights(this,{id:"default.lights",isDefault:!0,lights:[new xeogl.AmbientLight(this,{id:"default.light0",color:[.45,.45,.5],intensity:.9}),new xeogl.DirLight(this,{id:"default.light1",dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new xeogl.DirLight(this,{id:"default.light2",dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new xeogl.MorphTargets(this,{id:"default.morphTargets",isDefault:!0})}},reflect:{get:function(){return this.components["default.reflect"]||new xeogl.Reflect(this,{id:"default.reflect",isDefault:!0})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new xeogl.Shader(this,{id:"default.shader",isDefault:!0})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new xeogl.ShaderParams(this,{id:"default.shaderParams",isDefault:!0})}},stage:{get:function(){return this.components["default.stage"]||new xeogl.Stage(this,{id:"default.stage",priority:0,isDefault:!0})}},viewport:{get:function(){return this.components["default.viewport"]||new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0,isDefault:!0})}},worldBoundary:{get:function(){if(!this._worldBoundary){var t=this,e=xeogl.math.AABB3();this._worldBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return t._worldBoundaryDirty},getAABB:function(){xeogl.math.collapseAABB3(e);var i,r=t.entities;for(var s in r)r.hasOwnProperty(s)&&(i=r[s]).modes.collidable&&xeogl.math.expandAABB3(e,i.worldBoundary.aabb);return e}}),this._worldBoundary.on("destroyed",function(){t._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},pick:function(){var t=xeogl.math,e=t.vec3(),i=t.vec3(),r=t.vec3(),s=t.vec3(),n=t.vec3(),a=t.vec3(),o=t.vec4(),h=t.vec3(),l=t.vec3(),u=t.vec3(),c=t.vec3(),d=t.vec3(),_=t.vec3(),f=t.vec3(),p=t.vec3(),g=t.vec3(),m=t.vec4(),y=t.vec4(),v=t.vec4(),x=t.vec4(),b=(t.vec4(),t.vec3()),w=t.vec3(),M=t.vec3(),E=t.vec3(),D=t.vec3(),S=t.vec3(),C=t.vec3(),k=t.vec3(),T=t.vec3(),B=t.vec3(),A=t.vec3(),F=t.mat4(),P=t.mat4(),L=t.mat4();return function(O){(O=O||{}).pickSurface=O.pickSurface||O.rayPick,O.canvasPos||O.origin&&O.direction||this.warn("picking without canvasPos or ray origin and direction");var R=this._renderer.pick(O);if(R){var U=this.entities[R.entity];if(R.entity=U,O.pickSurface&&void 0!==R.primIndex&&R.primIndex>-1){var N=U.geometry;if("triangles"===N.primitive){R.primitive="triangle";var V,I=R.primIndex,z=N.indices,j=N.positions,Y=z[I],G=z[I+1],K=z[I+2],W=3*Y,H=3*G,X=3*K;a[0]=Y,a[1]=G,a[2]=K,R.indices=a,r[0]=j[W],r[1]=j[W+1],r[2]=j[W+2],s[0]=j[H],s[1]=j[H+1],s[2]=j[H+2],n[0]=j[X],n[1]=j[X+1],n[2]=j[X+2],O.canvasPos?(V=O.canvasPos,R.canvasPos=O.canvasPos,function(e,i,r,s){var n=e.scene.canvas.canvas,a=e.transform.leafMatrix,o=e.camera.view.matrix,h=e.camera.project.matrix,l=t.mulMat4(o,a,F),u=t.mulMat4(h,l,P),c=t.inverseMat4(u,L),d=n.width,_=n.height,f=(i[0]-d/2)/(d/2),p=-(i[1]-_/2)/(_/2);m[0]=f,m[1]=p,m[2]=-1,m[3]=1,t.transformVec4(c,m,y),t.mulVec4Scalar(y,1/y[3]),v[0]=f,v[1]=p,v[2]=1,v[3]=1,t.transformVec4(c,v,x),t.mulVec4Scalar(x,1/x[3]),r[0]=x[0],r[1]=x[1],r[2]=x[2],t.subVec3(x,y,s),t.normalizeVec3(s)}(U,V,e,i)):O.origin&&O.direction&&function(e,i,r,s,n){var a=e.transform.leafMatrix,o=t.inverseMat4(a,F);m[0]=i[0],m[1]=i[1],m[2]=i[2],m[3]=1,t.transformVec4(o,m,y),s[0]=y[0],s[1]=y[1],s[2]=y[2],t.transformVec3(o,r,n)}(U,O.origin,O.direction,e,i),t.normalizeVec3(i),t.rayPlaneIntersect(e,i,r,s,n,o),R.localPos=o,R.position=o,m[0]=o[0],m[1]=o[1],m[2]=o[2],m[3]=1,t.transformVec4(U.transform.leafMatrix,m,y),h[0]=y[0],h[1]=y[1],h[2]=y[2],R.worldPos=h,t.transformVec4(U.camera.view.matrix,y,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],R.viewPos=l,t.cartesianToBarycentric(o,r,s,n,u),R.bary=u;var J=N.normals;if(J){c[0]=J[W],c[1]=J[W+1],c[2]=J[W+2],d[0]=J[H],d[1]=J[H+1],d[2]=J[H+2],_[0]=J[X],_[1]=J[X+1],_[2]=J[X+2];var q=t.addVec3(t.addVec3(t.mulVec3Scalar(c,u[0],b),t.mulVec3Scalar(d,u[1],w),M),t.mulVec3Scalar(_,u[2],E),D);R.normal=t.transformVec3(U.transform.leafMatrix,q,S)}var Q=N.uv;Q&&(f[0]=Q[2*Y],f[1]=Q[2*Y+1],p[0]=Q[2*G],p[1]=Q[2*G+1],g[0]=Q[2*K],g[1]=Q[2*K+1],R.uv=t.addVec3(t.addVec3(t.mulVec2Scalar(f,u[0],C),t.mulVec2Scalar(p,u[1],k),T),t.mulVec2Scalar(g,u[2],B),A))}}return R}}}(),clear:function(){for(var t in this.components)this.components.hasOwnProperty(t)&&this.components[t].destroy();this._initDefaults(),this._dirtyEntities={}},_getSharedComponent:function(t,e){var i,r;if(xeogl._isObject(t)?(i=t.type||"xeogl.Component",r=xeogl[i.substring(6)]):xeogl._isString(t)?(i=t,r=xeogl[i.substring(6)]):(r=t,i=t.prototype.type),r){var s,n;if(xeogl._isComponentType(i,"xeogl.Component"))return void 0!==e&&(n="__shared."+i+"."+e,s=this._sharedComponents[n])?(this._sharedCounts[n]++,s):t&&t.id&&this.components[t.id]?(this.error("Component "+xeogl._inQuotes(t.id)+" already exists in Scene"),null):(s=new r(this,t),void 0!==e&&(this._sharedComponents[n]=s,this._sharedComponentIDs[s.id]=n,this._sharedCounts[n]=1,s.on("destroyed",function(){void 0!==this._sharedComponentIDs[s.id]&&this._putSharedComponent(s)},this)),s);this.error("Expected a xeogl.Component type or subtype")}else this.error("Component type not found: "+i)},_putSharedComponent:function(t){var e=this._sharedComponentIDs[t.id];if(void 0!==e){if(--this._sharedCounts[e]>0)return;delete this._sharedComponents[e],delete this._sharedComponentIDs[t.id],delete this._sharedCounts[e]}t.destroy()},_compile:function(t,e,i){var r;for(var s in this._dirtyEntities)this._dirtyEntities.hasOwnProperty(s)&&(r=this._dirtyEntities[s])._valid()&&(r._compile(),delete this._dirtyEntities[s],0);this._renderer.render({pass:t,clear:e,force:i});var n=this.canvas;if(n.transparent||n.backgroundImage||n.backgroundColor)this._lastAmbientColor=null;else{var a=this._renderer.ambientColor;this._lastAmbientColor&&this._lastAmbientColor[0]===a[0]&&this._lastAmbientColor[1]===a[1]&&this._lastAmbientColor[2]===a[2]&&this._lastAmbientColor[3]===a[3]||(n.backgroundColor=a,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4()),this._lastAmbientColor.set(a))}},_getJSON:function(){var t,e=[];for(var i in this.components)if(this.components.hasOwnProperty(i)){if(!(t=this.components[i])._getJSON)continue;e.unshift(t)}e.sort(function(t,e){return t._componentOrder-e._componentOrder});for(var r=[],s=0,n=e.length;s<n;s++)r.push(e[s].json);return{passes:this._passes,clearEachPass:this._clearEachPass,components:r}},_destroy:function(){this.clear()}})}(),function(){"use strict";xeogl.MorphTargets=xeogl.Component.extend({type:"xeogl.MorphTargets",_init:function(t){this.scene.on("webglContextRestored",function(){}),this.targets=t.targets,this.factor=t.factor},_props:{targets:{set:function(t){},get:function(){}},factor:{set:function(t){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";var t,e,i,r,s,n,a=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(t){this._look1=a.vec3(),this._eye1=a.vec3(),this._up1=a.vec3(),this._look2=a.vec3(),this._eye2=a.vec3(),this._up2=a.vec3(),this._flying=!1,this._flyEyeLookUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=!1!==t.easing,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail,this.camera=t.camera,this._aabbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),this._obbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})})},flyTo:(n=a.vec3(),function(t,e,i){t=t||this.scene,this._flying&&this.stop();var r=this._attached.camera;if(r){this._flying=!1,this._callback=e,this._callbackScope=i;var s,o,h,l,u,c=r.view;if(this._eye1[0]=c.eye[0],this._eye1[1]=c.eye[1],this._eye1[2]=c.eye[2],this._look1[0]=c.look[0],this._look1[1]=c.look[1],this._look1[2]=c.look[2],this._up1[0]=c.up[0],this._up1[1]=c.up[1],this._up1[2]=c.up[2],t.worldBoundary)s=t.worldBoundary.aabb;else if(t.aabb)s=t.aabb;else if(6===t.length)s=t;else if(t.eye||t.look||t.up)o=t.eye,h=t.look,l=t.up;else{var d=t;if((xeogl._isNumeric(d)||xeogl._isString(d))&&(u=d,!(d=this.scene.components[u])))return this.error("Component not found: "+xeogl._inQuotes(u)),void(e&&(i?e.call(i):e()));var _=d.worldBoundary;if(!_)return this.error("Can't fly to component "+xeogl._inQuotes(u)+" - does not have a worldBoundary"),void(e&&(i?e.call(i):e()));s=_.aabb}var f=t.offset;if(s){if(s[3]<=s[0]||s[4]<=s[1]||s[5]<=s[2])return;this._aabbHelper.geometry.aabb=s,this._aabbHelper.visibility.visible=!0;var p=a.getAABB3Center(s);this._look2=t.look||p,f&&(this._look2[0]+=f[0],this._look2[1]+=f[1],this._look2[2]+=f[2]);var g=a.normalizeVec3(a.subVec3(this._eye1,this._look1,n)),m=(t.look,a.getAABB3Diag(s)),y=Math.abs(m/Math.tan((t.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD));this._eye2[0]=this._look2[0]+g[0]*y,this._eye2[1]=this._look2[1]+g[1]*y,this._eye2[2]=this._look2[2]+g[2]*y,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(o||h||l)&&(h=h||this._look1,o=o||this._eye1,l=l||this._up1,this._look2[0]=h[0],this._look2[1]=h[1],this._look2[2]=h[2],this._eye2[0]=o[0],this._eye2[1]=o[1],this._eye2[2]=o[2],this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2],this._flyEyeLookUp=!0);this.fire("started",t,!0),this._time1=Date.now(),this._time2=this._time1+(t.duration?1e3*t.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}else e&&(i?e.call(i):e())}),jumpTo:function(){a.vec3();var t=a.vec3(),e=a.vec3(),i=a.vec3(),r=a.vec3(),s=a.vec3();return function(n){this._flying&&this.stop();var o=this._attached.camera;if(o){var h,l,u,c=o.view;if(n.worldBoundary)l=n.worldBoundary.sphere;else if(n.sphere)l=n.sphere;else if(n.aabb)h=n.aabb;else if(6===n.length)h=n;else if(4===n.length)l=n;else if(n.eye||n.look||n.up)t=n.eye,e=n.look,i=n.up;else{var d=n;if((xeogl._isNumeric(d)||xeogl._isString(d))&&(u=d,!(d=this.scene.components[u])))return void this.error("Component not found: "+xeogl._inQuotes(u));var _=d.worldBoundary;if(!_)return void this.error("Can't jump to component "+xeogl._inQuotes(u)+" - does not have a worldBoundary");l=_.sphere}n.offset;if(h||l){var f,p;if(h){if(h[3]<=h[0]||h[4]<=h[1]||h[5]<=h[2])return;f=a.getAABB3Diag(h),a.getAABB3Center(h,e)}else{if(l[3]<=0)return;f=2*l[3],e[0]=l[0],e[1]=l[1],e[2]=l[2]}this._trail?a.subVec3(c.look,e,r):a.subVec3(c.eye,c.look,r),a.normalizeVec3(r),p=(void 0!==n.fit?n.fit:this._fit)?Math.abs(f/Math.tan((n.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):a.lenVec3(a.subVec3(c.eye,c.look,s)),a.mulVec3Scalar(r,p),c.eye=a.addVec3(e,r,t),c.look=e}else(t||e||i)&&(t&&(c.eye=t),e&&(c.look=e),i&&(c.up=i))}}}(),_update:(t=a.vec3(),e=a.vec3(),i=a.vec3(),r=a.vec3(),s=a.vec3(),function(){if(this._flying){var n=(Date.now()-this._time1)/(this._time2-this._time1),o=n>=1;n>1&&(n=1),n=this.easing?this._ease(n,0,1,1):n;var h,l=this._attached.camera.view;this._flyEyeLookUp?(l.eye=a.lerpVec3(n,0,1,this._eye1,this._eye2,e),l.look=a.lerpVec3(n,0,1,this._look1,this._look2,i),l.up=a.lerpVec3(n,0,1,this._up1,this._up2,r)):(a.lerpVec3(n,0,1,this._look1,this._look2,i),this._trail?a.subVec3(i,l.look,t):a.subVec3(l.eye,l.look,t),a.normalizeVec3(t),a.lerpVec3(n,0,1,this._eye1,this._eye2,e),a.subVec3(e,i,s),h=a.lenVec3(s),a.mulVec3Scalar(t,h),l.eye=a.addVec3(i,t,e),l.look=i),o?this.stop():xeogl.scheduleTask(this._update,this)}}),_ease:function(t,e,i,r){return-i*(t/=r)*(t-2)+e},stop:function(){if(this._flying){this._aabbHelper.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var t=this._callback;t&&(this._callback=null,this._callbackScope?t.call(this._callbackScope):t()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0}),this.stop()},get:function(){return this._attached.camera}},duration:{set:function(t){t=t||.5,this._duration=1e3*t,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(t){this._fit=!1!==t,this.fire("fit",this._fit)},get:function(){return this._fit}},fitFOV:{set:function(t){t=t||45,this._fitFOV=t},get:function(){return this._fitFOV}},trail:{set:function(t){this._trail=!!t,this.fire("trail",this._trail)},get:function(){return this._trail}}},_getJSON:function(){var t={duration:this._duration,fitFOV:this._fitFOV,fit:this._fit,trail:this._trail};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(t){this.project=t.project,this.view=t.view},_props:{project:{set:function(t){this._attach({name:"project",type:"xeogl.Transform",component:t,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("projectMatrix")},scope:this}}})},get:function(){return this._attached.project}},view:{set:function(t){this._attach({name:"view",type:"xeogl.Transform",component:t,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("viewMatrix")},scope:this}}})},get:function(){return this._attached.view}}},_compile:function(){this._renderer.projTransform=this._attached.project._state,this._renderer.viewTransform=this._attached.view._state},_getJSON:function(){return{project:this._attached.project.id,view:this._attached.view.id}}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(t){if(this.canvas=null,this.overlay=null,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!1,t.canvas?xeogl._isString(t.canvas)?(this.canvas=document.getElementById(t.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(t.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=t.canvas:this._createCanvas(),this.canvas){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),this._createOverlay(),this._resizeBackground(),this._resizeOverlay(),this._initWebGL(t);var e=this;this.canvas.addEventListener("webglcontextlost",function(){e.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){e._initWebGL(),e.gl&&e.fire("webglContextRestored",e.gl)},!1);var i=null,r=null,s=null,n=null;this._tick=this.scene.on("tick",function(){var t=e.canvas,a=window.innerWidth!==i||window.innerHeight!==r,o=t.clientWidth!==s||t.clientHeight!==n,h=null!==t.offsetLeft||null!==t.offsetTop;if((a||o||h)&&(e._spinner._adjustPosition(),e._resizeBackground(),e._resizeOverlay(),o)){var l,u=t.clientWidth,c=t.clientHeight,d=0;for(var _ in xeogl.scenes)xeogl.scenes.hasOwnProperty(_)&&(d+=(l=xeogl.scenes[_]).canvas.canvas.clientWidth*l.canvas.canvas.clientHeight);xeogl.stats.memory.pixels=d,t.width=t.clientWidth,t.height=t.clientHeight;var f=e.boundary;f[0]=t.offsetLeft,f[1]=t.offsetTop,f[2]=u,f[3]=c,e.fire("boundary",f),s=u,n=c,i=window.innerWidth,r=window.innerHeight}}),this.canvas.oncontextmenu=function(t){t.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=t.backgroundColor,this.backgroundImage=t.backgroundImage}else this.error("Faied to create canvas")},_createCanvas:function(){var t="xeogl-canvas-"+xeogl.math.createUUID(),e=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r.height="100%",r.width="100%",r.padding="0",r.margin="0",r.background="rgba(0,0,0,0);",r.float="left",r.left="0",r.top="0",r.position="absolute",r.opacity="1.0",r["z-index"]="-10000",i.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',e.appendChild(i),this.canvas=document.getElementById(t)},_createBackground:function(){var t=document.getElementsByTagName("body")[0],e=document.createElement("div"),i=e.style;i.padding="0",i.margin="0",i.background=null,i.backgroundImage=null,i.float="left",i.left="0",i.top="0",i.width="0px",i.height="0px",i.position="absolute",i.opacity=1,i["z-index"]="-20000",t.appendChild(e),this._backgroundElement=e},_createOverlay:function(){var t=document.getElementsByTagName("body")[0],e=document.createElement("div"),i=e.style;i.padding="0",i.margin="0",i.background="black",i.float="left",i.left="0",i.top="0",i.width="0px",i.height="0px",i.position="absolute",i.opacity=0,i["z-index"]="100000",t.appendChild(e),this.overlay=e},_resizeOverlay:function(){if(this.canvas&&this.overlay){var t=this.canvas,e=this.overlay.style,i=this._getElementXY(t);e.left=i.x+"px",e.top=i.y+"px",e.width=t.clientWidth+"px",e.height=t.clientHeight+"px"}},_resizeBackground:function(){if(this.canvas&&this._backgroundElement){var t=this.canvas,e=this._backgroundElement.style,i=this._getElementXY(t);e.left=i.x+"px",e.top=i.y+"px",e.width=t.clientWidth+"px",e.height=t.clientHeight+"px"}},_getElementXY:function(t){for(var e=0,i=0;t;)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;var r=document.body.getBoundingClientRect();return{x:e-r.left,y:i-r.top}},_initWebGL:function(t){if(t.webgl2){try{this.gl=this.canvas.getContext("webgl2",this.contextAttr)}catch(t){}this.gl?this.webgl2=!0:this.warn("Failed to get a WebGL 2 context - defaulting to WebGL 1.")}if(!this.gl)for(var e=0;!this.gl&&e<this._WEBGL_CONTEXT_NAMES.length;e++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[e],this.contextAttr)}catch(t){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},getSnapshot:function(t){if(this.canvas){this.scene.render();var e,i=(t=t||{}).width||this.canvas.width,r=t.height||this.canvas.height,s=t.format||"jpeg";switch(s){case"jpeg":e=Canvas2Image.saveAsJPEG(this.canvas,!0,i,r);break;case"png":e=Canvas2Image.saveAsPNG(this.canvas,!0,i,r);break;case"bmp":e=Canvas2Image.saveAsBMP(this.canvas,!0,i,r);break;default:this.error("Unsupported snapshot format: '"+s+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),e=Canvas2Image.saveAsJPEG(this.canvas,!0,i,r)}return e.src}this.error("Can't get snapshot - no canvas.")},readPixels:function(t,e,i,r){return this.scene._renderer.readPixels(t,e,i,r)},_props:{backgroundColor:{set:function(t){if(t){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(t||[0,0,0,1]),!this._backgroundImageSrc){var e="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=e}}else this._backgroundColor=null;this.fire("backgroundColor",this._backgroundColor)},get:function(){return this._backgroundColor}},backgroundImage:{set:function(t){if(t)if(xeogl._isString(t)){if(t!==this._backgroundImageSrc){if(this._backgroundElement.style.backgroundImage="url('"+t+"')",this._backgroundImageSrc=t,!this._backgroundImageSrc){var e="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=e}this.fire("backgroundImage",this._backgroundImageSrc)}}else this.error("Value for 'backgroundImage' should be a string")},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";var t=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(t){this._canvas=t.canvas,this._injectSpinnerCSS();var e=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r["z-index"]="9000",r.position="absolute",i.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',e.appendChild(i),this._element=i,this._adjustPosition(),this.processes=0,this.textures=t.textures},_props:{textures:{set:function(t){t=!1!==t,this._textures=t,this.fire("textures",this._textures)},get:function(){return this._textures}},processes:{set:function(t){t=t||0,this._processes!==t&&(t<0||(this._processes=t,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes)))},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var t=this._canvas,e=this._element,i=e.style;i.left=t.offsetLeft+.5*t.clientWidth-.5*e.clientWidth+"px",i.top=t.offsetTop+.5*t.clientHeight-.5*e.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!t){var e=document.createElement("style");e.innerHTML=this._spinnerCSS,document.body.appendChild(e),t=!0}},_spinnerCSS:".sk-fading-circle {        margin: 100px auto;        width: 100px;        height:100px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(t){this._state={mode:"disabled",dir:[1,0,0],dist:1},this.mode=t.mode,this.dir=t.dir,this.dist=t.dist},_props:{mode:{set:function(t){this._state.mode=t||"disabled",this._renderer.imageDirty=!0,this.fire("mode",this._state.mode)},get:function(){return this._state.mode}},dir:{set:function(t){this._state.dir=t||xeogl.math.vec3([1,0,0]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},dist:{set:function(t){this._state.dist=void 0!==t?t:1,this._renderer.imageDirty=!0,this.fire("dist",this._state.dist)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this._state.mode,dir:this._state.dir,dist:this._state.dist}}})}(),function(){"use strict";xeogl.Clips=xeogl.Component.extend({type:"xeogl.Clips",_init:function(t){this._state=new xeogl.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=t.clips},_props:{clips:{set:function(t){var e,i,r,s;for(t=t||[],i=0,r=this._clips.length;i<r;i++)(e=this._clips[i]).off(this._dirtySubs[i]),e.off(this._destroyedSubs[i]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];var n=this;function a(){n.fire("dirty",!0)}function o(){for(var t=this.id,e=0,i=n._clips.length;e<i;e++)if(n._clips[e].id===t)return n._clips=n._clips.slice(e,e+1),n._dirtySubs=n._dirtySubs.slice(e,e+1),n._destroyedSubs=n._destroyedSubs.slice(e,e+1),n._dirty=!0,n.fire("dirty",!0),void n.fire("clips",n._clips)}for(i=0,r=t.length;i<r;i++)e=t[i],!xeogl._isString(e)||(s=e,e=this.components[s])?"xeogl.Clip"===e.type?(this._clips.push(e),this._dirtySubs.push(e.on("dirty",a)),this._destroyedSubs.push(e.on("destroyed",o))):this.error("Component "+xeogl._inQuotes(s)+" is not a xeogl.Clip"):this.error("Component not found: "+xeogl._inQuotes(s));this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var t=this._state;if(this._dirty){t.clips=[];for(var e=0,i=this._clips.length;e<i;e++)t.clips.push(this._clips[e]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=t},_makeHash:function(){var t,e=this._state.clips;if(0===e.length)return";";for(var i=[],r=0,s=e.length;r<s;r++)t=e[r],i.push(t._state.mode);i.push(";"),this._state.hash=i.join("")},_getJSON:function(){for(var t=[],e=0,i=this._clips.length;e<i;e++)t.push(this._clips[e].id);return{clips:t}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Configs=xeogl.Component.extend({type:"xeogl.Configs",_init:function(t){for(var e in this.props={},t)t.hasOwnProperty(e)&&this.set(e,t[e])},set:function(t,e){this.props[t]=e,this.fire(t,e)},_toJSON:function(){return xeogl._copy(this.props)}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",exclusive:!0,_init:function(t){this.scene;this._boundaryHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),this.keyboardAxis=this.create(xeogl.KeyboardAxisCamera,{camera:t.camera}),this.keyboardRotate=this.create(xeogl.KeyboardRotateCamera,{camera:t.camera}),this.mouseRotate=this.create(xeogl.MouseRotateCamera,{camera:t.camera}),this.keyboardPan=this.create(xeogl.KeyboardPanCamera,{camera:t.camera}),this.mousePan=this.create(xeogl.MousePanCamera,{camera:t.camera}),this.keyboardZoom=this.create(xeogl.KeyboardZoomCamera,{camera:t.camera}),this.mouseZoom=this.create(xeogl.MouseZoomCamera,{camera:t.camera}),this.mousePickEntity=this.create(xeogl.MousePickEntity,{pickSurface:!0}),this.mousePickEntity.on("pick",this._entityPicked,this),this.mousePickEntity.on("nopick",function(){}),this.cameraFlight=this.create(xeogl.CameraFlightAnimation,{camera:t.camera,duration:.5}),this.firstPerson=t.firstPerson,this.camera=t.camera,this.active=!1!==t.active},_entityPicked:function(t){var e;t.worldPos&&(e=t.worldPos);var i=t.entity.worldBoundary,r=i.aabb;i.sphere;if(this._boundaryHelper.geometry.aabb=r,e){var s=this.camera.view;xeogl.math.subVec3(s.eye,s.look,[]);this.cameraFlight.flyTo({look:e,aabb:r},this._hideEntityBoundary,this)}else this.cameraFlight.flyTo({aabb:r},this._hideEntityBoundary,this)},_hideEntityBoundary:function(){this._boundaryHelper.visibility.visible=!1},_props:{firstPerson:{set:function(t){t=!!t,this._firstPerson=t,this.keyboardRotate.firstPerson=t,this.mouseRotate.firstPerson=t,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0,onAdded:this._transformUpdated,onAddedScope:this});var e=this._attached.camera;this.keyboardAxis.camera=e,this.keyboardRotate.camera=e,this.mouseRotate.camera=e,this.keyboardPan.camera=e,this.mousePan.camera=e,this.keyboardZoom.camera=e,this.mouseZoom.camera=e,this.cameraFlight.camera=e},get:function(){return this._attached.camera}},active:{set:function(t){t=!!t,this._active!==t&&(this.keyboardAxis.active=t,this.keyboardRotate.active=t,this.mouseRotate.active=t,this.keyboardPan.active=t,this.mousePan.active=t,this.keyboardZoom.active=t,this.mouseZoom.active=t,this.mousePickEntity.active=t,this.cameraFlight.active=t,this.fire("active",this._active=t))},get:function(){return this._active}}},_getJSON:function(){var t={firstPerson:this._firstPerson,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.CameraController=xeogl.Component.extend({type:"xeogl.CameraController",_init:function(t){this.camera=t.camera,this.active=!1!==t.active},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0,onAddedScope:this})},get:function(){return this._attached.camera}},active:{set:function(t){t=!!t,this._active!==t&&(this._active=t,this.fire("active",this._active))},get:function(){return this._active}}},_getJSON:function(){var t={active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardAxisCamera=xeogl.Component.extend({type:"xeogl.KeyboardAxisCamera",_init:function(t){this._onKeyDown=null,this._cameraFly=new xeogl.CameraFlightAnimation(this.scene,{duration:1}),this.camera=t.camera,this.active=!1!==t.active},_props:{camera:{set:function(t){var e=this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0});this._cameraFly.camera=e},get:function(){return this._attached.camera}},active:{set:function(t){if(t=!!t,this._active!==t){this._cameraFly.active=t;var e=this,i=this.scene.input;t?this._onKeyDown=i.on("keydown",function(t){e._attached.camera&&i.mouseover&&(t!==i.KEY_NUM_1&&t!==i.KEY_NUM_2&&t!==i.KEY_NUM_3&&t!==i.KEY_NUM_4&&t!==i.KEY_NUM_5&&t!==i.KEY_NUM_6||xeogl.scheduleTask(function(){e._fly(t)}))}):this.scene.off(this._onKeyDown),this.fire("active",this._active=t)}},get:function(){return this._active}}},_fly:function(t){var e=this.scene.input,i=this.scene.worldBoundary,r=i.aabb,s=i.center,n=xeogl.math.getAABB3Diag(r);this._fitFOV=55;var a=Math.abs(n/Math.tan(this._fitFOV/2));switch(t){case e.KEY_NUM_1:this._cameraFly.flyTo({look:s,eye:[s[0]-a,s[1],s[2]],up:[0,1,0]});break;case e.KEY_NUM_2:this._cameraFly.flyTo({look:s,eye:[s[0],s[1],s[2]+a],up:[0,1,0]});break;case e.KEY_NUM_3:this._cameraFly.flyTo({look:s,eye:[s[0]+a,s[1],s[2]],up:[0,1,0]});break;case e.KEY_NUM_4:this._cameraFly.flyTo({look:s,eye:[s[0],s[1],s[2]-a],up:[0,1,0]});break;case e.KEY_NUM_5:this._cameraFly.flyTo({look:s,eye:[s[0],s[1]-a,s[2]],up:[0,0,-1]});break;case e.KEY_NUM_6:this._cameraFly.flyTo({look:s,eye:[s[0],s[1]+a,s[2]],up:[0,0,1]})}},_getJSON:function(){var t={active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";xeogl.KeyboardRotateCamera=xeogl.Component.extend({type:"xeogl.KeyboardRotateCamera",_init:function(t){this._onTick=null,this.camera=t.camera,this.active=!1!==t.active,this.sensitivity=t.sensitivity},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(t){this._sensitivity=t||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(t){t=!!t,this._firstPerson=t,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(t){if(this._active!==t){var e=this.scene.input;if(t){var i=this;this._onTick=this.scene.on("tick",function(t){var r=i._attached.camera;if(r&&e.mouseover){var s=t.deltaTime,n=.3*i._sensitivity,a=.3*i._sensitivity;if(!e.ctrlDown&&!e.altDown){var o=e.keyDown[e.KEY_LEFT_ARROW],h=e.keyDown[e.KEY_RIGHT_ARROW],l=e.keyDown[e.KEY_UP_ARROW],u=e.keyDown[e.KEY_DOWN_ARROW];if(o||h||l||u){var c=0,d=0;h?c=-s*n:o&&(c=s*n),u?d=s*a:l&&(d=-s*a),Math.abs(c)>Math.abs(d)?d=0:c=0,0!==c&&r.view.rotateEyeY(c),0!==d&&r.view.rotateEyeX(d)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=t)}},get:function(){return this._active}}},_getJSON:function(){var t={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardPanCamera=xeogl.Component.extend({type:"xeogl.KeyboardPanCamera",_init:function(t){this._onTick=null,this.camera=t.camera,this.sensitivity=t.sensitivity,this.active=!1!==t.active},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(t){this._sensitivity=t||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(t){if(this._active!==t){var e=this.scene.input;if(t){var i=this;this._onTick=this.scene.on("tick",function(t){var r=i._attached.camera;if(r&&e.mouseover){var s=t.deltaTime;if(!e.ctrlDown&&!e.altDown){var n=e.keyDown[e.KEY_W],a=e.keyDown[e.KEY_S],o=e.keyDown[e.KEY_A],h=e.keyDown[e.KEY_D],l=e.keyDown[e.KEY_Z],u=e.keyDown[e.KEY_X];if(n||a||o||h||u||l){var c=0,d=0,_=0,f=.01*i._sensitivity;a?d=s*f:n&&(d=-s*f),h?c=s*f:o&&(c=-s*f),u?_=s*f:l&&(_=-s*f),r.view.pan([c,d,_])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=t)}},get:function(){return this._active}}},_getJSON:function(){var t={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardZoomCamera=xeogl.Component.extend({type:"xeogl.KeyboardZoomCamera",_init:function(t){this._onTick=null,this.camera=t.camera,this.sensitivity=t.sensitivity,this.active=!1!==t.active},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(t){this._sensitivity=t||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(t){if(this._active!==t){var e=this.scene.input;if(t){var i=this;this._onTick=this.scene.on("tick",function(t){var r=i._attached.camera;if(r&&e.mouseover){var s=t.deltaTime;if(!e.ctrlDown&&!e.altDown){var n=e.keyDown[e.KEY_ADD],a=e.keyDown[e.KEY_SUBTRACT];if(n||a){var o=0,h=.01*i.sensitivity;a?o=s*h:n&&(o=-s*h),r.view.zoom(o)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=t)}},get:function(){return this._active}}},_getJSON:function(){var t={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseRotateCamera=xeogl.Component.extend({type:"xeogl.MouseRotateCamera",_init:function(t){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=t.camera,this.sensitivity=t.sensitivity,this.active=!1!==t.active},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(t){this._sensitivity=t||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(t){t=!!t,this._firstPerson=t,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(t){if(this._active!==t){var e=this.scene.input;if(t){var i,r,s,n=!1,a=!1;this._onMouseDown=e.on("mousedown",function(t){e.mouseover&&(0,0,a&&(!e.mouseDownLeft||e.mouseDownRight||e.keyDown[e.KEY_SHIFT]||e.mouseDownMiddle?n=!1:(n=!0,i=t[0],r=t[1])))},this),this._onMouseUp=e.on("mouseup",function(){n=!1,0,0}),this._onMouseEnter=e.on("mouseenter",function(){a=!0,0,0}),this._onMouseLeave=e.on("mouseleave",function(){a=!1,0,0}),this._onMouseMove=e.on("mousemove",function(t){if(a&&n){var e=(t[0]-i)*this._sensitivity,o=(t[1]-r)*this._sensitivity;i=t[0],r=t[1];var h=this._attached.camera;h&&a&&n&&(0!==e&&(s=-e*this._sensitivity,this._firstPerson?h.view.rotateLookY(s):h.view.rotateEyeY(s)),0!==o&&(s=o*this._sensitivity,this._firstPerson?h.view.rotateLookX(-s):h.view.rotateEyeX(s)))}},this)}else e.off(this._onTick),e.off(this._onMouseDown),e.off(this._onMouseUp),e.off(this._onMouseMove),e.off(this._onMouseEnter),e.off(this._onMouseLeave);this.fire("active",this._active=t)}},get:function(){return this._active}}},_getJSON:function(){var t={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePanCamera=xeogl.Component.extend({type:"xeogl.MousePanCamera",_init:function(t){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=t.camera,this.sensitivity=t.sensitivity,this.active=!1!==t.active},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(t){this._sensitivity=t?.03*t:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(t){if(this._active!==t){var e=this.scene.input;if(t){var i,r,s=0,n=0,a=!1,o=this;this._onTick=this.scene.on("tick",function(){var t=o._attached.camera;t&&(0===s&&0===n||(t.view.pan([s,n,0]),s=0,n=0))}),this._onMouseDown=e.on("mousedown",function(t){e.mouseDownLeft&&e.mouseDownRight||e.mouseDownLeft&&e.keyDown[e.KEY_SHIFT]||e.mouseDownMiddle?(i=t[0],r=t[1],a=!0):a=!1}),this._onMouseUp=e.on("mouseup",function(){a=!1}),this._onMouseUp=e.on("mouseout",function(){a=!1}),this._onMouseMove=e.on("mousemove",function(t){a&&(s+=(t[0]-i)*o._sensitivity,n+=(t[1]-r)*o._sensitivity,i=t[0],r=t[1])})}else e.off(this._onTick),e.off(this._onMouseDown),e.off(this._onMouseUp),e.off(this._onMouseMove);this.fire("active",this._active=t)}},get:function(){return this._active}}},_getJSON:function(){var t={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePickEntity=xeogl.Component.extend({type:"xeogl.MousePickEntity",_init:function(t){this.pickSurface=t.pickSurface,this.active=!1!==t.active},_props:{active:{set:function(t){if(this._active!==t){var e=this.scene.input;if(t){var i,r,s=this,n=!1,a=!1;this._onMouseEnter=e.on("mouseenter",function(){n=!0}),this._onMouseLeave=e.on("mouseleave",function(){n=!1}),this._onMouseDown=e.on("mousedown",function(t){n&&(a=!0,i=t[0],r=t[1])}),this._onMouseUp=e.on("mouseup",function(t){if(a&&n){if(i>=t[0]-2&&i<=t[0]+2&&r>=t[1]-2&&r<=t[1]+2){var e=s.scene.pick({canvasPos:t,pickSurface:s._pickSurface});e?s.fire("pick",e):s.fire("nopick",{canvasPos:t})}a=!1}})}else e.off(this._onMouseDown),e.off(this._onMouseUp);this.fire("active",this._active=t)}},get:function(){return this._active}},pickSurface:{set:function(t){t=!!t,this._pickSurface!==t&&(this._dirty=!1,this.fire("pickSurface",this._pickSurface=t))},get:function(){return this._pickSurface}}},_getJSON:function(){return{pickSurface:this._pickSurface,active:this._active}},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseZoomCamera=xeogl.Component.extend({type:"xeogl.MouseZoomCamera",_init:function(t){this._onTick=null,this._onMouseWheel=null,this.camera=t.camera,this.sensitivity=t.sensitivity,this.active=!1!==t.active},_props:{camera:{set:function(t){this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(t){this._sensitivity=t||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(t){if(this._active!==t){if(t){var e=0,i=0,r=!1,s=!1,n=0,a=xeogl.math.vec3(),o=xeogl.math.vec3(),h=xeogl.math.vec3(),l=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(t){0===(e=t)?(s=!1,r=!1):r=!0}),this._onTick=this.scene.on("tick",function(){var t=l._attached.camera;if(t){var u=t.view.eye,c=t.view.look;a[0]=u[0],a[1]=u[1],a[2]=u[2],o[0]=c[0],o[1]=c[1],o[2]=c[2],xeogl.math.subVec3(a,o,h);var d=Math.abs(xeogl.math.lenVec3(h)),_=l._sensitivity*(2+d/1e3);r&&(i=e*_,n=0,r=!1,s=!0),s&&(e>0?(n+=.2*_)>i&&(s=!1):e<0&&(n-=.2*_)<i&&(s=!1),s&&(t.view.zoom(n),t.project.isType("xeogl.Ortho")))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=t)}},get:function(){return this._active}}},_getJSON:function(){var t={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(t.camera=this._attached.camera.id),t},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.Cull=xeogl.Component.extend({type:"xeogl.Cull",_init:function(t){this._state=new xeogl.renderer.Cull({culled:!0}),this.culled=t.culled},_props:{culled:{set:function(t){(t=!!t)!==this._state.culled&&(this._state.culled=t,this._renderer.imageDirty=!0,this.fire("culled",this._state.culled))},get:function(){return this._state.culled}}},_compile:function(){this._renderer.cull=this._state},_getJSON:function(){return{culled:this.culled}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Visibility=xeogl.Component.extend({type:"xeogl.Visibility",_init:function(t){this._state=new xeogl.renderer.Visibility({visible:!0}),this.visible=t.visible},_props:{visible:{set:function(t){this._state.visible=!1!==t,this._renderer.imageDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.visibility=this._state},_getJSON:function(){return{visible:this.visible}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(t){var e=this;if(this._state=new xeogl.renderer.Geometry({primitive:null,primitiveName:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null,hash:"",getTangents:function(){return e._tangentsDirty&&e._buildTangents(),e._tangents},getPickPositions:function(){return e._pickVBOsDirty&&e._buildPickVBOs(),e._pickPositions},getPickColors:function(){return e._pickVBOsDirty&&e._buildPickVBOs(),e._pickColors}}),this._positionsData=null,this._colorsData=null,this._normalsData=null,this._uvData=null,this._tangentsData=null,this._indicesData=null,this._tangents=null,this._pickPositions=null,this._pickColors=null,this._updateScheduled=!1,this._geometryUpdateScheduled=!1,this._hashDirty=!0,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._pickVBOsDirty=!0,this._localBoundary=null,this._boundaryDirty=!0,t.positions||t.normals||t.uv||t.indices)if((!t.primitive||"line-strip"===t.primitive)&&t.positions&&!t.indices){for(var i=[],r=0,s=t.positions.length/3;r<s;r++)i.push(r);this.primitive="line-strip",this.positions=t.positions,this.indices=i}else this.primitive=t.primitive,this.positions=t.positions,this.colors=t.colors,this.normals=t.normals,this.uv=t.uv,this.tangents=t.tangents,this.indices=t.indices;else this.primitive=t.primitive;this.autoNormals=t.autoNormals,this.usage=t.usage,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._scheduleGeometryUpdate,this),xeogl.stats.memory.meshes++},_scheduleUpdate:function(){this._updateScheduled||(this._updateScheduled=!0,xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._geometryUpdateScheduled=!0,this._update&&this._update(),this._updateScheduled=!1),this._geometryUpdateScheduled&&this._updateGeometry()},_scheduleGeometryUpdate:function(){this._geometryUpdateScheduled||(this._geometryUpdateScheduled=!0,xeogl.scheduleTask(this._updateGeometry,this))},_updateGeometry:function(){if(this._updateScheduled)this._update&&(this._geometryUpdateScheduled=!0,this._update()),this._updateScheduled=!1,this._geometryUpdateScheduled=!0;else if(!this._geometryUpdateScheduled)return;var t=this.scene.canvas.gl;switch(this._state.primitiveName){case"points":this._state.primitive=t.POINTS;break;case"lines":this._state.primitive=t.LINES;break;case"line-loop":this._state.primitive=t.LINE_LOOP;break;case"line-strip":this._state.primitive=t.LINE_STRIP;break;case"triangles":this._state.primitive=t.TRIANGLES;break;case"triangle-strip":this._state.primitive=t.TRIANGLE_STRIP;break;case"triangle-fan":this._state.primitive=t.TRIANGLE_FAN;break;default:this._state.primitive=t.TRIANGLES}var e=t.STATIC_DRAW,i=xeogl.stats.memory;this._positionsDirty&&(this._state.positions&&(i.positions-=this._state.positions.numItems,this._state.positions.destroy()),this._state.positions=this._positionsData?new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,this._positionsData,this._positionsData.length,3,e):null,this._state.positions&&(i.positions+=this._state.positions.numItems),this._positionsDirty=!1,this._pickVBOsDirty=!0),this._colorsDirty&&(this._state.colors&&(i.colors-=this._state.colors.numItems,this._state.colors.destroy()),this._state.colors=this._colorsData?new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,this._colorsData,this._colorsData.length,4,e):null,this._state.colors&&(i.colors+=this._state.colors.numItems),this._colorsDirty=!1),this._normalsDirty&&(this._state.normals&&(i.normals-=this._state.normals.numItems,this._state.normals.destroy()),this._autoNormals&&this._positionsData&&this._indicesData&&(this._normalsData=xeogl.math.buildNormals(this._positionsData,this._indicesData)),this._state.normals=this._normalsData?new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,this._normalsData,this._normalsData.length,3,e):null,this._state.normals&&(i.normals+=this._state.normals.numItems),this._normalsDirty=!1,this._tangentsDirty=!0),this._uvDirty&&(this._state.uv&&(i.uvs-=this._state.uv.numItems,this._state.uv.destroy()),this._state.uv=this._uvData?new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,this._uvData,this._uvData.length,2,e):null,this._state.uv&&(i.uvs+=this._state.uv.numItems),this._uvDirty=!1,this._tangentsDirty=!0),this._indicesDirty&&(this._state.indices&&(i.indices-=this._state.indices.numItems,this._state.indices.destroy()),this._state.indices=this._indicesData?new xeogl.renderer.webgl.ArrayBuffer(t,t.ELEMENT_ARRAY_BUFFER,this._indicesData,this._indicesData.length,1,e):null,this._state.indices&&(i.indices+=this._state.indices.numItems),this._indicesDirty=!1,this._pickVBOsDirty=!0),this._geometryUpdateScheduled=!1,this._setBoundaryDirty()},_buildTangents:function(){if(this._tangentsDirty){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate();var t=xeogl.stats.memory;if(this._tangents&&(t.tangents-=this._tangents.numItems,this._tangents.destroy()),!this._positionsData||!this._indicesData||!this._uvData)return null;this._tangentsData=xeogl.math.buildTangents(this._positionsData,this._indicesData,this._uvData);var e=this.scene.canvas.gl,i=e.STATIC_DRAW;this._tangents=this._tangentsData?new xeogl.renderer.webgl.ArrayBuffer(e,e.ARRAY_BUFFER,this._tangentsData,this._tangentsData.length,3,i):null,this._tangents&&(t.tangents+=this._tangents.numItems),this._tangentsDirty=!1}},_buildPickVBOs:function(){if(this._pickVBOsDirty){if((this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._destroyPickVBOs(),this._positionsData&&this._indicesData){var t=this.scene.canvas.gl,e=t.STATIC_DRAW,i=xeogl.math.buildPickTriangles(this._positionsData,this._indicesData),r=i.positions,s=i.colors;this._pickPositions=new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,r,r.length,3,e),this._pickColors=new xeogl.renderer.webgl.ArrayBuffer(t,t.ARRAY_BUFFER,s,s.length,4,e);var n=xeogl.stats.memory;n.positions+=this._pickPositions.numItems,n.colors+=this._pickColors.numItems}this._pickVBOsDirty=!1}},_destroyPickVBOs:function(){var t=xeogl.stats.memory;this._pickPositions&&(this._pickPositions.destroy(),t.positions-=this._pickPositions.numItems,this._pickPositions=null),this._pickColors&&(this._pickColors.destroy(),t.colors-=this._pickColors.numItems,this._pickColors=null),this._pickVBOsDirty=!0},_props:{usage:{set:function(t){"static"!==(t=t||"static")&&"dynamic"!==t&&"stream"!==t&&(this.error("Unsupported value for 'usage': '"+t+"' - supported values are 'static', 'dynamic' and 'stream'."),t="static"),this._state.usageName=t,this._scheduleGeometryUpdate(),this.fire("dirty",!0),this.fire("usage",this._state.usageName)},get:function(){return this._state.usageName}},primitive:{set:function(t){"points"!==(t=t||"triangles")&&"lines"!==t&&"line-loop"!==t&&"line-strip"!==t&&"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t&&(this.error("Unsupported value for 'primitive': '"+t+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),t="triangles"),this._state.primitiveName!==t&&(this._state.primitiveName=t,this._scheduleGeometryUpdate(),this._hashDirty=!0,this.fire("dirty",!0),this.fire("primitive",this._state.primitiveName))},get:function(){return this._state.primitiveName}},positions:{set:function(t){var e=!this._positionsData!=!t;t&&t.constructor!=Float32Array&&(t=new Float32Array(t)),this._positionsData=t,this._positionsDirty=!0,this._scheduleGeometryUpdate(),e&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("positions",this._positionsData),this.fire("localBoundary",!0),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._positionsData}},normals:{set:function(t){var e=!this._normalsData!=!t;t&&t.constructor!=Float32Array&&(t=new Float32Array(t)),this._normalsData=t,this._normalsDirty=!0,this._scheduleGeometryUpdate(),e&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire(" normals",this._normalsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._normalsData}},uv:{set:function(t){var e=!this._uvData!=!t;t&&t.constructor!=Float32Array&&(t=new Float32Array(t)),this._uvData=t,this._uvDirty=!0,this._scheduleGeometryUpdate(),e&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("uv",this._uvData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._uvData}},colors:{set:function(t){var e=!this._colorsData!=!t;t&&t.constructor!=Float32Array&&(t=new Float32Array(t)),this._colorsData=t,this._colorsDirty=!0,this._scheduleGeometryUpdate(),e&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("colors",this._colorsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._colorsData}},indices:{set:function(t){var e=!this._indicesData&&!t;if(t){var i=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(!i&&t.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");var r=i?Uint32Array:Uint16Array;t.constructor!=Uint16Array&&t.constructor!=Uint32Array&&(t=new r(t))}this._indicesData=t,this._indicesDirty=!0,this._scheduleGeometryUpdate(),e&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("indices",this._indicesData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._indicesData}},localBoundary:{get:function(){if(!this._localBoundary){var t=this;this._localBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return!!t._boundaryDirty&&(t._boundaryDirty=!1,!0)},getPositions:function(){return(t._updateScheduled||t._geometryUpdateScheduled)&&t._doUpdate(),t._positionsData}}),this._localBoundary.on("destroyed",function(){t._localBoundary=null})}return this._localBoundary}},autoNormals:{set:function(t){t=!!t,this._autoNormals!==t&&(this._autoNormals=t,this._normalsDirty=!0,this._scheduleGeometryUpdate(),this.fire("autoNormals",this._autoNormals))},get:function(){return this._autoNormals}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._localBoundary&&this._localBoundary.fire("updated",!0))},_compile:function(){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.geometry=this._state},_makeHash:function(){var t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positions&&e.push("0"),t.colors&&e.push("1"),t.normals&&e.push("2"),t.uv&&e.push("3"),e.push(";"),t.hash=e.join("")},_getJSON:function(){return(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),{primitive:this._state.primitiveName,positions:this._positionsData,normals:this._normalsData,uv:this._uvData,colors:this._colorsData,indices:this._indicesData}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),this._state.uv&&this._state.uv.destroy(),this._state.indices&&this._state.indices.destroy(),this._tangentsData&&this._tangentsData.destroy(),this._pickPositions&&this._pickPositions.destroy(),this._pickColors&&this._pickColors.destroy(),this._localBoundary&&this._localBoundary.destroy(),this._state.destroy(),xeogl.stats.memory.meshes--}})}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(t){this._super(t),this.center=t.center,this.xSize=t.xSize,this.ySize=t.ySize,this.zSize=t.zSize},_update:function(){var t=-this._xSize+this._center[0],e=-this._ySize+this._center[1],i=-this._zSize+this._center[2],r=this._xSize+this._center[0],s=this._ySize+this._center[1],n=this._zSize+this._center[2];this.positions=[r,s,n,t,s,n,t,e,n,r,e,n,r,s,n,r,e,n,r,e,i,r,s,i,r,s,n,r,s,i,t,s,i,t,s,n,t,s,n,t,s,i,t,e,i,t,e,n,t,e,i,r,e,i,r,e,n,t,e,n,r,e,i,t,e,i,t,s,i,r,s,i],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.tangents=null},_props:{center:{set:function(t){(this._center=this._center||new xeogl.math.vec3).set(t||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(t){t=t||1,this._xSize!==t&&(t<0&&(this.warn("negative xSize not allowed - will invert"),t*=-1),this._xSize=t,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(t){t=t||1,this._ySize!==t&&(t<0&&(this.warn("negative ySize not allowed - will invert"),t*=-1),this._ySize=t,this._scheduleUpdate(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},zSize:{set:function(t){t=t||1,this._zSize!==t&&(t<0&&(this.warn("negative zSize not allowed - will invert"),t*=-1),this._zSize=t,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}}},_getJSON:function(){return{center:this._center.slice(),xSize:this._xSize,ySize:this._ySize,zSize:this._zSize}}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(t){this._super(t),this.lod=t.lod,this.center=t.center,this.radius=t.radius,this.tube=t.tube,this.radialSegments=t.radialSegments,this.tubeSegments=t.tubeSegments,this.arc=t.arc},_update:function(){var t=this._center[0],e=this._center[1],i=this._center[2],r=this._radius,s=this._tube,n=Math.floor(this._radialSegments*this._lod),a=Math.floor(this._tubeSegments*this._lod),o=this._arc;n<4&&(n=4),a<4&&(a=4);var h,l,u,c,d,_,f,p,g,m,y,v,x,b,w=[],M=[],E=[],D=[];for(m=0;m<=n;m++)for(g=0;g<=a;g++)h=g/a*o,l=m/n*Math.PI*2,u=r*Math.cos(h),c=r*Math.sin(h),d=(r+s*Math.cos(l))*Math.cos(h),_=(r+s*Math.cos(l))*Math.sin(h),f=s*Math.sin(l),w.push(d+t),w.push(_+e),w.push(f+i),E.push(1-g/a),E.push(1-m/n),p=xeogl.math.normalizeVec3(xeogl.math.subVec3([d,_,f],[u,c,0],[]),[]),M.push(p[0]),M.push(p[1]),M.push(p[2]);for(m=1;m<=n;m++)for(g=1;g<=a;g++)y=(a+1)*m+g-1,v=(a+1)*(m-1)+g-1,x=(a+1)*(m-1)+g,b=(a+1)*m+g,D.push(y),D.push(v),D.push(x),D.push(x),D.push(b),D.push(y);this.positions=w,this.normals=M,this.uv=E,this.indices=D},_props:{lod:{set:function(t){t=void 0!==t?t:1,this._lod!==t&&((t<0||t>1)&&(this.warn("clamping lod to [0..1]"),t=t<0?0:1),this._lod=t,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(t){(this._center=this._center||new xeogl.math.vec3).set(t||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(t){t=t||1,this._radius!==t&&(t<0&&(this.warn("negative radius not allowed - will invert"),t*=-1),this._radius=t,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},tube:{set:function(t){t=t||.3,this._tube!==t&&(t<0&&(this.warn("negative tube not allowed - will invert"),t*=-1),this._tube=t,this._scheduleUpdate(),this.fire("tube",this._tube))},get:function(){return this._tube}},radialSegments:{set:function(t){t=t||32,this._radialSegments!==t&&(t<0&&(this.warn("negative radialSegments not allowed - will invert"),t*=-1),this._radialSegments=t,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},tubeSegments:{set:function(t){t=t||24,this._tubeSegments!==t&&(t<0&&(this.warn("negative tubeSegments not allowed - will invert"),t*=-1),this._tubeSegments=t,this._scheduleUpdate(),this.fire("tubeSegments",this._tubeSegments))},get:function(){return this._tubeSegments}},arc:{set:function(t){t=t||2*Math.PI,this._arc!==t&&(t<0&&(this.warn("negative arc not allowed - will invert"),t*=-1),this._arc=t,this._scheduleUpdate(),this.fire("arc",this._arc))},get:function(){return this._arc}}},_getJSON:function(){return{center:this._center.slice(),radius:this._radius,tube:this._tube,radialSegments:this._radialSegments,tubeSegments:this._tubeSegments,arc:this._arc}}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(t){this._super(t),this.lod=t.lod,this.center=t.center,this.radius=t.radius,this.heightSegments=t.heightSegments,this.widthSegments=t.widthSegments},_update:function(){var t=this._radius,e=Math.floor(this._lod*this._heightSegments),i=Math.floor(this._lod*this._widthSegments);e<18&&(e=18),i<18&&(i=18);var r,s,n,a,o,h,l,u,c,d,_,f,p,g,m=[],y=[],v=[],x=[],b=this._center[0],w=this._center[1],M=this._center[2];for(r=0;r<=e;r++)for(n=r*Math.PI/e,a=Math.sin(n),o=Math.cos(n),s=0;s<=i;s++)h=2*s*Math.PI/i,l=Math.sin(h),u=Math.cos(h)*a,c=o,d=l*a,_=1-s/i,f=1-r/e,y.push(u),y.push(c),y.push(d),v.push(_),v.push(f),m.push(b+t*u),m.push(w+t*c),m.push(M+t*d);for(r=0;r<e;r++)for(s=0;s<i;s++)g=(p=r*(i+1)+s)+i+1,x.push(p+1),x.push(g+1),x.push(g),x.push(p+1),x.push(g),x.push(p);this.positions=m,this.normals=y,this.uv=v,this.indices=x},_props:{lod:{set:function(t){t=void 0!==t?t:1,this._lod!==t&&((t<0||t>1)&&(this.warn("clamping lod to [0..1]"),t=t<0?0:1),this._lod=t,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(t){(this._center=this._center||new xeogl.math.vec3).set(t||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(t){t=t||1,this._radius!==t&&(t<0&&(this.warn("negative radius not allowed - will invert"),t*=-1),this._radius=t,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},heightSegments:{set:function(t){t=t||18,this._heightSegments!==t&&(t<0&&(this.warn("negative heightSegments not allowed - will invert"),t*=-1),this._heightSegments=t,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},widthSegments:{set:function(t){t=t||24,this._widthSegments!==t&&(t<0&&(this.warn("negative widthSegments not allowed - will invert"),t*=-1),this._widthSegments=t,this._scheduleUpdate(),this.fire("widthSegments",this._widthSegments))},get:function(){return this._widthSegments}}},_getJSON:function(){return{center:this._center.slice(),radius:this._radius,heightSegments:this._heightSegments,widthSegments:this._widthSegments}}})}(),function(){"use strict";var t;xeogl.BoundingSphereGeometry=xeogl.SphereGeometry.extend({type:"xeogl.BoundingSphereGeometry",_init:function(t){this._super(t),t.boundary?this.boundary=t.boundary:t.sphere&&(this.sphere=t.sphere)},_props:{boundary:{set:function(t){var e=!1,i=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:t,sceneDefault:!1,on:{updated:function(){e||(e=!0,xeogl.scheduleTask(function(){i._setFromSphere(i._attached.boundary.sphere),e=!1}))}},onAttached:function(){i._setFromSphere(i._attached.boundary.sphere)}})},get:function(){return this._attached.boundary}},sphere:{set:function(t){t&&(this._attached.boundary&&(this.boundary=null),this._setFromSphere(t))}}},_setFromSphere:(t=xeogl.math.vec3(),function(e){t[0]=e[0],t[1]=e[1],t[2]=e[2],this.center=t,this.radius=e[4]})})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(t){this._super(t),this.primitive=t.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],t.boundary?this.boundary=t.boundary:t.obb?this.obb=t.obb:t.positions?this.positions=t.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(t){var e=!1,i=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:t,sceneDefault:!1,on:{updated:function(){e||(e=!0,xeogl.scheduleTask(function(){i._setPositionsFromOBB(i._attached.boundary.obb),e=!1}))}},onAttached:function(){i._setPositionsFromOBB(i._attached.boundary.obb)}})},get:function(){return this._attached.boundary}},obb:{set:function(t){t&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromOBB(t))}}},_setPositionsFromOBB:function(t){this.positions=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10],t[12],t[13],t[14],t[16],t[17],t[18],t[20],t[21],t[22],t[24],t[25],t[26],t[28],t[29],t[30]]},_getJSON:function(){var t={};return this._attached.boundary?t.boundary=this._attached.boundary.id:this.positions&&(t.positions=this.positions),t}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(t){this._super(t),this.primitive=t.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],t.boundary?this.boundary=t.boundary:t.aabb?this.aabb=t.aabb:t.positions?this.positions=t.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(t){var e=!1,i=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:t,sceneDefault:!1,on:{updated:function(){e||(e=!0,xeogl.scheduleTask(function(){i._setPositionsFromAABB(i._attached.boundary.aabb),e=!1}))}},onAttached:function(){i._setPositionsFromAABB(i._attached.boundary.aabb)}})},get:function(){return this._attached.boundary}},aabb:{set:function(t){t&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromAABB(t))}}},_setPositionsFromAABB:function(t){this.positions=[t[3],t[4],t[5],t[3],t[1],t[5],t[0],t[1],t[5],t[0],t[4],t[5],t[3],t[4],t[2],t[3],t[1],t[2],t[0],t[1],t[2],t[0],t[4],t[2]]},_getJSON:function(){var t={};return this._attached.boundary?t.boundary=this._attached.boundary.id:this.positions&&(this.positions=this.positions),t}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(t){this._super(t),this.path=t.path,this.divisions=t.divisions},_update:function(){var t=this._attached.path;if(t){var e,i,r,s=t.getPoints(this._divisions),n=[];for(e=0,i=s.length;e<i;e++)r=s[e],n.push(r[0]),n.push(r[1]),n.push(r[2]);var a=[];for(e=0,i=s.length-1;e<i;e++)a.push(e),a.push(e+1);this.primitive="lines",this.positions=n,this.indices=a,this.normals=null,this.uv=null}},_props:{path:{set:function(t){this._attach({name:"path",type:"xeogl.Curve",component:t,sceneDefault:!1,on:{curves:{callback:this._scheduleUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(t){t=t||6,this._divisions=t,this._scheduleUpdate(),this.fire("divisions",this._divisions)},get:function(){return this._divisions}}},_getJSON:function(){var t={divisions:this._divisions};return this._attached.path&&(t.path=this._attached.path.id),t}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(t){this._super(t),this.center=t.center,this.lod=t.lod,this.center=t.center,this.radiusTop=t.radiusTop,this.radiusBottom=t.radiusBottom,this.height=t.height,this.radialSegments=t.radialSegments,this.heightSegments=t.heightSegments,this.openEnded=t.openEnded},_update:function(){var t=this._center[0],e=this._center[1],i=this._center[2],r=this._radiusTop,s=this._radiusBottom,n=this._height,a=Math.floor(this._radialSegments*this._lod),o=Math.floor(this._heightSegments*this._lod);a<3&&(a=3),o<1&&(o=1);var h,l,u,c,d,_,f,p,g,m,y,v,x=this._openEnded,b=n/2,w=n/o,M=2*Math.PI/a,E=1/a,D=(r-s)/o,S=[],C=[],k=[],T=[],B=(90-180*Math.atan(n/(s-r))/Math.PI)/90;for(h=0;h<=o;h++)for(d=r-h*D,_=b-h*w,l=0;l<=a;l++)u=Math.sin(l*M),c=Math.cos(l*M),C.push(d*u),C.push(B),C.push(d*c),k.push(l*E),k.push(1-1*h/o),S.push(d*u+t),S.push(_+e),S.push(d*c+i);for(h=0;h<o;h++)for(l=0;l<=a;l++)g=(p=h*(a+1)+l)+a,T.push(p),T.push(g),T.push(g+1),T.push(p),T.push(g+1),T.push(p+1);if(!x&&r>0){for(m=S.length/3,C.push(0),C.push(1),C.push(0),k.push(.5),k.push(.5),S.push(0+t),S.push(b+e),S.push(0+i),l=0;l<=a;l++)u=Math.sin(l*M),c=Math.cos(l*M),y=.5*Math.sin(l*M)+.5,v=.5*Math.cos(l*M)+.5,C.push(r*u),C.push(1),C.push(r*c),k.push(y),k.push(v),S.push(r*u+t),S.push(b+e),S.push(r*c+i);for(l=0;l<a;l++)f=m,p=m+1+l,T.push(p),T.push(p+1),T.push(f)}if(!x&&s>0){for(m=S.length/3,C.push(0),C.push(-1),C.push(0),k.push(.5),k.push(.5),S.push(0+t),S.push(0-b+e),S.push(0+i),l=0;l<=a;l++)u=Math.sin(l*M),c=Math.cos(l*M),y=.5*Math.sin(l*M)+.5,v=.5*Math.cos(l*M)+.5,C.push(s*u),C.push(-1),C.push(s*c),k.push(y),k.push(v),S.push(s*u+t),S.push(0-b+e),S.push(s*c+i);for(l=0;l<a;l++)f=m,p=m+1+l,T.push(f),T.push(p+1),T.push(p)}this.positions=S,this.normals=C,this.uv=k,this.indices=T},_props:{lod:{set:function(t){t=void 0!==t?t:1,this._lod!==t&&((t<0||t>1)&&(this.warn("clamping lod to [0..1]"),t=t<0?0:1),this._lod=t,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(t){(this._center=this._center||new xeogl.math.vec3).set(t||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radiusTop:{set:function(t){t=void 0!==t?t:1,this._radiusTop!==t&&(t<0&&(this.warn("negative radiusTop not allowed - will invert"),t*=-1),this._radiusTop=t,this._scheduleUpdate(),this.fire("radiusTop",this._radiusTop))},get:function(){return this._radiusTop}},radiusBottom:{set:function(t){t=void 0!==t?t:1,this._radiusBottom!==t&&(t<0&&(this.warn("negative radiusBottom not allowed - will invert"),t*=-1),this._radiusBottom=t,this._scheduleUpdate(),this.fire("radiusBottom",this._radiusBottom))},get:function(){return this._radiusBottom}},height:{set:function(t){t=t||1,this._height!==t&&(t<0&&(this.warn("negative height not allowed - will invert"),t*=-1),this._height=t,this._scheduleUpdate(),this.fire("height",this._height))},get:function(){return this._height}},radialSegments:{set:function(t){t=t||60,this._radialSegments!==t&&(t<0&&(this.warn("negative radialSegments not allowed - will invert"),t*=-1),this._radialSegments=t,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},heightSegments:{set:function(t){t=t||1,this._heightSegments!==t&&(t<0&&(this.warn("negative heightSegments not allowed - will invert"),t*=-1),this._heightSegments=t,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},openEnded:{set:function(t){t=void 0!==t&&t,this._openEnded!==t&&(this._openEnded=t,this._scheduleUpdate(),this.fire("openEnded",this._openEnded))},get:function(){return this._openEnded}}},_getJSON:function(){return{center:this._center.slice(),radiusTop:this._radiusTop,radiusBottom:this._radiusBottom,height:this._height,radialSegments:this._radialSegments,heightSegments:this._heightSegments,openEnded:this._openEnded}}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(t){this._super(t),this.center=t.center,this.xSize=t.xSize,this.zSize=t.zSize,this.xSegments=t.xSegments,this.zSegments=t.zSegments,this.lod=t.lod,this.autoNormals=!1!==t.autoNormals},_update:function(){var t=this._center[0],e=this._center[1],i=this._center[2],r=this._xSize,s=this._zSize,n=Math.floor(this._lod*this._xSegments),a=Math.floor(this._lod*this._zSegments);a<1&&(a=1),a<1&&(a=1);var o,h,l,u,c,d,_,f=r/2,p=s/2,g=Math.floor(n)||1,m=Math.floor(a)||1,y=g+1,v=m+1,x=r/g,b=s/m,w=new Float32Array(y*v*3),M=new Float32Array(y*v*3),E=new Float32Array(y*v*2),D=0,S=0;for(o=0;o<v;o++){var C=o*b-p;for(h=0;h<y;h++)l=h*x-f,w[D]=l+t,w[D+1]=e,w[D+2]=-C+i,M[D+2]=-1,E[S]=(g-h)/g,E[S+1]=(m-o)/m,D+=3,S+=2}D=0;var k=new(w.length/3>65535?Uint32Arraz:Uint16Array)(g*m*6);for(o=0;o<m;o++)for(h=0;h<g;h++)u=h+y*o,c=h+y*(o+1),d=h+1+y*(o+1),_=h+1+y*o,k[D]=_,k[D+1]=c,k[D+2]=u,k[D+3]=_,k[D+4]=d,k[D+5]=c,D+=6;this.positions=w,this.normals=M,this.uv=E,this.indices=k},_props:{lod:{set:function(t){t=void 0!==t?t:1,this._lod!==t&&((t<0||t>1)&&(this.warn("clamping lod to [0..1]"),t=t<0?0:1),this._lod=t,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(t){(this._center=this._center||new xeogl.math.vec3).set(t||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(t){t=t||1,this._xSize!==t&&(t<0&&(this.warn("negative xSize not allowed - will invert"),t*=-1),this._xSize=t,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},zSize:{set:function(t){t=t||1,this._zSize!==t&&(t<0&&(this.warn("negative zSize not allowed - will invert"),t*=-1),this._zSize=t,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}},xSegments:{set:function(t){t=t||1,this._xSegments!==t&&(t<0&&(this.warn("negative xSegments not allowed - will invert"),t*=-1),this._xSegments=t,this._scheduleUpdate(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},zSegments:{set:function(t){t=t||1,this._zSegments!==t&&(t<0&&(this.warn("negative zSegments not allowed - will invert"),t*=-1),this._zSegments=t,this._scheduleUpdate(),this.fire("zSegments",this._zSegments))},get:function(){return this._zSegments}}},_getJSON:function(){return{center:this._center.slice(),xSize:this._xSize,zSize:this._zSize,xSegments:this._xSegments,zSegments:this._zSegments}}})}(),function(){"use strict";xeogl.LatheGeometry=xeogl.Geometry.extend({type:"xeogl.LatheGeometry",_init:function(t){this._super(t),this.points=t.points,this.segments=t.segments,this.phiStart=t.phiStart,this.phiLength=t.phiLength,this.lod=t.lod,this.autoNormals=!1!==t.autoNormals},_update:function(){var t=[],e=[],i=Math.floor(this._lod*this._segments);i<4&&(i=4);for(var r=this._phiStart*xeogl.math.DEGTORAD,s=this._phiLength*xeogl.math.DEGTORAD,n=this._points,a=(n.length,1/i),o=0,h=i;o<=h;o++)for(var l=r+o*a*s,u=Math.cos(l),c=Math.sin(l),d=0,_=n.length;d<_;d++){var f=n[d];t.push(u*f[0]-c*f[1]),t.push(c*f[0]+u*f[1]),t.push(f[2])}var p=n.length;for(o=0,h=i;o<h;o++)for(d=0,_=n.length-1;d<_;d++){var g=d+p*o,m=g,y=g+p,v=(u=g+1+p,g+1);e.push(v),e.push(y),e.push(m),e.push(v),e.push(u),e.push(y)}this.positions=t,this.indices=e},_props:{points:{set:function(t){this._points=t||[],this._scheduleUpdate(),this.fire("points",this._points)},get:function(){return this._points}},lod:{set:function(t){t=void 0!==t?t:1,this._lod!==t&&((t<0||t>1)&&(this.warn("clamping lod to [0..1]"),t=t<0?0:1),this._lod=t,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},phiStart:{set:function(t){t=t||0,this._phiStart!==t&&(t<0&&(this.warn("negative phiStart not allowed - will invert"),t*=-1),this._phiStart=t,this._scheduleUpdate(),this.fire("phiStart",this._phiStart))},get:function(){return this._phiStart}},phiLength:{set:function(t){t=t||1,this._phiLength!==t&&(t<0&&(this.warn("negative phiLength not allowed - will invert"),t*=-1),this._phiLength=t,this._scheduleUpdate(),this.fire("phiLength",this._phiLength))},get:function(){return this._phiLength}},segments:{set:function(t){t=Math.floor(t||4),this._segments!==t&&(t<0&&(this.warn("negative segments not allowed - will invert"),t*=-1),this._segments=t,this._scheduleUpdate(),this.fire("segments",this._segments))},get:function(){return this._segments}}},_getJSON:function(){return{points:this._points,phiStart:this._phiStart,phiLength:this._phiLength,segments:this._segments}}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(t){var e,i,r,s,n,a,o,h,l,u,c=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(t){c.enabled&&("INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.ctrlKey?c.ctrlDown=!0:t.altKey?c.altDown=!0:(c.keyDown[t.keyCode]=!0,c.fire("keydown",t.keyCode,!0))),c.mouseover&&t.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(t){c.enabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.ctrlKey?c.ctrlDown=!1:t.altKey?c.altDown=!1:(c.keyDown[t.keyCode]=!1,c.fire("keyup",t.keyCode,!0)))}),t.element.addEventListener("mouseenter",this._mouseDownListener=function(t){if(c.enabled){c.mouseover=!0;var e=c._getClickCoordsWithinElement(t);c.fire("mouseenter",e,!0)}}),t.element.addEventListener("mouseleave",this._mouseDownListener=function(t){if(c.enabled){c.mouseover=!1;var e=c._getClickCoordsWithinElement(t);c.fire("mouseleave",e,!0)}}),document.addEventListener("mousedown",this._mouseDownListener=function(t){if(c.enabled){switch(t.which){case 1:c.mouseDownLeft=!0;break;case 2:c.mouseDownMiddle=!0;break;case 3:c.mouseDownRight=!0}var e=c._getClickCoordsWithinElement(t);c.fire("mousedown",e,!0),c.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(t){if(c.enabled){switch(t.which){case 1:c.mouseDownLeft=!1;break;case 2:c.mouseDownMiddle=!1;break;case 3:c.mouseDownRight=!1}var e=c._getClickCoordsWithinElement(t);c.fire("mouseup",e,!0),c.mouseover&&t.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(t){if(c.enabled){switch(t.which){case 1:c.mouseDownLeft=!1,c.mouseDownRight=!1;break;case 2:c.mouseDownMiddle=!1;break;case 3:c.mouseDownLeft=!1,c.mouseDownRight=!1}var e=c._getClickCoordsWithinElement(t);c.fire("dblclick",e,!0),c.mouseover&&t.preventDefault()}}),document.addEventListener("mousemove",this._mouseMoveListener=function(t){if(c.enabled){var e=c._getClickCoordsWithinElement(t);c.fire("mousemove",e,!0),c.mouseover&&t.preventDefault()}}),t.element.addEventListener("wheel",this._mouseWheelListener=function(t,e){if(c.enabled){var i=Math.max(-1,Math.min(1,40*-t.deltaY));c.fire("mousewheel",i,!0),c.mouseover&&t.preventDefault()}}),c.on("mousedown",function(t){e=t[0],i=t[1]}),c.on("mouseup",function(t){e>=t[0]-2&&e<=t[0]+2&&i>=t[1]-2&&i<=t[1]+2&&c.fire("mouseclicked",t,!0)}),n={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},a=xeogl.math.vec3(),o=xeogl.math.vec3(),h={orientation:null,orientationAngle:0},l={orientationAngle:0,acceleration:null,accelerationIncludingGravity:o,rotationRate:xeogl.math.vec3(),interval:0},u={alpha:0,beta:0,gamma:0,absolute:!1},window.OrientationChangeEvent?window.addEventListener("orientationchange",c._orientationchangedListener=function(){r=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,s=r&&n[r]||0,h.orientation=r,h.orientationAngle=s,c.fire("orientationchange",h)},!1):c.warn("Browser event not supported: orientationchange"),window.DeviceMotionEvent?window.addEventListener("devicemotion",c._deviceMotionListener=function(t){l.interval=t.interval,l.orientationAngle=s;var e=t.acceleration;e?(a[0]=e.x,a[1]=e.y,a[2]=e.z,l.acceleration=a):l.acceleration=null;var i=t.accelerationIncludingGravity;i?(o[0]=i.x,o[1]=i.y,o[2]=i.z,l.accelerationIncludingGravity=o):l.accelerationIncludingGravity=null,l.rotationRate=t.rotationRate,c.fire("devicemotion",l)},!1):c.warn("Browser event not supported: devicemotion"),window.DeviceOrientationEvent?window.addEventListener("deviceorientation",c._deviceOrientListener=function(t){u.gamma=t.gamma,u.beta=t.beta,u.alpha=t.alpha,u.absolute=t.absolute,c.fire("deviceorientation",u)},!1):c.warn("Browser event not supported: deviceorientation")},_getClickCoordsWithinElement:function(t){var e=[0,0];if(t){for(var i=t.target,r=0,s=0;i.offsetParent;)r+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-r,e[1]=t.pageY-s}else t=window.event,e.x=t.x,e.y=t.y;return e},setEnabled:function(t){this.enabled!==t&&this.fire("enabled",this.enabled=t)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";xeogl.Lights=xeogl.Component.extend({type:"xeogl.Lights",_init:function(t){this._state=new xeogl.renderer.Lights({lights:[],hash:""}),this._dirty=!0,this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=t.lights},_props:{lights:{set:function(t){var e,i,r;for(t=t||[],i=0,r=this._lights.length;i<r;i++)(e=this._lights[i]).off(this._dirtySubs[i]),e.off(this._destroyedSubs[i]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var s=this;function n(){s.fire("dirty",!0)}function a(){for(var t=this.id,e=0,i=s._lights.length;e<i;e++)if(s._lights[e].id===t)return s._lights=s._lights.slice(e,e+1),s._dirtySubs=s._dirtySubs.slice(e,e+1),s._destroyedSubs=s._destroyedSubs.slice(e,e+1),s._dirty=!0,s.fire("dirty",!0),void s.fire("lights",s._lights)}for(i=0,r=t.length;i<r;i++){if(e=t[i],xeogl._isNumeric(e)||xeogl._isString(e)){var o=e;if(!(e=this.scene.components[o])){this.error("Component not found: "+xeogl._inQuotes(o));continue}}var h=e.type;"xeogl.AmbientLight"===h||"xeogl.DirLight"===h||"xeogl.PointLight"===h?(this._lights.push(e),this._dirtySubs.push(e.on("dirty",n)),this._destroyedSubs.push(e.on("destroyed",a))):this.error("Component "+xeogl._inQuotes(e.id)+" is not an xeogl.AmbientLight, xeogl.DirLight or xeogl.PointLight ")}this._dirty=!0,this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights}}},_compile:function(){var t=this._state;if(this._dirty){t.lights=[];for(var e=0,i=this._lights.length;e<i;e++)t.lights.push(this._lights[e]._state);this._makeHash(),this._dirty=!1}this._renderer.lights=t},_makeHash:function(){var t=this._state.lights;if(0===t.length)return";";for(var e,i=[],r=0,s=t.length;r<s;r++)e=t[r],i.push(e.type),i.push("world"===e.space?"w":"v");i.push(";"),this._state.hash=i.join("")},_getJSON:function(){for(var t=[],e=0,i=this._lights.length;e<i;e++)t.push(this._lights[e].id);return{lights:t}},_destroy:function(){var t,e,i;for(t=0,e=this._lights.length;t<e;t++)(i=this._lights[t]).off(this._dirtySubs[t]),i.off(this._destroyedSubs[t]);this._state.destroy()}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(t){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity},_props:{color:{set:function(t){this._state.color.set(t||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(t){this._state.intensity=void 0!==t?t:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:this._state.color,intensity:this._state.intensity}}})}(),function(){"use strict";xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(t){this._state={type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:"view"},this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.space=t.space},_props:{dir:{set:function(t){this._state.dir.set(t||[1,1,1]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(t){this._state.color.set(t||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(t){t=void 0!==t?t:1,this._state.intensity=t,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(t){this._state.space=t||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,dir:this._state.dir,color:this._state.color,intensity:this._state.intensity,space:this._state.space}}})}(),function(){"use strict";xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(t){this._state={type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view"},this.pos=t.pos,this.color=t.color,this.intensity=t.intensity,this.constantAttenuation=t.constantAttenuation,this.linearAttenuation=t.linearAttenuation,this.quadraticAttenuation=t.quadraticAttenuation,this.space=t.space},_props:{pos:{set:function(t){this._state.pos.set(t||[1,1,1]),this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(t){this._state.color.set(t||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(t){t=void 0!==t?t:1,this._state.intensity=t,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(t){this._state.attenuation[0]=t||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(t){this._state.attenuation[1]=t||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(t){this._state.attenuation[2]=t||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(t){this._state.space=t||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,pos:this._state.pos,color:this._state.color,intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";xeogl.Model=xeogl.Component.extend({type:"xeogl.Model",_init:function(t){this.components={},this.numComponents=0,this.types={},this._onDestroyed={},this._onWorldBoundaryUpdated={},this._aabbDirty=!0,this._dummyRootTransform=this.create({type:"xeogl.Transform",meta:"dummy"}),this.transform=t.transform,t.components&&this.add(t.components)},add:function(t){for(var e=0,i=(t=xeogl._isArray(t)?t:[t]).length;e<i;e++)this._add(t[e])},_add:function(t){var e,i,r;if(xeogl._isNumeric(t)||xeogl._isString(t)){if(this.scene.types[t]){if(s=t,!(r=this.scene.types[s]))return void this.warn("Component type not found: '"+s+"'");for(e in r)r.hasOwnProperty(e)&&this._add(r[e]);return}if(!(i=this.scene.components[t]))return void this.warn("Component not found: "+xeogl._inQuotes(t))}else if(xeogl._isObject(t)){var s=t.type||"xeogl.Component";if(!xeogl._isComponentType(s))return void this.error("Not a xeogl component type: "+s);i=new window[s](this.scene,t)}else{if(!t.type)return;i=t}if(i.scene===this.scene){if(!this.components[i.id]){this.components[i.id]=i,(r=this.types[i.type])||(r=this.types[i.type]={}),r[i.id]=i,this.numComponents++;var n=this;if(this._onDestroyed[i.id]=i.on("destroyed",function(){n._remove(i)}),i.isType("xeogl.Entity")){var a=i.transform;if(a){for(;a.parent;){if(a.id===n._dummyRootTransform.id)return;a=a.parent}a.id!==n._dummyRootTransform.id&&(a.parent=n._dummyRootTransform)}else i.transform=n._dummyRootTransform}i.worldBoundary&&(this._onWorldBoundaryUpdated[t.id]=i.worldBoundary.on("updated",this._updated,this),this._aabbDirty||this._setAABBDirty()),this.fire("added",i),this._dirty||this._scheduleUpdate()}}else this.warn("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(i.id))},_scheduleUpdate:function(){this._dirty||(this._dirty=!0,xeogl.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._dirty=!1},destroyAll:function(){this.iterate(function(t){t.destroy()})},removeAll:function(){},_remove:function(t){var e=t.id;if(t.scene===this.scene){delete this.components[e],t.off(this._onDestroyed[e]),delete this._onDestroyed[e];var i=this.types[t.type];i&&delete i[t.id],this.numComponents--,t.worldBoundary&&(t.worldBoundary.off(this._onWorldBoundaryUpdated[t.id]),delete this._onWorldBoundaryUpdated[t.id]),this._aabbDirty||this._setAABBDirty(),this.fire("removed",t),this._dirty||this._scheduleUpdate()}else this.warn("Attempted to remove component that's not in same xeogl.Scene: '"+e+"'")},iterate:function(t,e){e=e||this;var i=this.components;for(var r in i)i.hasOwnProperty(r)&&t.call(e,i[r])},_props:{transform:{set:function(t){this._attach({name:"transform",type:"xeogl.Transform",component:t,sceneDefault:!1,onAttached:{callback:this._transformUpdated,scope:this}})},get:function(){return this._attached.transform}},worldBoundary:{get:function(){if(!this._worldBoundary){var t=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!t._aabbDirty&&(t._buildAABB(),t._aabbDirty=!1,!0)},getAABB:function(){return t._aabb}}),this._worldBoundary.on("destroyed",function(){t._worldBoundary=null})}return this._worldBoundary}}},_transformUpdated:function(t){this._dummyRootTransform.parent=t},_updated:function(){this._aabbDirty||this._setAABBDirty()},_setAABBDirty:function(){this._aabbDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},_buildAABB:function(){this._aabb||(this._aabb=xeogl.math.AABB3());var t,e,i=1e5,r=1e5,s=1e5,n=-1e5,a=-1e5,o=-1e5,h=this.components;for(var l in h)h.hasOwnProperty(l)&&(t=h[l].worldBoundary)&&((e=t.aabb)[0]<i&&(i=e[0]),e[1]<r&&(r=e[1]),e[2]<s&&(s=e[2]),e[3]>n&&(n=e[3]),e[4]>a&&(a=e[4]),e[5]>o&&(o=e[5]));this._aabb[0]=i,this._aabb[1]=r,this._aabb[2]=s,this._aabb[3]=n,this._aabb[4]=a,this._aabb[5]=o},_destroy:function(){this.removeAll()}})}(),function(){"use strict";var t=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","scenes","animations"],e={accessors:!0,nodes:!0,meshes:!0};xeogl.glTFParser=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(t){this._rootDescription=t},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(t){var e=new RegExp("^"+window.location.protocol,"i");return!!t.match(e)}},resolvePathIfNeeded:{value:function(t){if(this._isAbsolutePath(t))return t;return/^data:/.test(t)?t:this.baseURL+t}},_resolvePathsForCategories:{value:function(t){t.forEach(function(t){var e=this.json[t];e&&Object.keys(e).forEach(function(t){var i=e[t];i.uri=this.resolvePathIfNeeded(i.uri)},this)},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(t){this._json!==t&&(this._json=t,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(t,e){var i,r=e;return(i=this.rootDescription[r])?i?i[t]:null:(console.log("ERROR:CANNOT find expected category named:"+r),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),-1!==this._state.categoryIndex&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var t=this._state.categoryState,e=t.keys;return e?(t.index++,t.keys=null,t.index>=e.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(t){return!!this.rootDescription[t]}},_handleState:{value:function(){for(var i=performance.now(),r=!0,s=t[this._state.categoryIndex],n=this.handlers[s];-1!==this._state.categoryIndex;)if(e[s])this._stepToNextCategory(),s=t[this._state.categoryIndex],n=this.handlers[s];else{var a=this._state.categoryState,o=a.keys;if(o||(s=t[this._state.categoryIndex],n=this.handlers[s],a.keys=o=Object.keys(this.rootDescription[s]),!o||0!==o.length)){var h=o[a.index],l=this.getEntryDescription(h,s);if(l){if(n&&!1===n.call(this,h,l,this._state.userInfo)){r=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),r=!1;break}}else this._stepToNextDescription()}var u=(performance.now()-i)/1e3;console.log("glTF parsed in "+u+"s"),this.handleLoadCompleted&&this.handleLoadCompleted(r)}},_loadJSONIfNeeded:{enumerable:!0,value:function(t){var e=this;if(this.json)t&&t(this.json);else{var i=this._path,r=i.lastIndexOf("/");this.baseURL=0!==r?i.substring(0,r+1):"";var s=new XMLHttpRequest;s.open("GET",i,!0),s.onreadystatechange=function(){4===s.readyState&&200===s.status&&(e.json=JSON.parse(s.responseText),t&&t(e.json))},s.send(null)}}},_buildLoader:{value:function(t){var e=this;this._loadJSONIfNeeded(function(i){e.rootDescription=i,t&&t(this)})}},_state:{value:null,writable:!0},_getEntryType:{value:function(e){for(var i=t,r=0;r<i.length;r++){if(this.rootDescription[i[r]])return i[r]}return null}},getNextCategoryIndex:{value:function(e){for(var i=e;i<t.length;i++)if(this.hasCategory(t[i]))return i;return-1}},load:{enumerable:!0,value:function(t,e){var i=this;this._buildLoader(function(r){var s=i.getNextCategoryIndex.call(i,0);-1!==s&&(i._state={userInfo:t,options:e,categoryIndex:s,categoryState:{index:"0"}},i._handleState())})}},initWithPath:{value:function(t,e){return this._idPrefix=t,this._path=e,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return void 0===this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(t,e){return this.json=t,this.baseURL=e,e||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}})}(),xeogl.GLTFLoaderUtils=Object.create(Object,{ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(t){return!!this._resources[t]}},_storeResource:{enumerable:!1,value:function(t,e){t?(this._containsResource[t]&&console.log("WARNING: resource:"+t+" is already stored, overriding"),this._resources[t]=e):console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(t){return this._resources[t]}},_loadStream:{value:function(t,e,i){function r(t,e){var i=decodeURIComponent(e);return t?atob(i):i}function s(t,e){for(var i=r(t,e),s=new ArrayBuffer(i.length),n=new Uint8Array(s),a=0;a<i.length;a++)n[a]=i.charCodeAt(a);return s}var n=/^data:(.*?)(;base64)?,(.*)$/.exec(t);if(null===n)if(e)if(t){var a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType=e===this.ARRAY_BUFFER?"arraybuffer":"text",a.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),a.onload=function(){200===a.status||206===a.status?i.streamAvailable(t,a.response):i.handleError(xeogl.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},a.send(null)}else i.handleError(xeogl.GLTFLoaderUtils.INVALID_PATH);else i.handleError(xeogl.GLTFLoaderUtils.INVALID_TYPE,null);else i.streamAvailable(t,function(t,e){e=void 0!==e?e:"";var i=t[1],n=!!t[2],a=t[3];switch(e){case"":case"text":return r(n,a);case"ArrayBuffer":return s(n,a);case"blob":var o=s(n,a);return new Blob([o],{type:i});case"document":return(new DOMParser).parseFromString(r(n,a),i);case"json":return JSON.parse(r(n,a));default:throw"Unhandled responseType: "+e}}(n,e))}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(t){this._resourcesStatus[t.id]?this._resourcesStatus[t.id]++:this._resourcesStatus[t.id]=1;var e=this._streamsStatus[t.uri];if(e&&"loading"===e.status)e.requests.push(t);else{this._streamsStatus[t.uri]={status:"loading",requests:[t]};var i=this,r={streamAvailable:function(t,e){i._streamsStatus[t].requests.forEach(function(t){var r=e.slice(t.range[0],t.range[1]),s=t.delegate.convert(r,t.ctx);i._storeResource(t.id,s),t.delegate.resourceAvailable(s,t.ctx),--i._resourcesStatus[t.id]},this),delete i._streamsStatus[t]},handleError:function(e,i){t.delegate.handleError(e,i)}};this._loadStream(t.uri,t.type,r)}}},_elementSizeForGLType:{value:function(t,e){var i=0;switch(e){case"SCALAR":i=1;break;case"VEC2":i=2;break;case"VEC3":i=3;break;case"VEC4":case"MAT2":i=4;break;case"MAT3":i=9;break;case"MAT4":i=16}switch(t){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*i;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*i;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*i;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(t,e,i){var r=t.bufferView,s=r.buffer,n=t.byteOffset+r.description.byteOffset,a=[n,this._elementSizeForGLType(t.componentType,t.type)*t.count+n];this._handleRequest({id:t.id,range:a,type:s.description.type,uri:s.description.uri,delegate:e,ctx:i},null)}},getBuffer:{value:function(t,e,i){var r=this._getResource(t.id);return r||(this._handleWrappedBufferViewResourceLoading(t,e,i),null)}},getFile:{value:function(t,e,i){return t.delegate=e,t.ctx=i,this._handleRequest({id:t.id,uri:t.uri,range:[0],type:"text",delegate:e,ctx:i},null),null}}}),function(){"use strict";function t(t,e,i){console.log(t+": "+e+": "+JSON.stringify(i,null,4))}var e=function(){this._entries={}};e.prototype.setEntry=function(t,e,i){t?(this._entries[t]&&console.warn("entry["+t+"] is being overwritten"),this._entries[t]=new function(t,e,i){this.entryID=t,this.object=e,this.description=i}(t,e,i)):console.error("No EntryID provided, cannot store",i)},e.prototype.getEntry=function(t){return this._entries[t]},e.prototype.clearEntries=function(){this._entries={}};var i=function(){};function r(t){var e=0;switch(t){case"SCALAR":e=1;break;case"VEC2":e=2;break;case"VEC3":e=3;break;case"VEC4":case"MAT2":e=4;break;case"MAT3":e=9;break;case"MAT4":e=16}return e}i.prototype.handleError=function(t,e){console.log("ERROR(IndicesDelegate):"+t+":"+e)},i.prototype.convert=function(t,e){return new Uint16Array(t,0,e.indices.count)},i.prototype.resourceAvailable=function(t,e){return e.geometry.indices=t,!0};var s=new i,n=function(t,e){this.indices=t,this.geometry=e},a=function(){};a.prototype.handleError=function(t,e){console.log("ERROR(VertexAttributeDelegate):"+t+":"+e)},a.prototype.convert=function(t,e){return t},a.prototype.resourceAvailable=function(t,e){var i=e.geometry,s=e.attribute,n=e.semantic;return"POSITION"===n?i.positions=new Float32Array(t,0,s.count*r(s.type)):"NORMAL"===n?i.normals=new Float32Array(t,0,s.count*r(s.type)):"TEXCOORD_0"!==n&&"TEXCOORD"!==n||(i.uv=new Float32Array(t,0,s.count*r(s.type))),i.loadedAttributes++,!0};var o=new a,h=function(t,e,i){this.attribute=t,this.semantic=e,this.geometry=i};xeogl.GLTFLoader=Object.create(xeogl.glTFParser,{setModel:{value:function(t){this.model=t}},load:{enumerable:!0,value:function(t,i,r){if(!this.model)throw"model not set";this.resources=new e,xeogl.glTFParser.handleLoadCompleted=r,xeogl.glTFParser.load.call(this,t,i)}},_makeID:{value:function(t){return this._idPrefix+"#"+t}},handlers:{value:{buffers:function(t,e,i){return this.resources.setEntry(t,null,e),e.type="ArrayBuffer",!0},bufferViews:function(t,e,i){this.resources.setEntry(t,null,e);var r=this.resources.getEntry(e.buffer);return e.type="ArrayBufferView",this.resources.getEntry(t).buffer=r,!0},accessors:function(t,e,i){return this.resources.setEntry(t,e,e),!0},textures:function(t,e,i){if(e.source){var r=this._json.images[e.source],s=new xeogl.Texture(this.model.scene,{id:this._makeID(t),src:r.uri,flipY:!0});return this.model.add(s),this.resources.setEntry(t,s,e),!0}},materials:function(t,e,i){var r,s=e.values||{},n=s.diffuse,a=s.specular,o=s.shininess,h=s.emission,l=s.transparency,u={id:this._makeID(t),meta:{userInfo:i},shininess:o,opacity:l,transparent:l<1};n&&(xeogl._isString(n)?(r=this.resources.getEntry(n))&&(u.diffuseMap=r.object):u.diffuse=n.slice(0,3)),a&&(xeogl._isString(a)?(r=this.resources.getEntry(a))&&(u.specularMap=r.object):u.specular=a.slice(0,3)),h&&(xeogl._isString(h)?(r=this.resources.getEntry(h))&&(u.emissiveMap=r.object):u.emissive=h.slice(0,3));var c=new xeogl.PhongMaterial(this.model.scene,u);return this.model.add(c),this.resources.setEntry(t,c,e),!0},lights:function(e,i,r){return t("light",e,i),!0},meshes:function(e,i,r){var a=[];this.resources.setEntry(e,a,i);var l=i.primitives;if(!l)return t("MISSING_PRIMITIVES for mesh:"+e),!1;for(var u=this._rootDescription.accessors,c=0;c<l.length;c++){var d=l[c];if(d.mode===WebGLRenderingContext.TRIANGLES){var _=new xeogl.Geometry(this.model.scene,{id:this._makeID(e+c)});this.model.add(_);var f=this.resources.getEntry(d.material).object;a.push({geometry:_,material:f});var p=Object.keys(d.attributes);_.totalAttributes+=p.length;var g=u[d.indices],m={bufferView:this.resources.getEntry(g.bufferView),byteOffset:g.byteOffset,count:g.count,id:d.indices,componentType:g.componentType,type:g.type},y=new n(m,_);xeogl.GLTFLoaderUtils.getBuffer(m,s,y);p.forEach(function(t){var e,i=d.attributes[t],r=(e=u[i],{bufferView:this.resources.getEntry(e.bufferView),byteOffset:e.byteOffset,byteStride:e.byteStride,count:e.count,max:e.max,min:e.min,componentType:e.componentType,type:e.type,id:i}),s=new h(r,t,_);xeogl.GLTFLoaderUtils.getBuffer(r,o,s)},this)}}return!0},cameras:function(t,e,i){return!0},scenes:function(t,e,i){var r,s,n=e.nodes;if(n)for(var a in n)n.hasOwnProperty(a)&&(r=n[a],s=null,this._parseNode(r,s))}}},_parseNode:{value:function(t,e){var i=this._json.nodes[t];if(i){var r=this.model,s=r.scene;if(i.matrix){var n=i.matrix;e=new xeogl.Transform(s,{id:this._makeID(t+".transform"),matrix:n,parent:e}),r.add(e)}if(i.translation){var a=i.translation;e=new xeogl.Translate(s,{id:this._makeID(t+".translation"),xyz:[a[0],a[1],a[2]],parent:e}),r.add(e)}if(i.rotation){var o=i.rotation;e=new xeogl.Rotate(s,{id:this._makeID(t+".rotation"),xyz:[o[0],o[1],o[2]],angle:o[3],parent:e}),r.add(e)}if(i.scale){var h=i.scale;e=new xeogl.Scale(s,{id:this._makeID(t+".scale"),xyz:[h[0],h[1],h[2]],parent:e}),r.add(e)}if(i.meshes){var l=new xeogl.Visibility(s,{id:this._makeID(t+".visibility")});r.add(l);var u=new xeogl.Cull(s,{id:this._makeID(t+".cull")});r.add(u);var c=new xeogl.Modes(s,{id:this._makeID(t+".modes")});r.add(u);var d,_,f,p,g,m,y,v,x=i.meshes,b=x.length;s.types["xeogl.Entity"];for(d=0;d<b;d++)for((_=this.resources.getEntry(x[d]))||(this.handlers.meshes.call(this,x[d],this._rootDescription.meshes[x[d]]),_=this.resources.getEntry(x[d])),f=0,p=(_=_.object).length;f<p;f++)g=_[f].material,m=_[f].geometry,y=this._makeID(t+".entity."+d+"."+f),v=new xeogl.Entity(s,{id:y,meta:{name:i.name},material:g,geometry:m,transform:e,visibility:l,cull:u,modes:c,loading:!0}),r.add(v)}if(i.children){var w,M=i.children;for(f=0,p=M.length;f<p;f++)w=M[f],this._parseNode(w,e)}return!0}}}})}(),function(){"use strict";xeogl.GLTFModel=xeogl.Model.extend({type:"xeogl.GLTFModel",_init:function(t){this._super(t),this._src=null,t.src?xeogl._isString(t.src)?this.src=t.src:this.error("Value for config 'src' should be a string"):this.error("Config missing: 'src'")},_props:{src:{set:function(t){if(t)if(xeogl._isString(t))if(t!==this._src){this.destroyAll(),this._src=t;var e=xeogl.GLTFLoader;e.setModel(this),e.initWithPath(this.id,this._src);var i=this,r=i.scene.canvas.spinner;r.processes++,e.load(null,null,function(){r.processes--,i.fire("loaded")}),this.fire("src",this._src)}else this.fire("loaded");else this.error("Value for 'src' should be a string")},get:function(){return this._src}}},_getJSON:function(){var t={};return this.src&&(t.src=this._src),t},_destroy:function(){this.destroyAll()}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){}})}(),function(){"use strict";xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(t){this._state=new xeogl.renderer.PhongMaterial({type:"phongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),opacity:1,shininess:30,reflectivity:1,lineWidth:1,pointSize:1,ambientMap:null,normalMap:null,diffuseMap:null,specularMap:null,emissiveMap:null,opacityMap:null,reflectivityMap:null,diffuseFresnel:null,specularFresnel:null,emissiveFresnel:null,opacityFresnel:null,reflectivityFresnel:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.opacity=t.opacity,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,this.ambientMap=t.ambientMap,this.diffuseMap=t.diffuseMap,this.specularMap=t.specularMap,this.emissiveMap=t.emissiveMap,this.opacityMap=t.opacityMap,this.reflectivityMap=t.reflectivityMap,this.normalMap=t.normalMap,this.diffuseFresnel=t.diffuseFresnel,this.specularFresnel=t.specularFresnel,this.emissiveFresnel=t.emissiveFresnel,this.opacityFresnel=t.opacityFresnel,this.reflectivityFresnel=t.reflectivityFresnel},_props:{ambient:{set:function(t){this._state.ambient.set(t||[1,1,1]),this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(t){this._state.diffuse.set(t||[1,1,1]),this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(t){this._state.specular.set(t||[1,1,1]),this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(t){this._state.emissive.set(t||[0,0,0]),this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},opacity:{set:function(t){t=void 0!==t&&null!==t?t:1,this._state.opacity!==t&&(this._state.opacity=t,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity))},get:function(){return this._state.opacity}},shininess:{set:function(t){this._state.shininess=void 0!==t?t:80,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},lineWidth:{set:function(t){this._state.lineWidth=t||1,this._renderer.imageDirty=!0,this.fire("lineWidth",this._state.lineWidth)},get:function(){return this._state.lineWidth}},pointSize:{set:function(t){this._state.pointSize=t||1,this._renderer.imageDirty=!0,this.fire("pointSize",this._state.pointSize)},get:function(){return this._state.pointSize}},reflectivity:{set:function(t){this._state.reflectivity=void 0!==t?t:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(t){this._attachComponent("xeogl.Texture","normalMap",t)},get:function(){return this._attached.normalMap}},ambientMap:{set:function(t){this._attachComponent("xeogl.Texture","ambientMap",t)},get:function(){return this._attached.ambientMap}},diffuseMap:{set:function(t){this._attachComponent("xeogl.Texture","diffuseMap",t)},get:function(){return this._attached.diffuseMap}},specularMap:{set:function(t){this._attachComponent("xeogl.Texture","specularMap",t)},get:function(){return this._attached.specularMap}},emissiveMap:{set:function(t){this._attachComponent("xeogl.Texture","emissiveMap",t)},get:function(){return this._attached.emissiveMap}},opacityMap:{set:function(t){this._attachComponent("xeogl.Texture","opacityMap",t)},get:function(){return this._attached.opacityMap}},reflectivityMap:{set:function(t){this._attachComponent("xeogl.Texture","reflectivityMap",t)},get:function(){return this._attached.reflectivityMap}},reflection:{set:function(t){this._attachComponent("xeogl.Reflect","reflection",t)},get:function(){return this._attached.reflection}},diffuseFresnel:{set:function(t){this._attachComponent("xeogl.Fresnel","diffuseFresnel",t)},get:function(){return this._attached.diffuseFresnel}},specularFresnel:{set:function(t){this._attachComponent("xeogl.Fresnel","specularFresnel",t)},get:function(){return this._attached.specularFresnel}},emissiveFresnel:{set:function(t){this._attachComponent("xeogl.Fresnel","emissiveFresnel",t)},get:function(){return this._attached.emissiveFresnel}},opacityFresnel:{set:function(t){this._attachComponent("xeogl.Fresnel","opacityFresnel",t)},get:function(){return this._attached.opacityFresnel}},reflectivityFresnel:{set:function(t){this._attachComponent("xeogl.Fresnel","reflectivityFresnel",t)},get:function(){return this._attached.reflectivityFresnel}}},_attachComponent:function(t,e,i){i=this._attach({name:e,type:t,component:i,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[e]=null,this._hashDirty=!0},scope:this}}}),this._state[e]=i?i._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var t=this._state,e=["/p"];t.normalMap&&(e.push("/b"),t.normalMap.matrix&&e.push("/mat")),t.ambientMap&&(e.push("/a"),t.ambientMap.matrix&&e.push("/mat")),t.diffuseMap&&(e.push("/d"),t.diffuseMap.matrix&&e.push("/mat")),t.specularMap&&(e.push("/s"),t.specularMap.matrix&&e.push("/mat")),t.emissiveMap&&(e.push("/e"),t.emissiveMap.matrix&&e.push("/mat")),t.opacityMap&&(e.push("/o"),t.opacityMap.matrix&&e.push("/mat")),t.reflectivityMap&&(e.push("/r"),t.reflectivityMap.matrix&&e.push("/mat")),t.diffuseFresnel&&e.push("/df"),t.specularFresnel&&e.push("/sf"),t.emissiveFresnel&&e.push("/ef"),t.opacityFresnel&&e.push("/of"),t.reflectivityFresnel&&e.push("/rf"),e.push(";"),t.hash=e.join("")},_getJSON:function(){var t={ambient:this._state.ambient,diffuse:this._state.diffuse,specular:this._state.specular,emissive:this._state.emissive};1!==this._state.opacity&&(t.opacity=this._state.opacity),80!==this._state.shininess&&(t.shininess=this._state.shininess),1!==this._state.reflectivity&&(t.reflectivity=this._state.reflectivity),1!==this._state.lineWidth&&(t.lineWidth=this._state.lineWidth),1!==this._state.pointSize&&(t.pointSize=this._state.pointSize);var e=this._attached;return e.normalMap&&(t.normalMap=e.normalMap.id),e.ambientMap&&(t.ambientMap=e.ambientMap.id),e.diffuseMap&&(t.diffuseMap=e.diffuseMap.id),e.specularMap&&(t.specularMap=e.specularMap.id),e.emissiveMap&&(t.emissiveMap=e.emissiveMap.id),e.opacityMap&&(t.opacityMap=e.opacityMap.id),e.reflectivityMap&&(t.reflectivityMap=e.reflectivityMap.id),e.diffuseFresnel&&(t.diffuseFresnel=e.diffuseFresnel.id),e.specularFresnel&&(t.specularFresnel=e.specularFresnel.id),e.emissiveFresnel&&(t.emissiveFresnel=e.emissiveFresnel.id),e.opacityFresnel&&(t.opacityFresnel=e.opacityFresnel.id),e.reflectivityFresnel&&(t.reflectivityFresnel=e.reflectivityFresnel.id),t},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(t){this._state=new xeogl.renderer.Texture({texture:null,matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:null,pageTableTexture:null}),this._src=null,this._image=null,this._target=null,this._pageTable=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._targetDirty=!1,this._propsDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.flipY=t.flipY,t.src?this.src=t.src:t.image?this.image=t.image:t.target&&(this.target=t.target),xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._matrixDirty=!0,this._propsDirty=!0,this._image?this._imageDirty=!0:this._src?this._srcDirty=!0:this._target&&(this._targetDirty=!0),this._scheduleUpdate()},_update:function(){var t=this.scene.canvas.gl,e=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),e.texture&&e.texture.renderBuffer&&(e.texture=null),e.texture||(e.texture=new xeogl.renderer.webgl.Texture2D(t)),e.texture.setImage(this._image,e),this._imageDirty=!1,this._propsDirty=!0),this._targetDirty&&(e.texture&&!e.texture.renderBuffer&&(e.texture.destroy(),e.texture=null),this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),this._target&&(this._onTargetActive=this._target.on("active",function(t){e.texture=t?this._state.renderBuf.getTexture():null})),this._targetDirty=!1,this._propsDirty=!0),this._matrixDirty){var i,r;0===this._translate[0]&&0===this._translate[2]||(i=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0])),1===this._scale[0]&&1===this._scale[1]||(r=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),i=i?xeogl.math.mulMat4(i,r):r),0!==this._rotate&&(r=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),i=i?xeogl.math.mulMat4(i,r):r);var s=e.matrix;e.matrix=i,this._matrixDirty=!1,!!i!=!!s&&this.fire("dirty")}this._propsDirty&&(e.texture&&e.texture.setProps&&e.texture.setProps(e),this._propsDirty=!1),this._pageTableDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),e.texture&&e.texture.renderBuffer&&(e.texture=null),e.texture||(e.texture=new xeogl.renderer.webgl.Texture2D(t)),e.texture.setImage(this._image,e),this._imageDirty=!1,this._propsDirty=!0),this._renderer.imageDirty=!0},_loadSrc:function(t){var e=this,i=new Image,r=this.scene.canvas.spinner,s=r.textures;i.onload=function(){e._src===t&&(e._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(i),e._imageDirty=!0,e._srcDirty=!1,e._targetDirty=!1,s&&r.processes--,e._scheduleUpdate(),e.fire("image",e._image),e.fire("loaded",e._src))},i.onerror=function(){s&&r.processes--},0===t.indexOf("data")?i.src=t:(i.crossOrigin="Anonymous",i.src=t,s&&r.processes++)},_props:{image:{set:function(t){this._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(t),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._targetDirty=!1,this._scheduleUpdate(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set:function(t){this._image=null,this._src=t,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}},target:{set:function(t){this._image=null,this._src=null,this._target=this._attach({name:"renderBuf",type:null,component:t,sceneDefault:!0,on:{active:{callback:this._onTargetActive,scope:this}}}),this._imageDirty=!1,this._srcDirty=!1,this._targetDirty=!0,this._scheduleUpdate(),this.fire("target",this._target)},get:function(){return this._attached.target}},pageTable:{set:function(t){this._pageTable=t,this._imageDirty=!0,this.fire("pageTable",this._pageTable)},get:function(){return this._state._pageTable}},translate:{set:function(t){this._translate.set(t||[0,0]),this._matrixDirty=!0,this._scheduleUpdate(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(t){this._scale.set(t||[1,1]),this._matrixDirty=!0,this._scheduleUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(t){t=t||0,this._rotate!==t&&(this._rotate=t,this._matrixDirty=!0,this._scheduleUpdate(),this.fire("rotate",this._rotate))},get:function(){return this._rotate}},minFilter:{set:function(t){"linear"!==(t=t||"linearMipmapLinear")&&"linearMipmapNearest"!==t&&"linearMipmapLinear"!==t&&"nearestMipmapLinear"!==t&&"linearMipmapLinear"!==t&&(this.error("Unsupported value for 'minFilter': '"+t+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),t="linearMipmapLinear"),this._state.minFilter=t,this._propsDirty=!0,this._scheduleUpdate(),this.fire("minFilter",this._state.minFilter)},get:function(){return this._state.minFilter}},magFilter:{set:function(t){"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),this._state.magFilter=t,this._propsDirty=!0,this._scheduleUpdate(),this.fire("magFilter",this._state.magFilter)},get:function(){return this._state.magFilter}},wrapS:{set:function(t){"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapS': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),this._state.wrapS=t,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapS",this._state.wrapS)},get:function(){return this._state.wrapS}},wrapT:{set:function(t){"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapT': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),this._state.wrapT=t,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapT",this._state.wrapT)},get:function(){return this._state.wrapT}},flipY:{set:function(t){t=!!t,this._state.flipY!==t&&(this._state.flipY=t,this._imageDirty=!0,this._scheduleUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}}},_getJSON:function(){var t={};return!this._translate||0===this._translate[0]&&0===this._translate[1]||(t.translate=this._translate),!this._scale||1===this._scale[0]&&1===this._scale[1]||(t.scale=this._scale),0!==this._rotate&&(t.rotate=this._rotate),"linearMipmapLinear"!==this._state.minFilter&&(t.minFilter=this._state.minFilter),"linear"!==this._state.magFilter&&(t.magFilter=this._state.magFilter),"repeat"!==this._state.wrapS&&(t.wrapS=this._state.wrapS),"repeat"!==this._state.wrapT&&(t.wrapT=this._state.wrapT),!1!==this._state.flipY&&(t.flipY=this._state.flipY),this._src?t.src=this._src:this._target?t.target=this._target.id:this._image,t},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({type:"xeogl.Fresnel",_init:function(t){this._state=new xeogl.renderer.Fresnel({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=t.edgeColor,this.centerColor=t.centerColor,this.edgeBias=t.edgeBias,this.centerBias=t.centerBias,this.power=t.power},_props:{edgeColor:{set:function(t){this._state.edgeColor.set(t||[0,0,0]),this._renderer.imageDirty=!0,this.fire("edgeColor",this._state.edgeColor)},get:function(){return this._state.edgeColor}},centerColor:{set:function(t){this._state.centerColor.set(t||[1,1,1]),this._renderer.imageDirty=!0,this.fire("centerColor",this._state.centerColor)},get:function(){return this._state.centerColor}},edgeBias:{set:function(t){this._state.edgeBias=t||0,this._renderer.imageDirty=!0,this.fire("edgeBias",this._state.edgeBias)},get:function(){return this._state.edgeBias}},centerBias:{set:function(t){this._state.centerBias=void 0!==t&&null!==t?t:1,this._renderer.imageDirty=!0,this.fire("centerBias",this._state.centerBias)},get:function(){return this._state.centerBias}},power:{set:function(t){this._state.power=void 0!==t&&null!==t?t:1,this._renderer.imageDirty=!0,this.fire("power",this._state.power)},get:function(){return this._state.power}}},_getJSON:function(){return{edgeColor:this._state.edgeColor,centerColor:this._state.centerColor,edgeBias:this._state.edgeBias,centerBias:this._state.centerBias,power:this._state.power}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Reflect=xeogl.Component.extend({type:"xeogl.Reflect",_init:function(t){this._state=new xeogl.renderer.Reflect({texture:null}),this._src=[],this._images=[],this._srcDirty=!1,this._imageDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.src=t.src,xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.reflect=null,this._images?this._imageDirty=!0:this._src&&(this._srcDirty=!0),this._scheduleUpdate()},_update:function(){var t=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);this._imageDirty&&this._images&&(t.reflect.setImage(this._image),this._imageDirty=!1,this._propsDirty=!0),this._renderer.imageDirty=!0},_loadSrc:function(t){var e=this,i=new Image;i.onload=function(){e._src===t&&(e._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(i),e._imageDirty=!0,e._srcDirty=!1,e._targetDirty=!1,e._scheduleUpdate(),e.fire("image",e._image),e.fire("loaded",e._src))},i.onerror=function(){},0===t.indexOf("data")?i.src=t:(i.crossOrigin="Anonymous",i.src=t)},_props:{src:{set:function(t){this._image=null,this._src=t,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}}},_getJSON:function(){return{src:this._src.slice(0)}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Entity=xeogl.Component.extend({type:"xeogl.Entity",_init:function(t){this._loading=t.loading,!0===this._loading&&this.scene.canvas.spinner.processes++,this.camera=t.camera,this.clips=t.clips,this.colorTarget=t.colorTarget,this.colorBuf=t.colorBuf,this.depthTarget=t.depthTarget,this.depthBuf=t.depthBuf,this.visibility=t.visibility,this.cull=t.cull,this.modes=t.modes,this.geometry=t.geometry,this.layer=t.layer,this.lights=t.lights,this.material=t.material,this.morphTargets=t.morphTargets,this.reflect=t.reflect,this.shader=t.shader,this.shaderParams=t.shaderParams,this.stage=t.stage,this.transform=t.transform,this.billboard=t.billboard,this.stationary=t.stationary,this.viewport=t.viewport,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(t){this._setViewBoundaryDirty(),this._attach({name:"camera",type:"xeogl.Camera",component:t,sceneDefault:!0,on:{viewMatrix:{callback:this._setViewBoundaryDirty,scope:this},projMatrix:{callback:this._setCanvasBoundaryDirty,scope:this}}})},get:function(){return this._attached.camera}},clips:{set:function(t){this._attach({name:"clips",type:"xeogl.Clips",component:t,sceneDefault:!0})},get:function(){return this._attached.clips}},colorTarget:{set:function(t){this._attach({name:"colorTarget",type:"xeogl.ColorTarget",component:t,sceneDefault:!0})},get:function(){return this._attached.colorTarget}},colorBuf:{set:function(t){this._attach({name:"colorBuf",type:"xeogl.ColorBuf",component:t,sceneDefault:!0})},get:function(){return this._attached.colorBuf}},depthTarget:{set:function(t){this._attach({name:"depthTarget",type:"xeogl.DepthTarget",component:t,sceneDefault:!0})},get:function(){return this._attached.depthTarget}},depthBuf:{set:function(t){this._attach({name:"depthBuf",type:"xeogl.DepthBuf",component:t,sceneDefault:!0})},get:function(){return this._attached.depthBuf}},visibility:{set:function(t){this._attach({name:"visibility",type:"xeogl.Visibility",component:t,sceneDefault:!0})},get:function(){return this._attached.visibility}},cull:{set:function(t){this._attach({name:"cull",type:"xeogl.Cull",component:t,sceneDefault:!0})},get:function(){return this._attached.cull}},modes:{set:function(t){this._attach({name:"modes",type:"xeogl.Modes",component:t,sceneDefault:!0})},get:function(){return this._attached.modes}},geometry:{set:function(t){this._setWorldBoundaryDirty(),this._attach({name:"geometry",type:"xeogl.Geometry",component:t,sceneDefault:!0,on:{positions:{callback:this._setWorldBoundaryDirty,scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.geometry}},layer:{set:function(t){this._attach({name:"layer",type:"xeogl.Layer",component:t,sceneDefault:!0})},get:function(){return this._attached.layer}},lights:{set:function(t){this._attach({name:"lights",type:"xeogl.Lights",component:t,sceneDefault:!0})},get:function(){return this._attached.lights}},material:{set:function(t){this._attach({name:"material",type:"xeogl.Material",component:t,sceneDefault:!0})},get:function(){return this._attached.material}},morphTargets:{set:function(t){this._attach({name:"morphTargets",type:"xeogl.MorphTargets",component:t,sceneDefault:!0})},get:function(){return this._attached.morphTargets}},reflect:{set:function(t){this._attach({name:"reflect",type:"xeogl.Reflect",component:t,sceneDefault:!0})},get:function(){return this._attached.reflect}},shader:{set:function(t){this._attach({name:"shader",type:"xeogl.Shader",component:t,sceneDefault:!0})},get:function(){return this._attached.shader}},shaderParams:{set:function(t){this._attach({name:"shaderParams",type:"xeogl.ShaderParams",component:t,sceneDefault:!0})},get:function(){return this._attached.shaderParams}},stage:{set:function(t){this._attach({name:"stage",type:"xeogl.Stage",component:t,sceneDefault:!0})},get:function(){return this._attached.stage}},transform:{set:function(t){this._setWorldBoundaryDirty(),this._attach({name:"transform",type:"xeogl.Transform",component:t,sceneDefault:!0,on:{updated:{callback:function(){this._transformDirty||(this._transformDirty=!0,xeogl.scheduleTask(this._transformUpdated,this))},scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.transform}},billboard:{set:function(t){this._attach({name:"billboard",type:"xeogl.Billboard",component:t,sceneDefault:!0})},get:function(){return this._attached.billboard}},viewport:{set:function(t){this._attach({name:"viewport",type:"xeogl.Viewport",component:t,sceneDefault:!0})},get:function(){return this._attached.viewport}},stationary:{set:function(t){this._attach({name:"stationary",type:"xeogl.Stationary",component:t,sceneDefault:!0})},get:function(){return this._attached.stationary}},localBoundary:{get:function(){return this._attached.geometry.localBoundary}},worldBoundary:{get:function(){if(!this._worldBoundary){var t=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!t._worldBoundaryDirty&&(t._worldBoundaryDirty=!1,!0)},getOBB:function(){var e=t._attached.geometry;if(e)return e.localBoundary.obb},getMatrix:function(){var e=t._attached.transform;return t._transformDirty&&(e._buildLeafMatrix(),t._setWorldBoundaryDirty(),t._transformDirty=!1),e.leafMatrix}}),this._worldBoundary.on("destroyed",function(){t._worldBoundary=null})}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var t=this;this._viewBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!t._viewBoundaryDirty&&(t._viewBoundaryDirty=!1,!0)},getOBB:function(){return t.worldBoundary.obb},getMatrix:function(){return t._attached.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){t._viewBoundary=null})}return this._viewBoundary}},canvasBoundary:{get:function(){if(!this._canvasBoundary){var t=this;this._canvasBoundary=this.create({type:"xeogl.Boundary2D",getDirty:function(){return!!t._canvasBoundaryDirty&&(t._canvasBoundaryDirty=!1,!0)},getOBB:function(){return t.viewBoundary.obb},getMatrix:function(){return t._attached.camera.project.matrix}}),this._canvasBoundary.on("destroyed",function(){t._canvasBoundary=null})}return this._canvasBoundary}},glsl:{get:function(){var t=this._renderer.objects[this.id];if(!t)return null;var e=t.program.program.source;return{draw:{vertex:e.vertexDraw,fragment:e.fragmentDraw},pickObject:{vertex:e.vertexPickObject,fragment:e.fragmentPickObject},pickPrimitive:{vertex:e.vertexPickPrimitive,fragment:e.fragmentPickPrimitive}}}},glslString:{get:function(){var t=this.glsl;if(t)return JSON.stringify(t,"\n",4)}}},_transformUpdated:function(){this._transformDirty&&(this._attached.transform._buildLeafMatrix(),this._setWorldBoundaryDirty(),this._transformDirty=!1)},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._setViewBoundaryDirty()},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0),this._setCanvasBoundaryDirty()},_setCanvasBoundaryDirty:function(){this._canvasBoundaryDirty=!0,this._canvasBoundary&&this._canvasBoundary.fire("updated",!0)},_valid:function(){var t=this._attached.geometry;return!this.destroyed&&t&&t.positions&&t.indices},_compile:function(){var t=this;if(!this._compiling){t._compiling=!0;var e=this._renderer.objects[this.id];e&&(e.compiled=!1);var i=function(){t._valid()?(t.__compile(),t._compiling=!1):xeogl.scheduleTask(i)};xeogl.scheduleTask(i)}},__compile:function(){var t=this._attached;t.camera._compile(),t.clips._compile(),t.colorTarget._compile(),t.colorBuf._compile(),t.depthTarget._compile(),t.depthBuf._compile(),t.visibility._compile(),t.cull._compile(),t.modes._compile(),t.geometry._compile(),t.layer._compile(),t.lights._compile(),t.material._compile(),t.reflect._compile(),t.shader._compile(),t.shaderParams._compile(),t.stage._compile(),this._renderer.modelTransform=t.transform._state,t.billboard._compile(),t.stationary._compile(),t.viewport._compile();var e=this.id,i=this._renderer.buildObject(e);this._loading&&(this.scene.canvas.spinner.processes--,this._loading=!1),i&&i.error&&this.error(i.errorLog.join("\n"))},_getJSON:function(){var t=this._attached;return{camera:t.camera.id,clips:t.clips.id,colorTarget:t.colorTarget.id,colorBuf:t.colorBuf.id,depthTarget:t.depthTarget.id,depthBuf:t.depthBuf.id,visibility:t.visibility.id,cull:t.cull.id,modes:t.modes.id,geometry:t.geometry.id,layer:t.layer.id,lights:t.lights.id,material:t.material.id,reflect:t.reflect.id,shader:t.shader.id,shaderParams:t.shaderParams.id,stage:t.stage.id,transform:t.transform.id,billboard:t.billboard.id,stationary:t.stationary.id,viewport:t.viewport.id}},_destroy:function(){this._renderer.removeObject(this.id)}})}(),function(){"use strict";xeogl.ColorBuf=xeogl.Component.extend({type:"xeogl.ColorBuf",_init:function(t){this._state=new xeogl.renderer.ColorBuf({blendEnabled:!1,colorMask:[!0,!0,!0,!0]}),this.blendEnabled=t.blendEnabled,this.colorMask=t.colorMask},_props:{blendEnabled:{set:function(t){this._state.blendEnabled=!0===t,this._renderer.imageDirty=!0,this.fire("blendEnabled",this._state.blendEnabled)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(t){this._state.colorMask=t||[!0,!0,!0,!0],this._renderer.imageDirty=!0,this.fire("colorMask",this._state.colorMask)},get:function(){return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this._state.blendEnabled,colorMask:this._state.colorMask}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.DepthBuf=xeogl.Component.extend({type:"xeogl.DepthBuf",_init:function(t){this._state=new xeogl.renderer.DepthBuf({clearDepth:null,depthFunc:null,active:!0}),this.clearDepth=t.clearDepth,this.depthFunc=t.depthFunc,this.active=t.active},_props:{clearDepth:{set:function(t){this._state.clearDepth=void 0!==t?t:1,this._renderer.imageDirty=!0,this.fire("clearDepth",this._state.clearDepth)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(t){t=t||"less";var e=this._depthFuncNames[t];void 0===e&&(this.error("Unsupported value for 'clearFunc': '"+t+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal. Defaulting to 'less'."),e="less"),this._state.depthFunc=this.scene.canvas.gl[e],this._state.depthFuncName=t,this._renderer.imageDirty=!0,this.fire("depthFunc",this._state.depthFuncName)},get:function(){return this._state.depthFuncName}},active:{set:function(t){t=!1!==t,this._state.active!==t&&(this._state.active=t,this._renderer.imageDirty=!0,this.fire("active",this._state.active))},get:function(){return this._state.active}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this._state.clearDepth,depthFunc:this._state.depthFuncName,active:this._state.active}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Layer=xeogl.Component.extend({type:"xeogl.Layer",_init:function(t){this._state=new xeogl.renderer.Layer({priority:null}),this.priority=t.priority},_props:{priority:{set:function(t){t=t||0,(t=Math.round(t))!==this._state.priority&&(this._state.priority=t,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this._state.priority}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.ColorTarget=xeogl.Component.extend({type:"xeogl.ColorTarget",_init:function(t){this._state=new xeogl.renderer.RenderTarget({type:xeogl.renderer.RenderTarget.COLOR,renderBuf:null});var e=this.scene.canvas,i=this;this._webglContextRestored=e.on("webglContextRestored",function(){i._state.renderBuf&&i._state.renderBuf.webglRestored(e.gl)}),this.size=t.size,this.active=t.active},_props:{size:{set:function(t){t=t||null,this._size=t,this._active&&this._state.renderBuf.setSize(this._size),this.fire("size",this._size)},get:function(){return this._size}},active:{set:function(t){if(t=!1!==t,this._active!==t){var e=this._state;if(this._active=t,this._active){var i=this.scene.canvas;e.renderBuf=new xeogl.renderer.webgl.RenderBuffer({canvas:i.canvas,gl:i.gl,size:this._size}),this._renderer.imageDirty=!0}else e.renderBuf&&(e.renderBuf.destroy(),e.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.colorTarget=this._state},_getJSON:function(){var t={active:this._active};return this._size&&(t.size=this._size),t},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf&&this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";xeogl.DepthTarget=xeogl.Component.extend({type:"xeogl.DepthTarget",_init:function(t){this._state=new xeogl.renderer.RenderTarget({type:xeogl.renderer.RenderTarget.DEPTH,renderBuf:null});var e=this.scene.canvas,i=this;this._webglContextRestored=e.on("webglContextRestored",function(){i._state.renderBuf&&i._state.renderBuf.webglRestored(e.gl)}),this.active=t.active},_props:{active:{set:function(t){if(t=!1!==t,this._active!==t){this._active=t;var e=this._state;if(this._active){var i=this.scene.canvas;e.renderBuf=new xeogl.renderer.webgl.RenderBuffer({canvas:i.canvas,gl:i.gl}),this._renderer.imageDirty=!0}else e.renderBuf&&(e.renderBuf.destroy(),e.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.depthTarget=this._state},_getJSON:function(){return{active:this._active}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf&&this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";xeogl.Modes=xeogl.Component.extend({type:"xeogl.Modes",_init:function(t){this._state=new xeogl.renderer.Modes({pickable:null,clippable:null,transparent:null,backfaces:null,frontface:null,collidable:null}),this.pickable=t.pickable,this.clippable=t.clippable,this.transparent=t.transparent,this.backfaces=t.backfaces,this.frontface=t.frontface,this.collidable=t.collidable},_props:{pickable:{set:function(t){t=!1!==t,this._state.pickable!==t&&(this._state.pickable=t,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}},clippable:{set:function(t){t=!1!==t,this._state.clippable!==t&&(this._state.clippable=t,this._renderer.imageDirty=!0,this.fire("clippable",this._state.clippable))},get:function(){return this._state.clippable}},transparent:{set:function(t){t=!!t,this._state.transparent!==t&&(this._state.transparent=t,this._renderer.stateOrderDirty=!0,this.fire("transparent",this._state.transparent))},get:function(){return this._state.transparent}},backfaces:{set:function(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}},collidable:{set:function(t){(t=!1!==t)!==this._state.collidable&&(this._state.collidable=t,this.fire("collidable",this._state.collidable))},get:function(){return this._state.collidable}}},_compile:function(){this._renderer.modes=this._state},_getJSON:function(){return{pickable:this._state.pickable,clippable:this._state.clippable,transparent:this._state.transparent,backfaces:this._state.backfaces,frontface:this._state.frontface,collidable:this._state.collidable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(t){this._state=new xeogl.renderer.Viewport({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary},_props:{boundary:{set:function(t){if(!this._autoBoundary){if(!t){var e=this.scene.canvas.boundary;t=[0,0,e[2],e[3]]}this._state.boundary=t,this._renderer.imageDirty=!0,this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(t){(t=!!t)!==this._autoBoundary&&(this._autoBoundary=t,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(t){var e=t[2],i=t[3];this._state.boundary=[0,0,e,i],this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_compile:function(){this._renderer.viewport=this._state},_getJSON:function(){var t={};return this._autoBoundary?t.autoBoundary=!0:t.boundary=this._state.boundary.slice(),t}})}(),function(){"use strict";xeogl.Stage=xeogl.Component.extend({type:"xeogl.Stage",_init:function(t){this._state=new xeogl.renderer.Stage({priority:null,pickable:!0}),this.priority=t.priority,this.pickable=t.pickable},_props:{priority:{set:function(t){(t=t||0)!==this._state.priority&&(t=Math.round(t),this._state.priority=t,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}},pickable:{set:function(t){t=!1!==t,this._state.pickable!==t&&(this._state.pickable=t,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Shader=xeogl.Component.extend({type:"xeogl.Shader",_init:function(t){this._state=new xeogl.renderer.Shader({vertex:null,fragment:null,params:{}}),this.vertex=t.vertex,this.fragment=t.fragment,this.setParams(t.params)},_props:{vertex:{set:function(t){this._state.vertex=t,this.fire("dirty",!0),this.fire("vertex",this._state.vertex)},get:function(){return this._state.vertex}},fragment:{set:function(t){this._state.fragment=t,this.fire("dirty",!0),this.fire("fragment",this._state.fragment)},get:function(){return this._state.fragment}},params:{get:function(){return this._state.params}}},setParams:function(t){for(var e in t)t.hasOwnProperty(e)&&(this._state.params[e]=t[e]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){var t={params:this._state.params};return this._state.vertex&&(t.vertex=this._state.vertex),this._state.fragment&&(t.fragment=this._state.fragment),t}})}(),function(){"use strict";xeogl.ShaderParams=xeogl.Component.extend({type:"xeogl.ShaderParams",_init:function(t){this._state=new xeogl.renderer.ShaderParams({params:{}}),this.setParams(t.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(t){for(var e in t)t.hasOwnProperty(e)&&(this._state.params[e]=t[e]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shaderParams=this._state},_getJSON:function(){return{params:this._state.params}}})}(),function(){"use strict";xeogl.Boundary2D=xeogl.Component.extend({type:"xeogl.Boundary2D",_init:function(t){this._obb=null,this._aabb=t.aabb||null,this._center=t.center||null,this._getDirty=t.getDirty,this._getOBB=t.getOBB,this._getMatrix=t.getMatrix},_props:{aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}}},_buildBoundary:function(){var t=xeogl.math,e=this.scene.canvas.canvas,i=e.width,r=e.height;this._obb||(this._obb=t.OBB2(),this._aabb=t.AABB2(),this._center=t.vec2());var s=this._getOBB(),n=this._getMatrix();s&&n&&(t.transformOBB3(n,s,this._obb),t.OBB3ToAABB2(this._obb,this._aabb),t.AABB2ToCanvas(this._aabb,i,r),t.getAABB2Center(this._aabb,this._center))},_getJSON:function(){return{aabb:this.aabb,center:this.center}}})}(),function(){"use strict";xeogl.Boundary3D=xeogl.Component.extend({type:"xeogl.Boundary3D",_init:function(t){this._obb=t.obb||null,this._aabb=t.aabb||null,this._sphere=t.sphere||null,this._center=t.center||null,this._getDirty=t.getDirty,this._getOBB=t.getOBB,this._getAABB=t.getAABB,this._getMatrix=t.getMatrix,this._getPositions=t.getPositions},_props:{obb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}},sphere:{get:function(){return this._getDirty()&&this._buildBoundary(),this._sphere}}},_buildBoundary:function(){var t=xeogl.math;this._obb||(this._obb=xeogl.math.OBB3()),this._aabb||(this._aabb=xeogl.math.AABB3()),this._sphere||(this._sphere=xeogl.math.vec4()),this._center||(this._center=xeogl.math.vec3());var e=this._getAABB?this._getAABB():null;if(e)return this._aabb[0]=e[0],this._aabb[1]=e[1],this._aabb[2]=e[2],this._aabb[3]=e[3],this._aabb[4]=e[4],this._aabb[5]=e[5],t.AABB3ToOBB3(this._aabb,this._obb),t.OBB3ToSphere3(this._obb,this._sphere),void t.getSphere3Center(this._sphere,this._center);var i,r=this._getPositions?this._getPositions():null;if(r)return(i=this._getMatrix?this._getMatrix():null)?(t.positions3ToAABB3(r,this._aabb),t.AABB3ToOBB3(this._aabb,this._obb),t.transformOBB3(i,this._obb),t.OBB3ToAABB3(this._obb,this._aabb),t.OBB3ToSphere3(this._obb,this._sphere),void t.getSphere3Center(this._sphere,this._center)):(t.positions3ToAABB3(r,this._aabb),t.AABB3ToOBB3(this._aabb,this._obb),t.OBB3ToSphere3(this._obb,this._sphere),void t.getSphere3Center(this._sphere,this._center));var s=this._getOBB?this._getOBB():null;if(s){if(i=this._getMatrix?this._getMatrix():null)return t.transformOBB3(i,s,this._obb),t.OBB3ToAABB3(this._obb,this._aabb),t.OBB3ToSphere3(this._obb,this._sphere),void t.getSphere3Center(this._sphere,this._center);for(var n=0,a=s.length;n<a;n++)this._obb[n]=s[n];t.OBB3ToAABB3(this._obb,this._aabb),t.OBB3ToSphere3(this._obb,this._sphere),t.getSphere3Center(this._sphere,this._center)}},_getJSON:function(){return{obb:this.obb,aabb:this.aabb,center:this.center,sphere:this.sphere}}})}(),function(){"use strict";xeogl.Transform=xeogl.Component.extend({type:"xeogl.Transform",_init:function(t){this._onParentUpdated=null,this._onParentDestroyed=null,this._matrix=xeogl.math.identityMat4(xeogl.math.mat4()),this._leafMatrix=xeogl.math.mat4(),this._leafNormalMatrix=xeogl.math.mat4(),this._leafMatrixDirty=!0,this._leafNormalMatrixDirty=!0;var e=this;this._state=new xeogl.renderer.Transform({getMatrix:function(){return e._leafMatrixDirty&&e._buildLeafMatrix(),e._leafMatrix},getNormalMatrix:function(){return e._leafNormalMatrixDirty&&e._buildLeafNormalMatrix(),e._leafNormalMatrix}}),this.parent=t.parent,this.matrix=t.matrix,this.postMultiply=t.postMultiply},_parentUpdated:function(){this._leafMatrixDirty=!0,this.fire("updated",!0)},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._build&&this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._parent)this._postMultiply?xeogl.math.mulMat4(this._parent.leafMatrix,this._matrix,this._leafMatrix):xeogl.math.mulMat4(this._matrix,this._parent.leafMatrix,this._leafMatrix);else for(var t=0,e=this._matrix.length;t<e;t++)this._leafMatrix[t]=this._matrix[t];this._renderer.imageDirty=!0,this._leafMatrixDirty=!1,this._leafNormalMatrixDirty=!0}},_buildLeafNormalMatrix:function(){this._leafMatrixDirty&&this._buildLeafMatrix(),xeogl.math.inverseMat4(this._leafMatrix,this._leafNormalMatrix),xeogl.math.transposeMat4(this._leafNormalMatrix),this._renderer.imageDirty=!0,this._leafNormalMatrixDirty=!1},_props:{parent:{set:function(t){if(t)for(var e=this.id,i=t;i;i=i._parent)if(e===i.id)return void this.error("Not allowed to attach Transform as parent of itself - ignoring");!this._parent||t&&t.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=t,this.fire("parent",this._parent),this._parent&&(this._onParentUpdated=this._parent.on("updated",this._parentUpdated,this),this._onParentDestroyed=this._parent.on("destroyed",this._parentUpdated,this)),this._parentUpdated()},get:function(){return this._parent}},postMultiply:{set:function(t){t=!1!==t,this._postMultiply!==t&&(this._postMultiply=t,this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("updated",!0),this.fire("postMultiply",this._postMultiply))},get:function(){return this._postMultiply}},matrix:{set:function(t){this._matrix.set(t||xeogl.math.identityMat4()),this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._leafMatrix}}},_getJSON:function(){var t={matrix:Array.prototype.slice.call(this._matrix),postMultiply:this._postMultiply};return this._parent&&(t.parent=this._parent.id),t},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed))}})}(),function(){"use strict";xeogl.Rotate=xeogl.Transform.extend({type:"xeogl.Rotate",_init:function(t){this._super(t),this.xyz=t.xyz,this.angle=t.angle},_update:function(){this.matrix=xeogl.math.rotationMat4v(this._angle*xeogl.math.DEGTORAD,this._xyz,this._matrix)},_props:{xyz:{set:function(t){(this._xyz=this._xyz||new xeogl.math.vec3).set(t||[0,1,0]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}},angle:{set:function(t){this._angle=t||0,this._scheduleUpdate(),this.fire("angle",this._angle)},get:function(){return this._angle}}},_getJSON:function(){var t={xyz:this._xyz,angle:this._angle};return this._parent&&(t.parent=this._parent.id),t}})}(),function(){"use strict";var t,e,i;xeogl.Quaternion=xeogl.Transform.extend({type:"xeogl.Quaternion",_init:function(t){this._super(t),this.xyzw=t.xyzw},_props:{xyzw:{set:function(t){var e=xeogl.math;(this._xyzw=this._xyzw||new e.vec4).set(t||e.identityQuaternion()),this.matrix=e.quaternionToMat4(this._xyzw,this._matrix||(this._matrix=xeogl.math.identityMat4())),this.fire("xyzw",this._xyzw)},get:function(){return this._xyzw}}},rotate:(t=xeogl.math,e=t.vec4(),i=t.vec4(),function(r){e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3]*t.DEGTORAD,t.angleAxisToQuaternion(e,i),this.xyzw=t.mulQuaternions(this._xyzw,i,this._xyzw)}),_getJSON:function(){var t={xyzw:this._xyzw};return this._parent&&(t.parent=this._parent.id),t}})}(),function(){"use strict";xeogl.Scale=xeogl.Transform.extend({type:"xeogl.Scale",_init:function(t){this._super(t),this.xyz=t.xyz},_update:function(){this.matrix=xeogl.math.scalingMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(t){(this._xyz=this._xyz||new xeogl.math.vec3).set(t||[1,1,1]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var t={xyz:this._xyz};return this._parent&&(t.parent=this._parent.id),t}})}(),function(){"use strict";xeogl.Translate=xeogl.Transform.extend({type:"xeogl.Translate",_init:function(t){this._super(t),this.xyz=t.xyz},_update:function(){this.matrix=xeogl.math.translationMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(t){(this._xyz=this._xyz||new xeogl.math.vec3).set(t||[0,0,0]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var t={xyz:this._xyz};return this._parent&&(t.parent=this._parent.id),t}})}(),function(){"use strict";xeogl.Billboard=xeogl.Component.extend({type:"xeogl.Billboard",_init:function(t){this._super(t),this._state=new xeogl.renderer.Billboard({active:!0,spherical:!0,hash:"a;s;"}),this.active=!1!==t.active,this.spherical=!1!==t.spherical},_props:{active:{set:function(t){t=!!t,this._state.active!==t&&(this._state.active=t,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}},spherical:{set:function(t){t=!!t,this._state.spherical!==t&&(this._state.spherical=t,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("spherical",this._state.spherical))},get:function(){return this._state.spherical}}},_compile:function(){this._renderer.billboard=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";xeogl.Stationary=xeogl.Component.extend({type:"xeogl.Stationary",_init:function(t){this._super(t),this._state=new xeogl.renderer.Stationary({active:!0}),this.active=!1!==t.active},_props:{active:{set:function(t){t=!!t,this._state.active!==t&&(this._state.active=t,this._state.hash=this._state.active?"a;":";",this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}}},_compile:function(){this._renderer.stationary=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";xeogl.Frustum=xeogl.Transform.extend({type:"xeogl.Frustum",_init:function(t){this._super(t),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far},_update:function(){this.matrix=xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._matrix)},_props:{left:{set:function(t){this._left=void 0!==t&&null!==t?t:-1,this._scheduleUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(t){this._right=void 0!==t&&null!==t?t:1,this._scheduleUpdate(0),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(t){this._top=void 0!==t&&null!==t?t:1,this._scheduleUpdate(0),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(t){this._bottom=void 0!==t&&null!==t?t:-1,this._scheduleUpdate(0),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(t){this._near=void 0!==t&&null!==t?t:.1,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(t){this._far=void 0!==t&&null!==t?t:1e4,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var t={left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far};return this._parent&&(t.parent=this._parent.id),t}})}(),function(){"use strict";var t,e=xeogl.math,i=e.vec3(),r=e.vec3(),s=e.vec3(),n=e.vec3(),a=e.vec3(),o=e.vec3();xeogl.Lookat=xeogl.Transform.extend({type:"xeogl.Lookat",_init:function(t){this._super(t),this._eye=e.vec3([0,0,10]),this._look=e.vec3([0,0,0]),this._up=e.vec3([0,1,0]),this.eye=t.eye,this.look=t.look,this.up=t.up,this.gimbalLockY=t.gimbalLockY},_update:(t=e.mat4(),function(){e.lookAtMat4v(this._eye,this._look,this._up,t),this.matrix=t}),rotateEyeY:function(t){var a=e.subVec3(this._eye,this._look,i),o=e.rotationMat4v(.0174532925*t,this._gimbalLockY?e.vec3([0,1,0]):this._up);a=e.transformPoint3(o,a,r),this.eye=e.addVec3(a,this._look,s),this._gimbalLockY&&(this.up=e.transformPoint3(o,this._up,n))},rotateEyeX:function(t){var h=e.subVec3(this._eye,this._look,i),l=e.cross3Vec3(e.normalizeVec3(h,r),e.normalizeVec3(this._up,s)),u=e.rotationMat4v(.0174532925*t,l);h=e.transformPoint3(u,h,n),this.eye=e.addVec3(h,this._look,a),this.up=e.transformPoint3(u,this._up,o)},rotateLookY:function(t){var n=e.subVec3(this._look,this._eye,i),a=e.rotationMat4v(.0174532925*t,this._up);n=e.transformPoint3(a,n,r),this.look=e.addVec3(n,this._eye,s)},rotateLookX:function(t){var o=e.subVec3(this._look,this._eye,i),h=e.cross3Vec3(e.normalizeVec3(o,r),e.normalizeVec3(this._up,s)),l=e.rotationMat4v(.0174532925*t,h);o=e.transformPoint3(l,o,n),this.look=e.addVec3(o,this._eye,a),this.up=e.transformPoint3(l,this._up,tempVecf)},pan:function(t){var h,l=e.subVec3(this._eye,this._look,i),u=[0,0,0];if(0!==t[0]){var c=e.cross3Vec3(e.normalizeVec3(l,[]),e.normalizeVec3(this._up,r));h=e.mulVec3Scalar(c,t[0]),u[0]+=h[0],u[1]+=h[1],u[2]+=h[2]}0!==t[1]&&(h=e.mulVec3Scalar(e.normalizeVec3(this._up,s),t[1]),u[0]+=h[0],u[1]+=h[1],u[2]+=h[2]),0!==t[2]&&(h=e.mulVec3Scalar(e.normalizeVec3(l,n),t[2]),u[0]+=h[0],u[1]+=h[1],u[2]+=h[2]),this.eye=e.addVec3(this._eye,u,a),this.look=e.addVec3(this._look,u,o)},zoom:function(t){var a=e.subVec3(this._eye,this._look,i),o=Math.abs(e.lenVec3(a,r)),h=Math.abs(o+t),l=e.normalizeVec3(a,s);this.eye=e.addVec3(this._look,e.mulVec3Scalar(l,h),n)},_props:{gimbalLockY:{set:function(t){t=!1!==t,this._gimbalLockY=t,this.fire("gimbalLockY",this._gimbalLockY)},get:function(){return this._gimbalLockY}},eye:{set:function(t){this._eye.set(t||[0,0,10]),this._scheduleUpdate(0),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(t){this._look.set(t||[0,0,0]),this._scheduleUpdate(0),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(t){this._up.set(t||[0,1,0]),this._scheduleUpdate(0),this.fire("up",this._up)},get:function(){return this._up}}},_getJSON:function(){var t={eye:this._eye.slice(),look:this._look.slice(),up:this._up.slice(),gimbalLockY:this._gimbalLockY};return this._parent&&(t.parent=this._parent.id),t}})}(),function(){"use strict";xeogl.Ortho=xeogl.Transform.extend({type:"xeogl.Ortho",_init:function(t){this._super(t),this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._scheduleUpdate,this)},_update:function(){var t,e,i,r,s=this.scene,n=this._scale,a=s.canvas.canvas,o=a.clientWidth,h=a.clientHeight,l=.5*n,u=o/h;o>h?(t=-l,e=l,i=l/u,r=-l/u):(t=-l*u,e=l*u,i=l,r=-l),this.matrix=xeogl.math.orthoMat4c(t,e,r,i,this._near,this._far,this.__tempMat||(this.__tempMat=xeogl.math.mat4()))},_props:{scale:{set:function(t){this._scale=void 0!==t&&null!==t?t:1,this._scheduleUpdate(0),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(t){this._near=void 0!==t&&null!==t?t:.1,this._scheduleUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(t){this._far=void 0!==t&&null!==t?t:1e4,this._scheduleUpdate(),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var t={scale:this._scale,near:this._near,far:this._far};return this._parent&&(t.parent=this._parent.id),t},_destroy:function(){this._super(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Transform.extend({type:"xeogl.Perspective",_init:function(t){this._super(t),this._dirty=!1,this._fovy=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._scheduleUpdate,this),this.fovy=t.fovy,this.near=t.near,this.far=t.far},_update:function(){var t=this.scene.canvas.canvas,e=t.clientWidth/t.clientHeight;this.matrix=xeogl.math.perspectiveMat4(this._fovy*(Math.PI/180),e,this._near,this._far,this._matrix)},_props:{fovy:{set:function(t){this._fovy=void 0!==t&&null!==t?t:60,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("fovy",this._fovy)},get:function(){return this._fovy}},near:{set:function(t){this._near=void 0!==t&&null!==t?t:.1,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(t){this._far=void 0!==t&&null!==t?t:1e4,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var t={fovy:this._fovy,near:this._near,far:this._far};return this._parent&&(t.parent=this._parent.id),t},_destroy:function(){this._super(),this.scene.canvas.off(this._canvasResized)}})}(),xeogl.version="1.0.0";